<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Sentinel &mdash; huangz/note</title>
    
    <link rel="stylesheet" href="../../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'present',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="huangz/note" href="../../index.html" />
    <link rel="up" title="Redis 源码分析" href="index.html" />
    <link rel="next" title="集群（cluster）" href="cluster.html" />
    <link rel="prev" title="复制（replication）" href="replication.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->





</head>
<body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="cluster.html" title="集群（cluster）"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="replication.html" title="复制（replication）"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">huangz/note</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Redis 源码分析</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="sentinel">
<h1>Sentinel<a class="headerlink" href="#sentinel" title="Permalink to this headline">¶</a></h1>
<p>以下是 Redis 2.8 新版 Sentinel 的注释代码，
源文件在<a class="reference external" href="https://github.com/huangz1990/blog/tree/master/storage/redis_code_analysis/sentinel">这里</a>：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cm">/* Redis Sentinel implementation</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *   * Redistributions of source code must retain the above copyright notice,</span>
<span class="cm"> *     this list of conditions and the following disclaimer.</span>
<span class="cm"> *   * Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *     documentation and/or other materials provided with the distribution.</span>
<span class="cm"> *   * Neither the name of Redis nor the names of its contributors may be used</span>
<span class="cm"> *     to endorse or promote products derived from this software without</span>
<span class="cm"> *     specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="cm"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<span class="cm"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="cm"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="cm"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm"> * POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;redis.h&quot;</span>
<span class="cp">#include &quot;hiredis.h&quot;</span>
<span class="cp">#include &quot;async.h&quot;</span>

<span class="cp">#include &lt;ctype.h&gt;</span>
<span class="cp">#include &lt;arpa/inet.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;sys/wait.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>

<span class="k">extern</span> <span class="kt">char</span> <span class="o">**</span><span class="n">environ</span><span class="p">;</span>

<span class="c1">// sentinel 的默认端口号</span>
<span class="cp">#define REDIS_SENTINEL_PORT 26379</span>

<span class="cm">/* ======================== Sentinel global state =========================== */</span>

<span class="cm">/* Address object, used to describe an ip:port pair. */</span>
<span class="cm">/* 地址对象，用于保存 IP 地址和端口 */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">sentinelAddr</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sentinelAddr</span><span class="p">;</span>

<span class="cm">/* A Sentinel Redis Instance object is monitoring. */</span>
<span class="cm">/* 每个被监视的 Redis 实例都会创建一个 sentinelRedisInstance 结构</span>
<span class="cm"> * 而每个结构的 flags 值会是以下常量的一个或多个的并 */</span>
<span class="c1">// 实例是一个主服务器</span>
<span class="cp">#define SRI_MASTER  (1&lt;&lt;0)</span>
<span class="c1">// 实例是一个从服务器</span>
<span class="cp">#define SRI_SLAVE   (1&lt;&lt;1)</span>
<span class="c1">// 实例是一个 Sentinel</span>
<span class="cp">#define SRI_SENTINEL (1&lt;&lt;2)</span>
<span class="c1">// 实例已断线</span>
<span class="cp">#define SRI_DISCONNECTED (1&lt;&lt;3)</span>
<span class="c1">// 实例已处于 SDOWN 状态</span>
<span class="cp">#define SRI_S_DOWN (1&lt;&lt;4)   </span><span class="cm">/* Subjectively down (no quorum). */</span><span class="cp"></span>
<span class="c1">// 实例已处于 ODOWN 状态</span>
<span class="cp">#define SRI_O_DOWN (1&lt;&lt;5)   </span><span class="cm">/* Objectively down (confirmed by others). */</span><span class="cp"></span>
<span class="c1">// Sentinel 认为主服务器已下线</span>
<span class="cp">#define SRI_MASTER_DOWN (1&lt;&lt;6) </span><span class="cm">/* A Sentinel with this flag set thinks that</span>
<span class="cm">                                   its master is down. */</span><span class="cp"></span>
<span class="c1">// 正在对主服务器进行故障迁移</span>
<span class="cp">#define SRI_FAILOVER_IN_PROGRESS (1&lt;&lt;7) </span><span class="cm">/* Failover is in progress for</span>
<span class="cm">                                           this master. */</span><span class="cp"></span>
<span class="c1">// 实例是被选中的新主服务器（目前仍是从服务器）</span>
<span class="cp">#define SRI_PROMOTED (1&lt;&lt;8)            </span><span class="cm">/* Slave selected for promotion. */</span><span class="cp"></span>
<span class="c1">// 向从服务器发送 SLAVEOF 命令，让它们转向复制新主服务器</span>
<span class="cp">#define SRI_RECONF_SENT (1&lt;&lt;9)     </span><span class="cm">/* SLAVEOF &lt;newmaster&gt; sent. */</span><span class="cp"></span>
<span class="c1">// 从服务器正在与新主服务器进行同步</span>
<span class="cp">#define SRI_RECONF_INPROG (1&lt;&lt;10)   </span><span class="cm">/* Slave synchronization in progress. */</span><span class="cp"></span>
<span class="c1">// 从服务器与新主服务器同步完毕，开始复制新主服务器</span>
<span class="cp">#define SRI_RECONF_DONE (1&lt;&lt;11)     </span><span class="cm">/* Slave synchronized with new master. */</span><span class="cp"></span>
<span class="c1">// 对主服务器强制执行故障迁移操作</span>
<span class="cp">#define SRI_FORCE_FAILOVER (1&lt;&lt;12)  </span><span class="cm">/* Force failover with master up. */</span><span class="cp"></span>
<span class="c1">// 已经对返回 -BUSY 的服务器发送 SCRIPT KILL 命令</span>
<span class="cp">#define SRI_SCRIPT_KILL_SENT (1&lt;&lt;13) </span><span class="cm">/* SCRIPT KILL already sent on -BUSY */</span><span class="cp"></span>

<span class="cm">/* Note: times are in milliseconds. */</span>
<span class="cm">/* 各种时间常量，以毫秒为单位 */</span>
<span class="c1">// 发送 INFO 命令的间隔</span>
<span class="cp">#define SENTINEL_INFO_PERIOD 10000</span>
<span class="c1">// 发送 PING 命令的间隔</span>
<span class="cp">#define SENTINEL_PING_PERIOD 1000</span>
<span class="c1">// 发送 ASK 命令的间隔</span>
<span class="cp">#define SENTINEL_ASK_PERIOD 1000</span>
<span class="c1">// 发送 PUBLISH 命令的间隔</span>
<span class="cp">#define SENTINEL_PUBLISH_PERIOD 2000</span>
<span class="c1">// 默认的判断服务器已下线的时长</span>
<span class="cp">#define SENTINEL_DEFAULT_DOWN_AFTER 30000</span>
<span class="c1">// 默认的信息频道</span>
<span class="cp">#define SENTINEL_HELLO_CHANNEL &quot;__sentinel__:hello&quot;</span>
<span class="c1">// 默认的 TILT 触发时长</span>
<span class="cp">#define SENTINEL_TILT_TRIGGER 2000</span>
<span class="c1">// 默认的 TILT 环境时长（要多久才能退出 TITL 模式）</span>
<span class="cp">#define SENTINEL_TILT_PERIOD (SENTINEL_PING_PERIOD*30)</span>
<span class="c1">// 默认从服务器优先级</span>
<span class="cp">#define SENTINEL_DEFAULT_SLAVE_PRIORITY 100</span>
<span class="c1">// 默认的重新配置从服务器的间隔</span>
<span class="cp">#define SENTINEL_SLAVE_RECONF_RETRY_PERIOD 10000</span>
<span class="c1">// 默认的同时对新主服务器进行复制的从服务器个数</span>
<span class="cp">#define SENTINEL_DEFAULT_PARALLEL_SYNCS 1</span>
<span class="c1">// 默认的最少重连接间隔</span>
<span class="cp">#define SENTINEL_MIN_LINK_RECONNECT_PERIOD 15000</span>
<span class="c1">// 默认的故障迁移执行时长</span>
<span class="cp">#define SENTINEL_DEFAULT_FAILOVER_TIMEOUT (60*3*1000)</span>
<span class="c1">// 默认的最大积压命令数量</span>
<span class="cp">#define SENTINEL_MAX_PENDING_COMMANDS 100</span>
<span class="c1">// 默认的选举超时时长</span>
<span class="cp">#define SENTINEL_ELECTION_TIMEOUT 10000</span>

<span class="cm">/* Failover machine different states. */</span>
<span class="cm">/* 故障转移时的状态 */</span>
<span class="c1">// 没在执行故障迁移</span>
<span class="cp">#define SENTINEL_FAILOVER_STATE_NONE 0  </span><span class="cm">/* No failover in progress. */</span><span class="cp"></span>
<span class="c1">// 正在等待开始故障迁移</span>
<span class="cp">#define SENTINEL_FAILOVER_STATE_WAIT_START 1  </span><span class="cm">/* Wait for failover_start_time*/</span><span class="cp"> </span>
<span class="c1">// 正在挑选作为新主服务器的从服务器</span>
<span class="cp">#define SENTINEL_FAILOVER_STATE_SELECT_SLAVE 2 </span><span class="cm">/* Select slave to promote */</span><span class="cp"></span>
<span class="c1">// 向被选中的从服务器发送 SLAVEOF no one</span>
<span class="cp">#define SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE 3 </span><span class="cm">/* Slave -&gt; Master */</span><span class="cp"></span>
<span class="c1">// 等待从服务器转变成主服务器 </span>
<span class="cp">#define SENTINEL_FAILOVER_STATE_WAIT_PROMOTION 4 </span><span class="cm">/* Wait slave to change role */</span><span class="cp"></span>
<span class="c1">// 向已下线主服务器的其他从服务器发送 SLAVEOF 命令</span>
<span class="c1">// 让它们复制新的主服务器</span>
<span class="cp">#define SENTINEL_FAILOVER_STATE_RECONF_SLAVES 5 </span><span class="cm">/* SLAVEOF newmaster */</span><span class="cp"></span>
<span class="c1">// 监视被升级的从服务器</span>
<span class="cp">#define SENTINEL_FAILOVER_STATE_UPDATE_CONFIG 6 </span><span class="cm">/* Monitor promoted slave. */</span><span class="cp"></span>

<span class="cm">/* 主从服务器之间的连接状态 */</span>
<span class="c1">// 连接正常</span>
<span class="cp">#define SENTINEL_MASTER_LINK_STATUS_UP 0</span>
<span class="c1">// 连接断开</span>
<span class="cp">#define SENTINEL_MASTER_LINK_STATUS_DOWN 1</span>

<span class="cm">/* Generic flags that can be used with different functions.</span>
<span class="cm"> * They use higher bits to avoid colliding with the function specific</span>
<span class="cm"> * flags. */</span>
<span class="cm">/* 可以用于多个函数的通用标识。</span>
<span class="cm"> * 使用高位来避免与一般标识冲突。 */</span>
<span class="c1">// 没有标识</span>
<span class="cp">#define SENTINEL_NO_FLAGS 0</span>
<span class="c1">// 生成事件</span>
<span class="cp">#define SENTINEL_GENERATE_EVENT (1&lt;&lt;16)</span>
<span class="c1">// 领头</span>
<span class="cp">#define SENTINEL_LEADER (1&lt;&lt;17)</span>
<span class="c1">// 观察者</span>
<span class="cp">#define SENTINEL_OBSERVER (1&lt;&lt;18)</span>

<span class="cm">/* Script execution flags and limits. */</span>
<span class="cm">/* 脚本执行状态和限制 */</span>
<span class="c1">// 脚本目前没有被执行</span>
<span class="cp">#define SENTINEL_SCRIPT_NONE 0</span>
<span class="c1">// 脚本正在执行</span>
<span class="cp">#define SENTINEL_SCRIPT_RUNNING 1</span>
<span class="c1">// 脚本队列保存脚本数量的最大值</span>
<span class="cp">#define SENTINEL_SCRIPT_MAX_QUEUE 256</span>
<span class="c1">// 同一时间可执行脚本的最大数量</span>
<span class="cp">#define SENTINEL_SCRIPT_MAX_RUNNING 16</span>
<span class="c1">// 脚本的最大执行时长</span>
<span class="cp">#define SENTINEL_SCRIPT_MAX_RUNTIME 60000 </span><span class="cm">/* 60 seconds max exec time. */</span><span class="cp"></span>
<span class="c1">// 脚本最大重试数量</span>
<span class="cp">#define SENTINEL_SCRIPT_MAX_RETRY 10</span>
<span class="c1">// 脚本重试之前的延迟时间</span>
<span class="cp">#define SENTINEL_SCRIPT_RETRY_DELAY 30000 </span><span class="cm">/* 30 seconds between retries. */</span><span class="cp"></span>

<span class="c1">// Sentinel 会为每个被监视的 Redis 实例创建相应的 sentinelRedisInstance 实例</span>
<span class="c1">// （被监视的实例可以是主服务器、从服务器、或者其他 Sentinel ）</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">sentinelRedisInstance</span> <span class="p">{</span>
    
    <span class="c1">// 实例的类型，以及该实例的当前状态</span>
    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>      <span class="cm">/* See SRI_... defines */</span>
    
    <span class="c1">// 实例的名字</span>
    <span class="c1">// 主服务器的名字由用户在配置文件中设置</span>
    <span class="c1">// 从服务器以及 Sentinel 的名字由 Sentinel 自动设置</span>
    <span class="c1">// 格式为 ip:port ，例如 &quot;127.0.0.1:26379&quot;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>     <span class="cm">/* Master name from the point of view of this sentinel. */</span>

    <span class="c1">// 实例的运行 ID</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">runid</span><span class="p">;</span>    <span class="cm">/* run ID of this instance. */</span>

    <span class="c1">// 配置纪元</span>
    <span class="kt">uint64_t</span> <span class="n">config_epoch</span><span class="p">;</span>  <span class="cm">/* Configuration epoch. */</span>

    <span class="c1">// 实例的地址</span>
    <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span> <span class="cm">/* Master host. */</span>

    <span class="c1">// 用于发送命令的异步连接</span>
    <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">cc</span><span class="p">;</span> <span class="cm">/* Hiredis context for commands. */</span>

    <span class="c1">// 用于执行 SUBSCRIBE 命令、接收频道信息的异步连接</span>
    <span class="c1">// 仅在实例为主服务器时使用</span>
    <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">pc</span><span class="p">;</span> <span class="cm">/* Hiredis context for Pub / Sub. */</span>

    <span class="c1">// 已发送但尚未回复的命令数量</span>
    <span class="kt">int</span> <span class="n">pending_commands</span><span class="p">;</span>   <span class="cm">/* Number of commands sent waiting for a reply. */</span>

    <span class="c1">// cc 连接的创建时间</span>
    <span class="kt">mstime_t</span> <span class="n">cc_conn_time</span><span class="p">;</span> <span class="cm">/* cc connection time. */</span>
    
    <span class="c1">// pc 连接的创建时间</span>
    <span class="kt">mstime_t</span> <span class="n">pc_conn_time</span><span class="p">;</span> <span class="cm">/* pc connection time. */</span>

    <span class="c1">// 最后一次从这个实例接收信息的时间</span>
    <span class="kt">mstime_t</span> <span class="n">pc_last_activity</span><span class="p">;</span> <span class="cm">/* Last time we received any message. */</span>

    <span class="c1">// 实例最后一次返回正确的 PING 命令回复的时间</span>
    <span class="kt">mstime_t</span> <span class="n">last_avail_time</span><span class="p">;</span> <span class="cm">/* Last time the instance replied to ping with</span>
<span class="cm">                                 a reply we consider valid. */</span>

    <span class="c1">// 实例最后一次返回 PING 命令的时间，无论内容正确与否</span>
    <span class="kt">mstime_t</span> <span class="n">last_pong_time</span><span class="p">;</span>  <span class="cm">/* Last time the instance replied to ping,</span>
<span class="cm">                                 whatever the reply was. That&#39;s used to check</span>
<span class="cm">                                 if the link is idle and must be reconnected. */</span>

    <span class="c1">// 最后一次向频道发送问候信息的时间</span>
    <span class="c1">// 只在当前实例为 sentinel 时使用</span>
    <span class="kt">mstime_t</span> <span class="n">last_pub_time</span><span class="p">;</span>   <span class="cm">/* Last time we sent hello via Pub/Sub. */</span>

    <span class="c1">// 最后一次接收到这个 sentinel 发来的问候信息的时间</span>
    <span class="c1">// 只在当前实例为 sentinel 时使用</span>
    <span class="kt">mstime_t</span> <span class="n">last_hello_time</span><span class="p">;</span> <span class="cm">/* Only used if SRI_SENTINEL is set. Last time</span>
<span class="cm">                                 we received an hello from this Sentinel</span>
<span class="cm">                                 via Pub/Sub. */</span>

    <span class="c1">// 最后一次回复 SENTINEL is-master-down-by-addr 命令的时间</span>
    <span class="c1">// 只在当前实例为 sentinel 时使用</span>
    <span class="kt">mstime_t</span> <span class="n">last_master_down_reply_time</span><span class="p">;</span> <span class="cm">/* Time of last reply to</span>
<span class="cm">                                             SENTINEL is-master-down command. */</span>

    <span class="c1">// 实例被判断为 SDOWN 状态的时间</span>
    <span class="kt">mstime_t</span> <span class="n">s_down_since_time</span><span class="p">;</span> <span class="cm">/* Subjectively down since time. */</span>

    <span class="c1">// 实例被判断为 ODOWN 状态的时间</span>
    <span class="kt">mstime_t</span> <span class="n">o_down_since_time</span><span class="p">;</span> <span class="cm">/* Objectively down since time. */</span>

    <span class="c1">// SENTINEL down-after-milliseconds 选项所设定的值</span>
    <span class="c1">// 实例无响应多少毫秒之后才会被判断为主观下线（subjectively down）</span>
    <span class="kt">mstime_t</span> <span class="n">down_after_period</span><span class="p">;</span> <span class="cm">/* Consider it down after that period. */</span>

    <span class="c1">// 从实例获取 INFO 命令的回复的时间</span>
    <span class="kt">mstime_t</span> <span class="n">info_refresh</span><span class="p">;</span>  <span class="cm">/* Time at which we received INFO output from it. */</span>

    <span class="cm">/* Role and the first time we observed it.</span>
<span class="cm">     * This is useful in order to delay replacing what the instance reports</span>
<span class="cm">     * with our own configuration. We need to always wait some time in order</span>
<span class="cm">     * to give a chance to the leader to report the new configuration before</span>
<span class="cm">     * we do silly things. */</span>
    <span class="c1">// 实例的角色</span>
    <span class="kt">int</span> <span class="n">role_reported</span><span class="p">;</span>
    <span class="c1">// 角色的更新时间</span>
    <span class="kt">mstime_t</span> <span class="n">role_reported_time</span><span class="p">;</span>

    <span class="c1">// 最后一次从服务器的主服务器地址变更的时间</span>
    <span class="kt">mstime_t</span> <span class="n">slave_conf_change_time</span><span class="p">;</span> <span class="cm">/* Last time slave master addr changed. */</span>

    <span class="cm">/* Master specific. */</span>
    <span class="cm">/* 主服务器实例特有的属性 -------------------------------------------------------------*/</span>

    <span class="c1">// 其他同样监控这个主服务器的所有 sentinel</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">sentinels</span><span class="p">;</span>    <span class="cm">/* Other sentinels monitoring the same master. */</span>

    <span class="c1">// 这个主服务器的所有从服务器</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">slaves</span><span class="p">;</span>       <span class="cm">/* Slaves for this master instance. */</span>

    <span class="c1">// SENTINEL monitor &lt;master-name&gt; &lt;IP&gt; &lt;port&gt; &lt;quorum&gt; 选项中的 quorum 参数</span>
    <span class="c1">// 判断这个实例为客观下线（objectively down）所需的支持投票数量</span>
    <span class="kt">int</span> <span class="n">quorum</span><span class="p">;</span>         <span class="cm">/* Number of sentinels that need to agree on failure. */</span>

    <span class="c1">// SENTINEL parallel-syncs &lt;master-name&gt; &lt;number&gt; 选项的值</span>
    <span class="c1">// 在执行故障转移操作时，可以同时对新的主服务器进行同步的从服务器数量</span>
    <span class="kt">int</span> <span class="n">parallel_syncs</span><span class="p">;</span> <span class="cm">/* How many slaves to reconfigure at same time. */</span>

    <span class="c1">// 连接主服务器和从服务器所需的密码</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">auth_pass</span><span class="p">;</span>    <span class="cm">/* Password to use for AUTH against master &amp; slaves. */</span>

    <span class="cm">/* Slave specific. */</span>
    <span class="cm">/* 从服务器实例特有的属性 -------------------------------------------------------------*/</span>

    <span class="c1">// 主从服务器连接断开的时间</span>
    <span class="kt">mstime_t</span> <span class="n">master_link_down_time</span><span class="p">;</span> <span class="cm">/* Slave replication link down time. */</span>

    <span class="c1">// 从服务器优先级</span>
    <span class="kt">int</span> <span class="n">slave_priority</span><span class="p">;</span> <span class="cm">/* Slave priority according to its INFO output. */</span>

    <span class="c1">// 执行故障转移操作时，从服务器发送 SLAVEOF &lt;new-master&gt; 命令的时间</span>
    <span class="kt">mstime_t</span> <span class="n">slave_reconf_sent_time</span><span class="p">;</span> <span class="cm">/* Time at which we sent SLAVE OF &lt;new&gt; */</span>

    <span class="c1">// 主服务器的实例（在本实例为从服务器时使用）</span>
    <span class="k">struct</span> <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span> <span class="cm">/* Master instance if it&#39;s slave. */</span>

    <span class="c1">// INFO 命令的回复中记录的主服务器 IP</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">slave_master_host</span><span class="p">;</span>    <span class="cm">/* Master host as reported by INFO */</span>
    
    <span class="c1">// INFO 命令的回复中记录的主服务器端口号</span>
    <span class="kt">int</span> <span class="n">slave_master_port</span><span class="p">;</span>      <span class="cm">/* Master port as reported by INFO */</span>

    <span class="c1">// INFO 命令的回复中记录的主从服务器连接状态</span>
    <span class="kt">int</span> <span class="n">slave_master_link_status</span><span class="p">;</span> <span class="cm">/* Master link status as reported by INFO */</span>

    <span class="c1">// 从服务器的复制偏移量</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">slave_repl_offset</span><span class="p">;</span> <span class="cm">/* Slave replication offset. */</span>

    <span class="cm">/* Failover */</span>
    <span class="cm">/* 故障转移相关属性 -------------------------------------------------------------------*/</span>


    <span class="c1">// 如果这是一个主服务器实例，那么 leader 将是负责进行故障转移的 Sentinel 的运行 ID 。</span>
    <span class="c1">// 如果这是一个 Sentinel 实例，那么 leader 就是被选举出来的领头 Sentinel 。</span>
    <span class="c1">// 这个域只在 Sentinel 实例的 flags 属性的 SRI_MASTER_DOWN 标志处于打开状态时才有效。</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">leader</span><span class="p">;</span>       <span class="cm">/* If this is a master instance, this is the runid of</span>
<span class="cm">                           the Sentinel that should perform the failover. If</span>
<span class="cm">                           this is a Sentinel, this is the runid of the Sentinel</span>
<span class="cm">                           that this Sentinel voted as leader. */</span>
    <span class="c1">// 领头的纪元</span>
    <span class="kt">uint64_t</span> <span class="n">leader_epoch</span><span class="p">;</span> <span class="cm">/* Epoch of the &#39;leader&#39; field. */</span>
    <span class="c1">// 当前执行中的故障转移的纪元</span>
    <span class="kt">uint64_t</span> <span class="n">failover_epoch</span><span class="p">;</span> <span class="cm">/* Epoch of the currently started failover. */</span>
    <span class="c1">// 故障转移操作的当前状态</span>
    <span class="kt">int</span> <span class="n">failover_state</span><span class="p">;</span> <span class="cm">/* See SENTINEL_FAILOVER_STATE_* defines. */</span>

    <span class="c1">// 状态改变的时间</span>
    <span class="kt">mstime_t</span> <span class="n">failover_state_change_time</span><span class="p">;</span>

    <span class="c1">// 最后一次进行故障迁移的时间</span>
    <span class="kt">mstime_t</span> <span class="n">failover_start_time</span><span class="p">;</span>   <span class="cm">/* Last failover attempt start time. */</span>
    <span class="c1">// 刷新故障迁移状态的最大时限</span>
    <span class="kt">mstime_t</span> <span class="n">failover_timeout</span><span class="p">;</span>      <span class="cm">/* Max time to refresh failover state. */</span>

    <span class="c1">// 指向被提升为新主服务器的从服务器的指针</span>
    <span class="k">struct</span> <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">promoted_slave</span><span class="p">;</span> <span class="cm">/* Promoted slave instance. */</span>

    <span class="cm">/* Scripts executed to notify admin or reconfigure clients: when they</span>
<span class="cm">     * are set to NULL no script is executed. */</span>
    <span class="c1">// 一个文件路径，保存着 WARNING 级别的事件发生时执行的，</span>
    <span class="c1">// 用于通知管理员的脚本的地址</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">notification_script</span><span class="p">;</span>

    <span class="c1">// 一个文件路径，保存着故障转移执行之前、之后、或者被中止时，</span>
    <span class="c1">// 需要执行的脚本的地址</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">client_reconfig_script</span><span class="p">;</span>

<span class="p">}</span> <span class="n">sentinelRedisInstance</span><span class="p">;</span>

<span class="cm">/* Main state. */</span>
<span class="cm">/* Sentinel 的状态结构 */</span>
<span class="k">struct</span> <span class="n">sentinelState</span> <span class="p">{</span>

    <span class="c1">// 当前纪元</span>
    <span class="kt">uint64_t</span> <span class="n">current_epoch</span><span class="p">;</span>     <span class="cm">/* Current epoch. */</span>

    <span class="c1">// 保存了所有被这个 sentinel 监视的主服务器</span>
    <span class="c1">// 字典的键是主服务器的名字</span>
    <span class="c1">// 字典的值则是一个指向 sentinelRedisInstance 结构的指针</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">masters</span><span class="p">;</span>      <span class="cm">/* Dictionary of master sentinelRedisInstances.</span>
<span class="cm">                           Key is the instance name, value is the</span>
<span class="cm">                           sentinelRedisInstance structure pointer. */</span>

    <span class="c1">// 是否进入了 TILT 模式？</span>
    <span class="kt">int</span> <span class="n">tilt</span><span class="p">;</span>           <span class="cm">/* Are we in TILT mode? */</span>

    <span class="c1">// 目前正在执行的脚本的数量</span>
    <span class="kt">int</span> <span class="n">running_scripts</span><span class="p">;</span>    <span class="cm">/* Number of scripts in execution right now. */</span>

    <span class="c1">// 进入 TILT 模式的时间</span>
    <span class="kt">mstime_t</span> <span class="n">tilt_start_time</span><span class="p">;</span>   <span class="cm">/* When TITL started. */</span>

    <span class="c1">// 最后一次执行时间处理器的时间</span>
    <span class="kt">mstime_t</span> <span class="n">previous_time</span><span class="p">;</span>     <span class="cm">/* Last time we ran the time handler. */</span>

    <span class="c1">// 一个 FIFO 队列，包含了所有需要执行的用户脚本</span>
    <span class="n">list</span> <span class="o">*</span><span class="n">scripts_queue</span><span class="p">;</span>    <span class="cm">/* Queue of user scripts to execute. */</span>

<span class="p">}</span> <span class="n">sentinel</span><span class="p">;</span>

<span class="cm">/* A script execution job. */</span>
<span class="c1">// 脚本运行状态</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">sentinelScriptJob</span> <span class="p">{</span>

    <span class="c1">// 标志，记录了脚本是否运行</span>
    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>              <span class="cm">/* Script job flags: SENTINEL_SCRIPT_* */</span>

    <span class="c1">// 该脚本的已尝试执行次数</span>
    <span class="kt">int</span> <span class="n">retry_num</span><span class="p">;</span>          <span class="cm">/* Number of times we tried to execute it. */</span>

    <span class="c1">// 要传给脚本的参数</span>
    <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">;</span>            <span class="cm">/* Arguments to call the script. */</span>

    <span class="c1">// 开始运行脚本的时间</span>
    <span class="kt">mstime_t</span> <span class="n">start_time</span><span class="p">;</span>    <span class="cm">/* Script execution time if the script is running,</span>
<span class="cm">                               otherwise 0 if we are allowed to retry the</span>
<span class="cm">                               execution at any time. If the script is not</span>
<span class="cm">                               running and it&#39;s not 0, it means: do not run</span>
<span class="cm">                               before the specified time. */</span>

    <span class="c1">// 脚本由子进程执行，该属性记录子进程的 pid</span>
    <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>              <span class="cm">/* Script execution pid. */</span>

<span class="p">}</span> <span class="n">sentinelScriptJob</span><span class="p">;</span>

<span class="cm">/* ======================= hiredis ae.c adapters =============================</span>
<span class="cm"> * Note: this implementation is taken from hiredis/adapters/ae.h, however</span>
<span class="cm"> * we have our modified copy for Sentinel in order to use our allocator</span>
<span class="cm"> * and to have full control over how the adapter works. */</span>

<span class="c1">// 客户端适配器（adapter）结构</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">redisAeEvents</span> <span class="p">{</span>

    <span class="c1">// 客户端连接上下文</span>
    <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>

    <span class="c1">// 服务器的事件循环</span>
    <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">loop</span><span class="p">;</span>

    <span class="c1">// 套接字</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

    <span class="c1">// 记录读事件以及写事件是否就绪</span>
    <span class="kt">int</span> <span class="n">reading</span><span class="p">,</span> <span class="n">writing</span><span class="p">;</span>

<span class="p">}</span> <span class="n">redisAeEvents</span><span class="p">;</span>

<span class="c1">// 读事件处理器 </span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">redisAeReadEvent</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">el</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">((</span><span class="kt">void</span><span class="p">)</span><span class="n">el</span><span class="p">);</span> <span class="p">((</span><span class="kt">void</span><span class="p">)</span><span class="n">fd</span><span class="p">);</span> <span class="p">((</span><span class="kt">void</span><span class="p">)</span><span class="n">mask</span><span class="p">);</span>

    <span class="n">redisAeEvents</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisAeEvents</span><span class="o">*</span><span class="p">)</span><span class="n">privdata</span><span class="p">;</span>
    <span class="c1">// 从连接中进行读取</span>
    <span class="n">redisAsyncHandleRead</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 写事件处理器</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">redisAeWriteEvent</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">el</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">((</span><span class="kt">void</span><span class="p">)</span><span class="n">el</span><span class="p">);</span> <span class="p">((</span><span class="kt">void</span><span class="p">)</span><span class="n">fd</span><span class="p">);</span> <span class="p">((</span><span class="kt">void</span><span class="p">)</span><span class="n">mask</span><span class="p">);</span>

    <span class="n">redisAeEvents</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisAeEvents</span><span class="o">*</span><span class="p">)</span><span class="n">privdata</span><span class="p">;</span>
    <span class="c1">// 从连接中进行写入</span>
    <span class="n">redisAsyncHandleWrite</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 将读事件处理器安装到事件循环中</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">redisAeAddRead</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">redisAeEvents</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisAeEvents</span><span class="o">*</span><span class="p">)</span><span class="n">privdata</span><span class="p">;</span>
    <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">loop</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">;</span>
    <span class="c1">// 如果读事件处理器未安装，那么进行安装</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">reading</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">reading</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">aeCreateFileEvent</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="n">AE_READABLE</span><span class="p">,</span><span class="n">redisAeReadEvent</span><span class="p">,</span><span class="n">e</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 从事件循环中删除读事件处理器</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">redisAeDelRead</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">redisAeEvents</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisAeEvents</span><span class="o">*</span><span class="p">)</span><span class="n">privdata</span><span class="p">;</span>
    <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">loop</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">;</span>
    <span class="c1">// 仅在读事件处理器已安装的情况下进行删除</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">reading</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">reading</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">aeDeleteFileEvent</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="n">AE_READABLE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 将写事件处理器安装到事件循环中</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">redisAeAddWrite</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">redisAeEvents</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisAeEvents</span><span class="o">*</span><span class="p">)</span><span class="n">privdata</span><span class="p">;</span>
    <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">loop</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">writing</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">aeCreateFileEvent</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="n">AE_WRITABLE</span><span class="p">,</span><span class="n">redisAeWriteEvent</span><span class="p">,</span><span class="n">e</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 从事件循环中删除写事件处理器</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">redisAeDelWrite</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">redisAeEvents</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisAeEvents</span><span class="o">*</span><span class="p">)</span><span class="n">privdata</span><span class="p">;</span>
    <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">loop</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">writing</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">aeDeleteFileEvent</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="n">AE_WRITABLE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 清理事件</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">redisAeCleanup</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">redisAeEvents</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisAeEvents</span><span class="o">*</span><span class="p">)</span><span class="n">privdata</span><span class="p">;</span>
    <span class="n">redisAeDelRead</span><span class="p">(</span><span class="n">privdata</span><span class="p">);</span>
    <span class="n">redisAeDelWrite</span><span class="p">(</span><span class="n">privdata</span><span class="p">);</span>
    <span class="n">zfree</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 为上下文 ae 和事件循环 loop 创建 hiredis 适配器</span>
<span class="c1">// 并设置相关的异步处理函数</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">redisAeAttach</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">redisContext</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">);</span>
    <span class="n">redisAeEvents</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

    <span class="cm">/* Nothing should be attached when something is already attached */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">.</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>

    <span class="cm">/* Create container for context and r/w events */</span>
    <span class="c1">// 创建适配器</span>
    <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisAeEvents</span><span class="o">*</span><span class="p">)</span><span class="n">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">));</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">ac</span><span class="p">;</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span><span class="p">;</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">reading</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Register functions to start/stop listening for events */</span>
    <span class="c1">// 设置异步调用函数</span>
    <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">.</span><span class="n">addRead</span> <span class="o">=</span> <span class="n">redisAeAddRead</span><span class="p">;</span>
    <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">.</span><span class="n">delRead</span> <span class="o">=</span> <span class="n">redisAeDelRead</span><span class="p">;</span>
    <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">.</span><span class="n">addWrite</span> <span class="o">=</span> <span class="n">redisAeAddWrite</span><span class="p">;</span>
    <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">.</span><span class="n">delWrite</span> <span class="o">=</span> <span class="n">redisAeDelWrite</span><span class="p">;</span>
    <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">redisAeCleanup</span><span class="p">;</span>
    <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">REDIS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ============================= Prototypes ================================= */</span>

<span class="kt">void</span> <span class="nf">sentinelLinkEstablishedCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sentinelDisconnectCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sentinelReceiveHelloMessages</span><span class="p">(</span><span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">);</span>
<span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="nf">sentinelGetMasterByName</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">sentinelGetSubjectiveLeader</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">);</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">sentinelGetObjectiveLeader</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">yesnotoi</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sentinelDisconnectInstanceFromContext</span><span class="p">(</span><span class="k">const</span> <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sentinelKillLink</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sentinelRedisInstanceTypeStr</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sentinelAbortFailover</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sentinelEvent</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>
<span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="nf">sentinelSelectSlave</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sentinelScheduleScriptExecution</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="p">...);</span>
<span class="kt">void</span> <span class="nf">sentinelStartFailover</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sentinelDiscardReplyCallback</span><span class="p">(</span><span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">sentinelSendSlaveOf</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">);</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">sentinelVoteLeader</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">req_epoch</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">req_runid</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">leader_epoch</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sentinelFlushConfig</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* ========================= Dictionary types =============================== */</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dictSdsHash</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">dictSdsKeyCompare</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key2</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">releaseSentinelRedisInstance</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">dictInstancesValDestructor</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">releaseSentinelRedisInstance</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Instance name (sds) -&gt; instance (sentinelRedisInstance pointer)</span>
<span class="cm"> *</span>
<span class="cm"> * also used for: sentinelRedisInstance-&gt;sentinels dictionary that maps</span>
<span class="cm"> * sentinels ip:port to last seen time in Pub/Sub hello message. */</span>
<span class="c1">// 这个字典类型有两个作用：</span>
<span class="c1">// 1） 将实例名字映射到一个 sentinelRedisInstance 指针</span>
<span class="c1">// 2） 将 sentinelRedisInstance 指针映射到一个字典，</span>
<span class="c1">//     字典的键是 Sentinel 的 ip:port 地址，</span>
<span class="c1">//     字典的值是该 Sentinel 最后一次向频道发送信息的时间</span>
<span class="n">dictType</span> <span class="n">instancesDictType</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">dictSdsHash</span><span class="p">,</span>               <span class="cm">/* hash function */</span>
    <span class="nb">NULL</span><span class="p">,</span>                      <span class="cm">/* key dup */</span>
    <span class="nb">NULL</span><span class="p">,</span>                      <span class="cm">/* val dup */</span>
    <span class="n">dictSdsKeyCompare</span><span class="p">,</span>         <span class="cm">/* key compare */</span>
    <span class="nb">NULL</span><span class="p">,</span>                      <span class="cm">/* key destructor */</span>
    <span class="n">dictInstancesValDestructor</span> <span class="cm">/* val destructor */</span>
<span class="p">};</span>

<span class="cm">/* Instance runid (sds) -&gt; votes (long casted to void*)</span>
<span class="cm"> *</span>
<span class="cm"> * This is useful into sentinelGetObjectiveLeader() function in order to</span>
<span class="cm"> * count the votes and understand who is the leader. */</span>
<span class="c1">// 将一个运行 ID 映射到一个 cast 成 void* 类型的 long 值的投票数量上</span>
<span class="c1">// 用于统计客观 leader sentinel</span>
<span class="n">dictType</span> <span class="n">leaderVotesDictType</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">dictSdsHash</span><span class="p">,</span>               <span class="cm">/* hash function */</span>
    <span class="nb">NULL</span><span class="p">,</span>                      <span class="cm">/* key dup */</span>
    <span class="nb">NULL</span><span class="p">,</span>                      <span class="cm">/* val dup */</span>
    <span class="n">dictSdsKeyCompare</span><span class="p">,</span>         <span class="cm">/* key compare */</span>
    <span class="nb">NULL</span><span class="p">,</span>                      <span class="cm">/* key destructor */</span>
    <span class="nb">NULL</span>                       <span class="cm">/* val destructor */</span>
<span class="p">};</span>

<span class="cm">/* =========================== Initialization =============================== */</span>

<span class="kt">void</span> <span class="nf">sentinelCommand</span><span class="p">(</span><span class="n">redisClient</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sentinelInfoCommand</span><span class="p">(</span><span class="n">redisClient</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>

<span class="c1">// 服务器在 sentinel 模式下可执行的命令</span>
<span class="k">struct</span> <span class="n">redisCommand</span> <span class="n">sentinelcmds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;ping&quot;</span><span class="p">,</span><span class="n">pingCommand</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;sentinel&quot;</span><span class="p">,</span><span class="n">sentinelCommand</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;subscribe&quot;</span><span class="p">,</span><span class="n">subscribeCommand</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;unsubscribe&quot;</span><span class="p">,</span><span class="n">unsubscribeCommand</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;psubscribe&quot;</span><span class="p">,</span><span class="n">psubscribeCommand</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;punsubscribe&quot;</span><span class="p">,</span><span class="n">punsubscribeCommand</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;info&quot;</span><span class="p">,</span><span class="n">sentinelInfoCommand</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* This function overwrites a few normal Redis config default with Sentinel</span>
<span class="cm"> * specific defaults. */</span>
<span class="c1">// 这个函数会用 Sentinel 所属的属性覆盖服务器默认的属性</span>
<span class="kt">void</span> <span class="nf">initSentinelConfig</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">server</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">REDIS_SENTINEL_PORT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Perform the Sentinel mode initialization. */</span>
<span class="c1">// 以 Sentinel 模式初始化服务器</span>
<span class="kt">void</span> <span class="nf">initSentinel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

    <span class="cm">/* Remove usual Redis commands from the command table, then just add</span>
<span class="cm">     * the SENTINEL command. */</span>
    <span class="c1">// 清空 Redis 服务器的命令表（该表用于普通模式）</span>
    <span class="n">dictEmpty</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">commands</span><span class="p">);</span>

    <span class="c1">// 将 SENTINEL 模式所用的命令添加进命令表</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sentinelcmds</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sentinelcmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">redisCommand</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">sentinelcmds</span><span class="o">+</span><span class="n">j</span><span class="p">;</span>

        <span class="n">retval</span> <span class="o">=</span> <span class="n">dictAdd</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">commands</span><span class="p">,</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
        <span class="n">redisAssert</span><span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">DICT_OK</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Initialize various data structures. */</span>
    <span class="cm">/* 初始化 Sentinel 的状态 */</span>
    <span class="c1">// 初始化纪元</span>
    <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// 初始化保存主服务器信息的字典</span>
    <span class="n">sentinel</span><span class="p">.</span><span class="n">masters</span> <span class="o">=</span> <span class="n">dictCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instancesDictType</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">// 初始化 TILT 模式的相关选项</span>
    <span class="n">sentinel</span><span class="p">.</span><span class="n">tilt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sentinel</span><span class="p">.</span><span class="n">tilt_start_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sentinel</span><span class="p">.</span><span class="n">previous_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

    <span class="c1">// 初始化脚本相关选项</span>
    <span class="n">sentinel</span><span class="p">.</span><span class="n">running_scripts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span> <span class="o">=</span> <span class="n">listCreate</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* This function gets called when the server is in Sentinel mode, started,</span>
<span class="cm"> * loaded the configuration, and is ready for normal operations. */</span>
<span class="c1">// 这个函数在 Sentinel 准备就绪，可以执行操作时执行</span>
<span class="kt">void</span> <span class="nf">sentinelIsRunning</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">redisLog</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;Sentinel runid is %s&quot;</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">runid</span><span class="p">);</span>

    <span class="c1">// Sentinel 不能在没有配置文件的情况下执行</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">configfile</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">access</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">configfile</span><span class="p">,</span><span class="n">W_OK</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">redisLog</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;Sentinel started without a config file, or config file not writable. Exiting...&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ============================== sentinelAddr ============================== */</span>

<span class="cm">/* Create a sentinelAddr object and return it on success.</span>
<span class="cm"> *</span>
<span class="cm"> * 创建一个 sentinel 地址对象，并在创建成功时返回该对象。</span>
<span class="cm"> *</span>
<span class="cm"> * On error NULL is returned and errno is set to:</span>
<span class="cm"> *</span>
<span class="cm"> * 函数在出错时返回 NULL ，并将 errnor 设为以下值：</span>
<span class="cm"> *</span>
<span class="cm"> *  ENOENT: Can&#39;t resolve the hostname.</span>
<span class="cm"> *          不能解释 hostname</span>
<span class="cm"> *</span>
<span class="cm"> *  EINVAL: Invalid port number.</span>
<span class="cm"> *          端口号不正确</span>
<span class="cm"> */</span>
<span class="n">sentinelAddr</span> <span class="o">*</span><span class="nf">createSentinelAddr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>

    <span class="c1">// 检查端口号</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">port</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 检查并创建地址</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">anetResolve</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">hostname</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">==</span> <span class="n">ANET_ERR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">ENOENT</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 创建并返回地址结构</span>
    <span class="n">sa</span> <span class="o">=</span> <span class="n">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sa</span><span class="p">));</span>
    <span class="n">sa</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="n">sa</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">sa</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return a duplicate of the source address. */</span>
<span class="c1">// 复制并返回给定地址的一个副本</span>
<span class="n">sentinelAddr</span> <span class="o">*</span><span class="nf">dupSentinelAddr</span><span class="p">(</span><span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>

    <span class="n">sa</span> <span class="o">=</span> <span class="n">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sa</span><span class="p">));</span>
    <span class="n">sa</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
    <span class="n">sa</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">sa</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Free a Sentinel address. Can&#39;t fail. */</span>
<span class="c1">// 释放 Sentinel 地址</span>
<span class="kt">void</span> <span class="nf">releaseSentinelAddr</span><span class="p">(</span><span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
    <span class="n">zfree</span><span class="p">(</span><span class="n">sa</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return non-zero if two addresses are equal. */</span>
<span class="c1">// 如果两个地址相同，那么返回 0</span>
<span class="kt">int</span> <span class="nf">sentinelAddrIsEqual</span><span class="p">(</span><span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* =========================== Events notification ========================== */</span>

<span class="cm">/* Send an event to log, pub/sub, user notification script.</span>
<span class="cm"> *</span>
<span class="cm"> * 将事件发送到日志、频道，以及用户提醒脚本。</span>
<span class="cm"> * </span>
<span class="cm"> * &#39;level&#39; is the log level for logging. Only REDIS_WARNING events will trigger</span>
<span class="cm"> * the execution of the user notification script.</span>
<span class="cm"> *</span>
<span class="cm"> * level 是日志的级别。只有 REDIS_WARNING 级别的日志会触发用户提醒脚本。</span>
<span class="cm"> *</span>
<span class="cm"> * &#39;type&#39; is the message type, also used as a pub/sub channel name.</span>
<span class="cm"> *</span>
<span class="cm"> * type 是信息的类型，也用作频道的名字。</span>
<span class="cm"> *</span>
<span class="cm"> * &#39;ri&#39;, is the redis instance target of this event if applicable, and is</span>
<span class="cm"> * used to obtain the path of the notification script to execute.</span>
<span class="cm"> *</span>
<span class="cm"> * ri 是引发事件的 Redis 实例，它可以用来获取可执行的用户脚本。</span>
<span class="cm"> *</span>
<span class="cm"> * The remaining arguments are printf-alike.</span>
<span class="cm"> *</span>
<span class="cm"> * 剩下的都是类似于传给 printf 函数的参数。</span>
<span class="cm"> *</span>
<span class="cm"> * If the format specifier starts with the two characters &quot;%@&quot; then ri is</span>
<span class="cm"> * not NULL, and the message is prefixed with an instance identifier in the</span>
<span class="cm"> * following format:</span>
<span class="cm"> *</span>
<span class="cm"> * 如果格式指定以 &quot;%@&quot; 两个字符开头，并且 ri 不为空，</span>
<span class="cm"> * 那么信息将使用以下实例标识符为开头：</span>
<span class="cm"> *</span>
<span class="cm"> *  &lt;instance type&gt; &lt;instance name&gt; &lt;ip&gt; &lt;port&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  If the instance type is not master, than the additional string is</span>
<span class="cm"> *  added to specify the originating master:</span>
<span class="cm"> *</span>
<span class="cm"> *  如果实例的类型不是主服务器，那么以下内容会被追加到信息的后面，</span>
<span class="cm"> *  用于指定目标主服务器：</span>
<span class="cm"> *</span>
<span class="cm"> *  @ &lt;master name&gt; &lt;master ip&gt; &lt;master port&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Any other specifier after &quot;%@&quot; is processed by printf itself.</span>
<span class="cm"> *</span>
<span class="cm"> * &quot;%@&quot; 之后的其他指派器（specifier）都和 printf 函数所使用的指派器一样。</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sentinelEvent</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span>
                   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
    <span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
    <span class="c1">// 日志字符串</span>
    <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="n">REDIS_MAX_LOGMSG_LEN</span><span class="p">];</span>
    <span class="n">robj</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="o">*</span><span class="n">payload</span><span class="p">;</span>

    <span class="cm">/* Handle %@ */</span>
    <span class="c1">// 处理 %@</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 如果 ri 实例是主服务器，那么 master 就是 NULL </span>
        <span class="c1">// 否则 ri 就是一个从服务器或者 sentinel ，而 master 就是该实例的主服务器</span>
        <span class="c1">//</span>
        <span class="c1">// sentinelRedisInstance *master = NULL;</span>
        <span class="c1">// if (~(ri-&gt;flags &amp; SRI_MASTER))</span>
        <span class="c1">//     master = ri-&gt;master;</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="o">?</span>
                                         <span class="nb">NULL</span> <span class="o">:</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
            
            <span class="c1">// ri 不是主服务器</span>

            <span class="n">snprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="s">&quot;%s %s %s %d @ %s %s %d&quot;</span><span class="p">,</span>
                <span class="c1">// 打印 ri 的类型</span>
                <span class="n">sentinelRedisInstanceTypeStr</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span>
                <span class="c1">// 打印 ri 的名字、IP 和端口号</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
                <span class="c1">// 打印 ri 的主服务器的名字、 IP 和端口号</span>
                <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

            <span class="c1">// ri 是主服务器</span>

            <span class="n">snprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="s">&quot;%s %s %s %d&quot;</span><span class="p">,</span>
                <span class="c1">// 打印 ri 的类型</span>
                <span class="n">sentinelRedisInstanceTypeStr</span><span class="p">(</span><span class="n">ri</span><span class="p">),</span>
                <span class="c1">// 打印 ri 的名字、IP 和端口号</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// 跳过已处理的 &quot;%@&quot; 字符</span>
        <span class="n">fmt</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Use vsprintf for the rest of the formatting if any. */</span>
    <span class="c1">// 打印之后的内容，格式和平常的 printf 一样</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
        <span class="n">vsnprintf</span><span class="p">(</span><span class="n">msg</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">-</span><span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
        <span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Log the message if the log level allows it to be logged. */</span>
    <span class="c1">// 如果日志的级别足够高的话，那么记录到日志中</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">server</span><span class="p">.</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="n">redisLog</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="s">&quot;%s %s&quot;</span><span class="p">,</span><span class="n">type</span><span class="p">,</span><span class="n">msg</span><span class="p">);</span>

    <span class="cm">/* Publish the message via Pub/Sub if it&#39;s not a debugging one. */</span>
    <span class="c1">// 如果日志不是 DEBUG 日志，那么将它发送到频道中</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">REDIS_DEBUG</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 频道</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">createStringObject</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
        <span class="c1">// 内容</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">createStringObject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
        <span class="c1">// 发送信息</span>
        <span class="n">pubsubPublishMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="n">payload</span><span class="p">);</span>
        <span class="n">decrRefCount</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
        <span class="n">decrRefCount</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Call the notification script if applicable. */</span>
    <span class="c1">// 如果有需要的话，调用提醒脚本</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">REDIS_WARNING</span> <span class="o">&amp;&amp;</span> <span class="n">ri</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="o">?</span>
                                         <span class="nl">ri</span> <span class="p">:</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">notification_script</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sentinelScheduleScriptExecution</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">notification_script</span><span class="p">,</span>
                <span class="n">type</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ============================ script execution ============================ */</span>

<span class="cm">/* Release a script job structure and all the associated data. */</span>
<span class="kt">void</span> <span class="nf">sentinelReleaseScriptJob</span><span class="p">(</span><span class="n">sentinelScriptJob</span> <span class="o">*</span><span class="n">sj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="n">sdsfree</span><span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]);</span>
    <span class="n">zfree</span><span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">);</span>
    <span class="n">zfree</span><span class="p">(</span><span class="n">sj</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 将给定参数和脚本放入队列</span>
<span class="cp">#define SENTINEL_SCRIPT_MAX_ARGS 16</span>
<span class="kt">void</span> <span class="nf">sentinelScheduleScriptExecution</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
    <span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="n">SENTINEL_SCRIPT_MAX_ARGS</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">sentinelScriptJob</span> <span class="o">*</span><span class="n">sj</span><span class="p">;</span>

    <span class="c1">// 生成参数</span>
    <span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="n">SENTINEL_SCRIPT_MAX_ARGS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">argv</span><span class="p">[</span><span class="n">argc</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="kt">char</span><span class="o">*</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">[</span><span class="n">argc</span><span class="p">])</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">argv</span><span class="p">[</span><span class="n">argc</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argc</span><span class="p">]);</span> <span class="cm">/* Copy the string. */</span>
        <span class="n">argc</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
    <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
    
    <span class="c1">// 初始化脚本结构</span>
    <span class="n">sj</span> <span class="o">=</span> <span class="n">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sj</span><span class="p">));</span>
    <span class="n">sj</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SENTINEL_SCRIPT_NONE</span><span class="p">;</span>
    <span class="n">sj</span><span class="o">-&gt;</span><span class="n">retry_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span> <span class="o">=</span> <span class="n">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">argc</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
    <span class="n">sj</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sj</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">,</span><span class="n">argv</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">argc</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>

    <span class="c1">// 添加到等待执行脚本队列的末尾， FIFO</span>
    <span class="n">listAddNodeTail</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">,</span><span class="n">sj</span><span class="p">);</span>

    <span class="cm">/* Remove the oldest non running script if we already hit the limit. */</span>
    <span class="c1">// 如果入队的脚本数量太多，那么移除最旧的未执行脚本</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listLength</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SENTINEL_SCRIPT_MAX_QUEUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
        <span class="n">listIter</span> <span class="n">li</span><span class="p">;</span>

        <span class="n">listRewind</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sj</span> <span class="o">=</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

            <span class="c1">// 不删除正在运行的脚本</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENTINEL_SCRIPT_RUNNING</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
            <span class="cm">/* The first node is the oldest as we add on tail. */</span>
            <span class="n">listDelNode</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">,</span><span class="n">ln</span><span class="p">);</span>
            <span class="n">sentinelReleaseScriptJob</span><span class="p">(</span><span class="n">sj</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">redisAssert</span><span class="p">(</span><span class="n">listLength</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">)</span> <span class="o">&lt;=</span>
                    <span class="n">SENTINEL_SCRIPT_MAX_QUEUE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Lookup a script in the scripts queue via pid, and returns the list node</span>
<span class="cm"> * (so that we can easily remove it from the queue if needed). */</span>
<span class="c1">// 根据 pid ，查找正在运行中的脚本</span>
<span class="n">listNode</span> <span class="o">*</span><span class="nf">sentinelGetScriptListNodeByPid</span><span class="p">(</span><span class="kt">pid_t</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
    <span class="n">listIter</span> <span class="n">li</span><span class="p">;</span>

    <span class="n">listRewind</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelScriptJob</span> <span class="o">*</span><span class="n">sj</span> <span class="o">=</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENTINEL_SCRIPT_RUNNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sj</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ln</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Run pending scripts if we are not already at max number of running</span>
<span class="cm"> * scripts. */</span>
<span class="c1">// 运行等待执行的脚本</span>
<span class="kt">void</span> <span class="nf">sentinelRunPendingScripts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
    <span class="n">listIter</span> <span class="n">li</span><span class="p">;</span>
    <span class="kt">mstime_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

    <span class="cm">/* Find jobs that are not running and run them, from the top to the</span>
<span class="cm">     * tail of the queue, so we run older jobs first. */</span>
    <span class="c1">// 如果运行的脚本数量未超过最大值，</span>
    <span class="c1">// 那么从 FIFO 队列中取出未运行的脚本，并运行该脚本</span>
    <span class="n">listRewind</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">running_scripts</span> <span class="o">&lt;</span> <span class="n">SENTINEL_SCRIPT_MAX_RUNNING</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sentinelScriptJob</span> <span class="o">*</span><span class="n">sj</span> <span class="o">=</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
        <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>

        <span class="cm">/* Skip if already running. */</span>
        <span class="c1">// 跳过已运行脚本</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENTINEL_SCRIPT_RUNNING</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="cm">/* Skip if it&#39;s a retry, but not enough time has elapsed. */</span>
        <span class="c1">// 这是一个重试脚本，但它刚刚执行完，稍后再重试</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">&amp;&amp;</span> <span class="n">sj</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// 打开运行标记</span>
        <span class="n">sj</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SENTINEL_SCRIPT_RUNNING</span><span class="p">;</span>
        <span class="c1">// 记录开始时间</span>
        <span class="n">sj</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
        <span class="c1">// 增加重试计数器</span>
        <span class="n">sj</span><span class="o">-&gt;</span><span class="n">retry_num</span><span class="o">++</span><span class="p">;</span>

        <span class="c1">// 创建子进程</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            
            <span class="c1">// 创建子进程失败</span>

            <span class="cm">/* Parent (fork error).</span>
<span class="cm">             * We report fork errors as signal 99, in order to unify the</span>
<span class="cm">             * reporting with other kind of errors. */</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;-script-error&quot;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span>
                          <span class="s">&quot;%s %d %d&quot;</span><span class="p">,</span> <span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">sj</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SENTINEL_SCRIPT_RUNNING</span><span class="p">;</span>
            <span class="n">sj</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// 子进程执行脚本</span>

            <span class="cm">/* Child */</span>
            <span class="n">execve</span><span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">,</span><span class="n">environ</span><span class="p">);</span>
            <span class="cm">/* If we are here an error occurred. */</span>
            <span class="n">_exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* Don&#39;t retry execution. */</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

            <span class="c1">// 父进程</span>
            
            <span class="c1">// 增加运行脚本计数器</span>
            <span class="n">sentinel</span><span class="p">.</span><span class="n">running_scripts</span><span class="o">++</span><span class="p">;</span>

            <span class="c1">// 记录 pid</span>
            <span class="n">sj</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>

            <span class="c1">// 发送脚本运行信号</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_DEBUG</span><span class="p">,</span><span class="s">&quot;+script-child&quot;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="s">&quot;%ld&quot;</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">pid</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* How much to delay the execution of a script that we need to retry after</span>
<span class="cm"> * an error?</span>
<span class="cm"> *</span>
<span class="cm"> * We double the retry delay for every further retry we do. So for instance</span>
<span class="cm"> * if RETRY_DELAY is set to 30 seconds and the max number of retries is 10</span>
<span class="cm"> * starting from the second attempt to execute the script the delays are:</span>
<span class="cm"> * 30 sec, 60 sec, 2 min, 4 min, 8 min, 16 min, 32 min, 64 min, 128 min. */</span>
<span class="c1">// 计算重试脚本前的延迟时间</span>
<span class="kt">mstime_t</span> <span class="nf">sentinelScriptRetryDelay</span><span class="p">(</span><span class="kt">int</span> <span class="n">retry_num</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">mstime_t</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">SENTINEL_SCRIPT_RETRY_DELAY</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">retry_num</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">delay</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">delay</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Check for scripts that terminated, and remove them from the queue if the</span>
<span class="cm"> * script terminated successfully. If instead the script was terminated by</span>
<span class="cm"> * a signal, or returned exit code &quot;1&quot;, it is scheduled to run again if</span>
<span class="cm"> * the max number of retries did not already elapsed. */</span>
<span class="c1">// 检查脚本的退出状态，并在脚本成功退出时，将脚本从队列中删除。</span>
<span class="c1">// 如果脚本被信号终结，或者返回退出代码 1 ，那么只要该脚本的重试次数未超过限制</span>
<span class="c1">// 那么该脚本就会被调度，并等待重试</span>
<span class="kt">void</span> <span class="nf">sentinelCollectTerminatedScripts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">statloc</span><span class="p">;</span>
    <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>

    <span class="c1">// 获取子进程信号</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">wait3</span><span class="p">(</span><span class="o">&amp;</span><span class="n">statloc</span><span class="p">,</span><span class="n">WNOHANG</span><span class="p">,</span><span class="nb">NULL</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">exitcode</span> <span class="o">=</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">statloc</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">bysignal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
        <span class="n">sentinelScriptJob</span> <span class="o">*</span><span class="n">sj</span><span class="p">;</span>

        <span class="c1">// 发送脚本终结信号</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">WIFSIGNALED</span><span class="p">(</span><span class="n">statloc</span><span class="p">))</span> <span class="n">bysignal</span> <span class="o">=</span> <span class="n">WTERMSIG</span><span class="p">(</span><span class="n">statloc</span><span class="p">);</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_DEBUG</span><span class="p">,</span><span class="s">&quot;-script-child&quot;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="s">&quot;%ld %d %d&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pid</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">,</span> <span class="n">bysignal</span><span class="p">);</span>
        
        <span class="c1">// 在队列中安 pid 查找脚本</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="n">sentinelGetScriptListNodeByPid</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ln</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">redisLog</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;wait3() returned a pid (%ld) we can&#39;t find in our scripts execution queue!&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pid</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

        <span class="cm">/* If the script was terminated by a signal or returns an</span>
<span class="cm">         * exit code of &quot;1&quot; (that means: please retry), we reschedule it</span>
<span class="cm">         * if the max number of retries is not already reached. */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">bysignal</span> <span class="o">||</span> <span class="n">exitcode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">sj</span><span class="o">-&gt;</span><span class="n">retry_num</span> <span class="o">!=</span> <span class="n">SENTINEL_SCRIPT_MAX_RETRY</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 重试脚本</span>

            <span class="n">sj</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SENTINEL_SCRIPT_RUNNING</span><span class="p">;</span>
            <span class="n">sj</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">sj</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">()</span> <span class="o">+</span>
                             <span class="n">sentinelScriptRetryDelay</span><span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">retry_num</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="cm">/* Otherwise let&#39;s remove the script, but log the event if the</span>
<span class="cm">             * execution did not terminated in the best of the ways. */</span>

            <span class="c1">// 发送脚本执行错误事件</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bysignal</span> <span class="o">||</span> <span class="n">exitcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;-script-error&quot;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span>
                              <span class="s">&quot;%s %d %d&quot;</span><span class="p">,</span> <span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bysignal</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// 将脚本从队列中删除</span>
            <span class="n">listDelNode</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">,</span><span class="n">ln</span><span class="p">);</span>
            <span class="n">sentinelReleaseScriptJob</span><span class="p">(</span><span class="n">sj</span><span class="p">);</span>
            <span class="n">sentinel</span><span class="p">.</span><span class="n">running_scripts</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Kill scripts in timeout, they&#39;ll be collected by the</span>
<span class="cm"> * sentinelCollectTerminatedScripts() function. */</span>
<span class="c1">// 杀死超时脚本，这些脚本会被 sentinelCollectTerminatedScripts 函数回收处理</span>
<span class="kt">void</span> <span class="nf">sentinelKillTimedoutScripts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
    <span class="n">listIter</span> <span class="n">li</span><span class="p">;</span>
    <span class="kt">mstime_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

    <span class="c1">// 遍历队列中的所有脚本</span>
    <span class="n">listRewind</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelScriptJob</span> <span class="o">*</span><span class="n">sj</span> <span class="o">=</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

        <span class="c1">// 选出那些正在执行，并且执行时间超过限制的脚本</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENTINEL_SCRIPT_RUNNING</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">sj</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SENTINEL_SCRIPT_MAX_RUNTIME</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 发送脚本超时事件</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;-script-timeout&quot;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="s">&quot;%s %ld&quot;</span><span class="p">,</span>
                <span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

            <span class="c1">// 杀死脚本进程</span>
            <span class="n">kill</span><span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span><span class="n">SIGKILL</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Implements SENTINEL PENDING-SCRIPTS command. */</span>
<span class="c1">// 打印脚本队列中所有脚本的状态</span>
<span class="kt">void</span> <span class="nf">sentinelPendingScriptsCommand</span><span class="p">(</span><span class="n">redisClient</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
    <span class="n">listIter</span> <span class="n">li</span><span class="p">;</span>

    <span class="n">addReplyMultiBulkLen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">listLength</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">));</span>
    <span class="n">listRewind</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelScriptJob</span> <span class="o">*</span><span class="n">sj</span> <span class="o">=</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">addReplyMultiBulkLen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;argv&quot;</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="n">j</span><span class="o">++</span><span class="p">;</span>
        <span class="n">addReplyMultiBulkLen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]);</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;flags&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>
            <span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENTINEL_SCRIPT_RUNNING</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;running&quot;</span> <span class="o">:</span> <span class="s">&quot;scheduled&quot;</span><span class="p">);</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;pid&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENTINEL_SCRIPT_RUNNING</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;run-time&quot;</span><span class="p">);</span>
            <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">sj</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kt">mstime_t</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">sj</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">?</span> <span class="p">(</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="o">-</span><span class="n">mstime</span><span class="p">())</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;run-delay&quot;</span><span class="p">);</span>
            <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">delay</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;retry-num&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">sj</span><span class="o">-&gt;</span><span class="n">retry_num</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This function calls, if any, the client reconfiguration script with the</span>
<span class="cm"> * following parameters:</span>
<span class="cm"> *</span>
<span class="cm"> * 当该函数执行时，使用以下格式的参数调用客户端重配置脚本</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * It is called every time a failover is performed.</span>
<span class="cm"> *</span>
<span class="cm"> * 这个函数在每次执行故障迁移时都会执行一次。</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;state&gt; is currently always &quot;failover&quot;.</span>
<span class="cm"> * &lt;role&gt; is either &quot;leader&quot; or &quot;observer&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;state&gt; 总是 &quot;failover&quot; ，而 &lt;role&gt; 可以是 &quot;leader&quot; 或者 &quot;observer&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * from/to fields are respectively master -&gt; promoted slave addresses for</span>
<span class="cm"> * &quot;start&quot; and &quot;end&quot;. </span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sentinelCallClientReconfScript</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">int</span> <span class="n">role</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">fromport</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">toport</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">client_reconfig_script</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">ll2string</span><span class="p">(</span><span class="n">fromport</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">fromport</span><span class="p">),</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
    <span class="n">ll2string</span><span class="p">(</span><span class="n">toport</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">toport</span><span class="p">),</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
    <span class="c1">// 将给定参数和脚本放进度列，等待执行</span>
    <span class="n">sentinelScheduleScriptExecution</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">client_reconfig_script</span><span class="p">,</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
        <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="n">SENTINEL_LEADER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;leader&quot;</span> <span class="o">:</span> <span class="s">&quot;observer&quot;</span><span class="p">,</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">fromport</span><span class="p">,</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">toport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ========================== sentinelRedisInstance ========================= */</span>

<span class="cm">/* Create a redis instance, the following fields must be populated by the</span>
<span class="cm"> * caller if needed:</span>
<span class="cm"> *</span>
<span class="cm"> * 创建一个 Redis 实例，在有需要时，以下两个域需要从调用者提取：</span>
<span class="cm"> *</span>
<span class="cm"> * runid: set to NULL but will be populated once INFO output is received.</span>
<span class="cm"> *        设置为 NULL ，并在接收到 INFO 命令的回复时设置</span>
<span class="cm"> *</span>
<span class="cm"> * info_refresh: is set to 0 to mean that we never received INFO so far.</span>
<span class="cm"> *               如果这个值为 0 ，那么表示我们未收到过 INFO 信息。</span>
<span class="cm"> *</span>
<span class="cm"> * If SRI_MASTER is set into initial flags the instance is added to</span>
<span class="cm"> * sentinel.masters table.</span>
<span class="cm"> *</span>
<span class="cm"> * 如果 flags 参数为 SRI_MASTER ，</span>
<span class="cm"> * 那么这个实例会被添加到 sentinel.masters 表。</span>
<span class="cm"> *</span>
<span class="cm"> * if SRI_SLAVE or SRI_SENTINEL is set then &#39;master&#39; must be not NULL and the</span>
<span class="cm"> * instance is added into master-&gt;slaves or master-&gt;sentinels table.</span>
<span class="cm"> *</span>
<span class="cm"> * 如果 flags 为 SRI_SLAVE 或者 SRI_SENTINEL ，</span>
<span class="cm"> * 那么 master 参数不能为 NULL ，</span>
<span class="cm"> * SRI_SLAVE 类型的实例会被添加到 master-&gt;slaves 表中，</span>
<span class="cm"> * 而 SRI_SENTINEL 类型的实例则会被添加到 master-&gt;sentinels 表中。</span>
<span class="cm"> *</span>
<span class="cm"> * If the instance is a slave or sentinel, the name parameter is ignored and</span>
<span class="cm"> * is created automatically as hostname:port.</span>
<span class="cm"> *</span>
<span class="cm"> * 如果实例是从服务器或者 sentinel ，那么 name 参数会被自动忽略，</span>
<span class="cm"> * 实例的名字会被自动设置为 hostname:port 。</span>
<span class="cm"> *</span>
<span class="cm"> * The function fails if hostname can&#39;t be resolved or port is out of range.</span>
<span class="cm"> * When this happens NULL is returned and errno is set accordingly to the</span>
<span class="cm"> * createSentinelAddr() function.</span>
<span class="cm"> *</span>
<span class="cm"> * 当 hostname 不能被解释，或者超出范围时，函数将失败。</span>
<span class="cm"> * 函数将返回 NULL ，并设置 errno 变量，</span>
<span class="cm"> * 具体的出错值请参考 createSentinelAddr() 函数。</span>
<span class="cm"> *</span>
<span class="cm"> * The function may also fail and return NULL with errno set to EBUSY if</span>
<span class="cm"> * a master or slave with the same name already exists. </span>
<span class="cm"> *</span>
<span class="cm"> * 当相同名字的主服务器或者从服务器已经存在时，函数返回 NULL ，</span>
<span class="cm"> * 并将 errno 设为 EBUSY 。</span>
<span class="cm"> */</span>
<span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="nf">createSentinelRedisInstance</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">quorum</span><span class="p">,</span> <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>
    <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">slavename</span><span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="o">*</span><span class="n">sdsname</span><span class="p">;</span>

    <span class="n">redisAssert</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_MASTER</span><span class="o">|</span><span class="n">SRI_SLAVE</span><span class="o">|</span><span class="n">SRI_SENTINEL</span><span class="p">));</span>
    <span class="n">redisAssert</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="o">||</span> <span class="n">master</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="cm">/* Check address validity. */</span>
    <span class="c1">// 保存 IP 地址和端口号到 addr</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">createSentinelAddr</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="n">port</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* For slaves and sentinel we use ip:port as name. */</span>
    <span class="c1">// 如果实例是从服务器或者 sentinel ，那么使用 ip:port 格式为实例设置名字</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_SLAVE</span><span class="o">|</span><span class="n">SRI_SENTINEL</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">slavename</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">slavename</span><span class="p">),</span>
            <span class="n">strchr</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;[%s]:%d&quot;</span> <span class="o">:</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span>
            <span class="n">hostname</span><span class="p">,</span><span class="n">port</span><span class="p">);</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">slavename</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Make sure the entry is not duplicated. This may happen when the same</span>
<span class="cm">     * name for a master is used multiple times inside the configuration or</span>
<span class="cm">     * if we try to add multiple times a slave or sentinel with same ip/port</span>
<span class="cm">     * to a master. */</span>
    <span class="c1">// 配置文件中添加了重复的主服务器配置</span>
    <span class="c1">// 或者尝试添加一个相同 ip 或者端口号的从服务器或者 sentinel 时</span>
    <span class="c1">// 就可能出现重复添加同一个实例的情况</span>
    <span class="c1">// 为了避免这种现象，程序在添加新实例之前，需要先检查实例是否已存在</span>
    <span class="c1">// 只有不存在的实例会被添加</span>

    <span class="c1">// 选择要添加的表</span>
    <span class="c1">// 注意主服务会被添加到 sentinel.masters 表</span>
    <span class="c1">// 而从服务器和 sentinel 则会被添加到 master 所属的 slaves 表和 sentinels 表中</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="n">table</span> <span class="o">=</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">masters</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="n">table</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SENTINEL</span><span class="p">)</span> <span class="n">table</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">;</span>
    <span class="n">sdsname</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dictFind</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">sdsname</span><span class="p">))</span> <span class="p">{</span>

        <span class="c1">// 实例已存在，函数直接返回</span>

        <span class="n">sdsfree</span><span class="p">(</span><span class="n">sdsname</span><span class="p">);</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">EBUSY</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Create the instance object. */</span>
    <span class="c1">// 创建实例对象</span>
    <span class="n">ri</span> <span class="o">=</span> <span class="n">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ri</span><span class="p">));</span>
    <span class="cm">/* Note that all the instances are started in the disconnected state,</span>
<span class="cm">     * the event loop will take care of connecting them. */</span>
    <span class="c1">// 所有连接都已断线为起始状态，sentinel 会在需要时自动为它创建连接</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">SRI_DISCONNECTED</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">sdsname</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">config_epoch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc_conn_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc_conn_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc_last_activity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_avail_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_pong_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_pub_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_hello_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_master_down_reply_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">s_down_since_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">o_down_since_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">down_after_period</span> <span class="o">=</span> <span class="n">master</span> <span class="o">?</span> <span class="n">master</span><span class="o">-&gt;</span><span class="nl">down_after_period</span> <span class="p">:</span>
                            <span class="n">SENTINEL_DEFAULT_DOWN_AFTER</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master_link_down_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">auth_pass</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_priority</span> <span class="o">=</span> <span class="n">SENTINEL_DEFAULT_SLAVE_PRIORITY</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_reconf_sent_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_link_status</span> <span class="o">=</span> <span class="n">SENTINEL_MASTER_LINK_STATUS_DOWN</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_repl_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">sentinels</span> <span class="o">=</span> <span class="n">dictCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instancesDictType</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">quorum</span> <span class="o">=</span> <span class="n">quorum</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">parallel_syncs</span> <span class="o">=</span> <span class="n">SENTINEL_DEFAULT_PARALLEL_SYNCS</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slaves</span> <span class="o">=</span> <span class="n">dictCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instancesDictType</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">info_refresh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Failover state. */</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader_epoch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_epoch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">=</span> <span class="n">SENTINEL_FAILOVER_STATE_NONE</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_start_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_timeout</span> <span class="o">=</span> <span class="n">SENTINEL_DEFAULT_FAILOVER_TIMEOUT</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">promoted_slave</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">notification_script</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">client_reconfig_script</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* Role */</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_MASTER</span><span class="o">|</span><span class="n">SRI_SLAVE</span><span class="p">);</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_conf_change_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

    <span class="cm">/* Add into the right table. */</span>
    <span class="c1">// 将实例添加到适当的表中</span>
    <span class="n">dictAdd</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ri</span><span class="p">);</span>

    <span class="c1">// 返回实例</span>
    <span class="k">return</span> <span class="n">ri</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Release this instance and all its slaves, sentinels, hiredis connections.</span>
<span class="cm"> *</span>
<span class="cm"> * 释放一个实例，以及它的所有从服务器、sentinel ，以及 hiredis 连接。</span>
<span class="cm"> *</span>
<span class="cm"> * This function also takes care of unlinking the instance from the main</span>
<span class="cm"> * masters table (if it is a master) or from its master sentinels/slaves table</span>
<span class="cm"> * if it is a slave or sentinel. </span>
<span class="cm"> *</span>
<span class="cm"> * 如果这个实例是一个从服务器或者 sentinel ，</span>
<span class="cm"> * 那么这个函数也会从该实例所属的主服务器表中删除这个从服务器/sentinel 。</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">releaseSentinelRedisInstance</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* Release all its slaves or sentinels if any. */</span>
    <span class="c1">// 释放（可能有的）sentinel 和 slave</span>
    <span class="n">dictRelease</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">);</span>
    <span class="n">dictRelease</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">);</span>

    <span class="cm">/* Release hiredis connections. */</span>
    <span class="c1">// 释放连接</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">)</span> <span class="n">sentinelKillLink</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">)</span> <span class="n">sentinelKillLink</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>

    <span class="cm">/* Free other resources. */</span>
    <span class="c1">// 释放其他资源</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span><span class="p">);</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">notification_script</span><span class="p">);</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">client_reconfig_script</span><span class="p">);</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span><span class="p">);</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span><span class="p">);</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">auth_pass</span><span class="p">);</span>
    <span class="n">releaseSentinelAddr</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

    <span class="cm">/* Clear state into the master if needed. */</span>
    <span class="c1">// 清除故障转移带来的状态</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_PROMOTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">zfree</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Lookup a slave in a master Redis instance, by ip and port. */</span>
<span class="c1">// 根据 IP 和端口号，查找主服务器实例的从服务器</span>
<span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="nf">sentinelRedisInstanceLookupSlave</span><span class="p">(</span>
                <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">sds</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">slave</span><span class="p">;</span>
  
    <span class="n">redisAssert</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">);</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span>
        <span class="n">strchr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;[%s]:%d&quot;</span> <span class="o">:</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span>
        <span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">);</span>
    <span class="n">slave</span> <span class="o">=</span> <span class="n">dictFetchValue</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">,</span><span class="n">key</span><span class="p">);</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">slave</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the name of the type of the instance as a string. */</span>
<span class="c1">// 以字符串形式返回实例的类型</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sentinelRedisInstanceTypeStr</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;master&quot;</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;slave&quot;</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SENTINEL</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;sentinel&quot;</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function removes all the instances found in the dictionary of</span>
<span class="cm"> * sentinels in the specified &#39;master&#39;, having either:</span>
<span class="cm"> * </span>
<span class="cm"> * 1) The same ip/port as specified.</span>
<span class="cm"> *    实例给定的 IP 和端口号和字典中已有的实例相同</span>
<span class="cm"> *</span>
<span class="cm"> * 2) The same runid.</span>
<span class="cm"> *    实例给定的运行 ID 和字典中已有的实例相同</span>
<span class="cm"> *</span>
<span class="cm"> * &quot;1&quot; and &quot;2&quot; don&#39;t need to verify at the same time, just one is enough.</span>
<span class="cm"> *</span>
<span class="cm"> * 以上条件任意满足一个，移除操作就会被执行。</span>
<span class="cm"> *</span>
<span class="cm"> * If &quot;runid&quot; is NULL it is not checked.</span>
<span class="cm"> * Similarly if &quot;ip&quot; is NULL it is not checked.</span>
<span class="cm"> *</span>
<span class="cm"> * 如果 runid 参数为 NULL ，那么不检查该参数。</span>
<span class="cm"> * 如果 ip 参数为 NULL ，那么不检查该参数。</span>
<span class="cm"> *</span>
<span class="cm"> * This function is useful because every time we add a new Sentinel into</span>
<span class="cm"> * a master&#39;s Sentinels dictionary, we want to be very sure about not</span>
<span class="cm"> * having duplicated instances for any reason. This is important because</span>
<span class="cm"> * other sentinels are needed to reach ODOWN quorum, and later to get</span>
<span class="cm"> * voted for a given configuration epoch in order to perform the failover.</span>
<span class="cm"> *</span>
<span class="cm"> * 因为 sentinel 的操作比如故障转移，需要多个 sentinel 投票才能进行。</span>
<span class="cm"> * 所以我们必须保证所添加的各个 sentinel 都是不相同、独一无二的，</span>
<span class="cm"> * 这样才能确保投票的合法性。</span>
<span class="cm"> *</span>
<span class="cm"> * The function returns the number of Sentinels removed. </span>
<span class="cm"> *</span>
<span class="cm"> * 函数的返回值为被移除 sentinel 的数量</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">removeMatchingSentinelsFromMaster</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">runid</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">removed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetSafeIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="c1">// 运行 ID 相同，或者 IP 和端口号相同，那么移除该实例</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span> <span class="o">&amp;&amp;</span> <span class="n">runid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span><span class="p">,</span><span class="n">runid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">ip</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">port</span> <span class="o">==</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">dictDelete</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
            <span class="n">removed</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">removed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Search an instance with the same runid, ip and port into a dictionary</span>
<span class="cm"> * of instances. Return NULL if not found, otherwise return the instance</span>
<span class="cm"> * pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * 在给定的实例中查找具有相同 runid 、ip 、port 的实例，</span>
<span class="cm"> * 没找到则返回 NULL 。</span>
<span class="cm"> *</span>
<span class="cm"> * runid or ip can be NULL. In such a case the search is performed only</span>
<span class="cm"> * by the non-NULL field. </span>
<span class="cm"> *</span>
<span class="cm"> * runid 或者 ip 都可以为 NULL ，在这种情况下，函数只检查非空域。</span>
<span class="cm"> */</span>
<span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="nf">getSentinelRedisInstanceByAddrAndRunID</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">instances</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">runid</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">redisAssert</span><span class="p">(</span><span class="n">ip</span> <span class="o">||</span> <span class="n">runid</span><span class="p">);</span>   <span class="cm">/* User must pass at least one search param. */</span>

    <span class="c1">// 遍历所有输入实例</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">instances</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="c1">// runid 不相同，忽略该实例</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">runid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// 检查 ip 和端口号是否相同</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">runid</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span><span class="p">,</span> <span class="n">runid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">ip</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">ri</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 根据名字查找主服务器</span>
<span class="cm">/* Master lookup by name */</span>
<span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="nf">sentinelGetMasterByName</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>
    <span class="n">sds</span> <span class="n">sdsname</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

    <span class="n">ri</span> <span class="o">=</span> <span class="n">dictFetchValue</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">masters</span><span class="p">,</span><span class="n">sdsname</span><span class="p">);</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">sdsname</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ri</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add the specified flags to all the instances in the specified dictionary. */</span>
<span class="c1">// 为输入的所有实例打开指定的 flags</span>
<span class="kt">void</span> <span class="nf">sentinelAddFlagsToDictOfRedisInstances</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">instances</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>

    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">instances</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">flags</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Remove the specified flags to all the instances in the specified</span>
<span class="cm"> * dictionary. */</span>
<span class="c1">// 从字典中移除所有实例的给定 flags</span>
<span class="kt">void</span> <span class="nf">sentinelDelFlagsToDictOfRedisInstances</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">instances</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>

    <span class="c1">// 遍历所有实例</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">instances</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
        <span class="c1">// 移除 flags</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">flags</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Reset the state of a monitored master:</span>
<span class="cm"> *</span>
<span class="cm"> * 重置主服务区的监控状态</span>
<span class="cm"> *</span>
<span class="cm"> * 1) Remove all slaves.</span>
<span class="cm"> *    移除主服务器的所有从服务器</span>
<span class="cm"> * 2) Remove all sentinels.</span>
<span class="cm"> *    移除主服务器的所有 sentinel</span>
<span class="cm"> * 3) Remove most of the flags resulting from runtime operations.</span>
<span class="cm"> *    移除大部分运行时操作标志</span>
<span class="cm"> * 4) Reset timers to their default value.</span>
<span class="cm"> *    重置计时器为默认值</span>
<span class="cm"> * 5) In the process of doing this undo the failover if in progress.</span>
<span class="cm"> *    如果故障转移正在执行的话，那么取消该它</span>
<span class="cm"> * 6) Disconnect the connections with the master (will reconnect automatically).</span>
<span class="cm"> *    断开 sentinel 与主服务器的连接（之后会自动重连）</span>
<span class="cm"> */</span>

<span class="cp">#define SENTINEL_RESET_NO_SENTINELS (1&lt;&lt;0)</span>
<span class="kt">void</span> <span class="nf">sentinelResetMaster</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">redisAssert</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">);</span>

    <span class="n">dictRelease</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">);</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slaves</span> <span class="o">=</span> <span class="n">dictCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instancesDictType</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENTINEL_RESET_NO_SENTINELS</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">dictRelease</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">);</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">sentinels</span> <span class="o">=</span> <span class="n">dictCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instancesDictType</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">)</span> <span class="n">sentinelKillLink</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">)</span> <span class="n">sentinelKillLink</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>

    <span class="c1">// 设置标识为断线的主服务器</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">SRI_MASTER</span><span class="o">|</span><span class="n">SRI_DISCONNECTED</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span><span class="p">);</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">=</span> <span class="n">SENTINEL_FAILOVER_STATE_NONE</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_start_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">promoted_slave</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span><span class="p">);</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span><span class="p">);</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_avail_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_pong_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

    <span class="c1">// 发送主服务器重置事件</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENTINEL_GENERATE_EVENT</span><span class="p">)</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+reset-master&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Call sentinelResetMaster() on every master with a name matching the specified</span>
<span class="cm"> * pattern. */</span>
<span class="c1">// 重置所有符合给定模式的主服务器</span>
<span class="kt">int</span> <span class="nf">sentinelResetMastersByPattern</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">pattern</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">masters</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">stringmatch</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">sentinelResetMaster</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
                <span class="n">reset</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">reset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reset the specified master with sentinelResetMaster(), and also change</span>
<span class="cm"> * the ip:port address, but take the name of the instance unmodified.</span>
<span class="cm"> *</span>
<span class="cm"> * 将 master 实例的 IP 和端口号修改成给定的 ip 和 port ，</span>
<span class="cm"> * 但保留 master 原来的名字。</span>
<span class="cm"> *</span>
<span class="cm"> * This is used to handle the +switch-master event.</span>
<span class="cm"> *</span>
<span class="cm"> * 这个函数用于处理 +switch-master 事件</span>
<span class="cm"> *</span>
<span class="cm"> * The function returns REDIS_ERR if the address can&#39;t be resolved for some</span>
<span class="cm"> * reason. Otherwise REDIS_OK is returned.  </span>
<span class="cm"> *</span>
<span class="cm"> * 函数在无法解释地址时返回 REDIS_ERR ，否则返回 REDIS_OK 。</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sentinelResetMasterAndChangeAddress</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">oldaddr</span><span class="p">,</span> <span class="o">*</span><span class="n">newaddr</span><span class="p">;</span>
    <span class="n">sentinelAddr</span> <span class="o">**</span><span class="n">slaves</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">numslaves</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>

    <span class="c1">// 根据 ip 和 port 参数，创建地址结构</span>
    <span class="n">newaddr</span> <span class="o">=</span> <span class="n">createSentinelAddr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">newaddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>

    <span class="cm">/* Make a list of slaves to add back after the reset.</span>
<span class="cm">     * Don&#39;t include the one having the address we are switching to. */</span>
    <span class="c1">// 创建一个包含原主服务器所有从服务器实例的数组</span>
    <span class="c1">// 用于在重置地址之后进行检查</span>
    <span class="c1">// 新主服务器（原主服务器的其中一个从服务器）的地址不会包含在这个数组中</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="c1">// 跳过新主服务器</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sentinelAddrIsEqual</span><span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="n">newaddr</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// 将从服务器保存到数组中</span>
        <span class="n">slaves</span> <span class="o">=</span> <span class="n">zrealloc</span><span class="p">(</span><span class="n">slaves</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sentinelAddr</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">numslaves</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
        <span class="n">slaves</span><span class="p">[</span><span class="n">numslaves</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">createSentinelAddr</span><span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
                                                 <span class="n">slave</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
    
    <span class="cm">/* If we are switching to a different address, include the old address</span>
<span class="cm">     * as a slave as well, so that we&#39;ll be able to sense / reconfigure</span>
<span class="cm">     * the old master. */</span>
    <span class="c1">// 如果新地址和 master 的地址不相同，</span>
    <span class="c1">// 将 master 的地址也作为从服务器地址添加到保存了所有从服务器地址的数组中</span>
    <span class="c1">// （这样等于将下线主服务器设置为新主服务器的从服务器）</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sentinelAddrIsEqual</span><span class="p">(</span><span class="n">newaddr</span><span class="p">,</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">slaves</span> <span class="o">=</span> <span class="n">zrealloc</span><span class="p">(</span><span class="n">slaves</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sentinelAddr</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">numslaves</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
        <span class="n">slaves</span><span class="p">[</span><span class="n">numslaves</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">createSentinelAddr</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
                                                 <span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Reset and switch address. */</span>
    <span class="c1">// 重置 master 实例结构</span>
    <span class="n">sentinelResetMaster</span><span class="p">(</span><span class="n">master</span><span class="p">,</span><span class="n">SENTINEL_RESET_NO_SENTINELS</span><span class="p">);</span>
    <span class="n">oldaddr</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
    <span class="c1">// 为 master 实例设置新的地址</span>
    <span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">newaddr</span><span class="p">;</span>
    <span class="n">master</span><span class="o">-&gt;</span><span class="n">o_down_since_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">master</span><span class="o">-&gt;</span><span class="n">s_down_since_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Add slaves back. */</span>
    <span class="c1">// 为实例加回之前保存的所有从服务器</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numslaves</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">slave</span><span class="p">;</span>

        <span class="n">slave</span> <span class="o">=</span> <span class="n">createSentinelRedisInstance</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">SRI_SLAVE</span><span class="p">,</span><span class="n">slaves</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
                    <span class="n">slaves</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">quorum</span><span class="p">,</span> <span class="n">master</span><span class="p">);</span>

        <span class="n">releaseSentinelAddr</span><span class="p">(</span><span class="n">slaves</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;+slave&quot;</span><span class="p">,</span><span class="n">slave</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
            <span class="n">sentinelFlushConfig</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">zfree</span><span class="p">(</span><span class="n">slaves</span><span class="p">);</span>

    <span class="cm">/* Release the old address at the end so we are safe even if the function</span>
<span class="cm">     * gets the master-&gt;addr-&gt;ip and master-&gt;addr-&gt;port as arguments. */</span>
    <span class="c1">// 释放旧地址</span>
    <span class="n">releaseSentinelAddr</span><span class="p">(</span><span class="n">oldaddr</span><span class="p">);</span>
    <span class="n">sentinelFlushConfig</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">REDIS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return non-zero if there was no SDOWN or ODOWN error associated to this</span>
<span class="cm"> * instance in the latest &#39;ms&#39; milliseconds. */</span>
<span class="c1">// 如果实例在给定 ms 中没有出现过 SDOWN 或者 ODOWN 状态</span>
<span class="c1">// 那么函数返回一个非零值</span>
<span class="kt">int</span> <span class="nf">sentinelRedisInstanceNoDownFor</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="kt">mstime_t</span> <span class="n">ms</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">mstime_t</span> <span class="n">most_recent</span><span class="p">;</span>

    <span class="n">most_recent</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">s_down_since_time</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">o_down_since_time</span> <span class="o">&gt;</span> <span class="n">most_recent</span><span class="p">)</span>
        <span class="n">most_recent</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">o_down_since_time</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">most_recent</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">most_recent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ms</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the current master address, that is, its address or the address</span>
<span class="cm"> * of the promoted slave if already operational. */</span>
<span class="c1">// 返回当前主服务器的地址</span>
<span class="c1">// 如果 Sentinel 正在对主服务器进行故障迁移，那么返回新主服务器的地址</span>
<span class="n">sentinelAddr</span> <span class="o">*</span><span class="nf">sentinelGetCurrentMasterAddress</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* If we are failing over the master, and the state is already</span>
<span class="cm">     * SENTINEL_FAILOVER_STATE_RECONF_SLAVES or greater, it means that we</span>
<span class="cm">     * already have the new configuration epoch in the master, and the</span>
<span class="cm">     * slave acknowledged the configuration switch. Advertise the new</span>
<span class="cm">     * address. */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span> <span class="o">&amp;&amp;</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">&gt;=</span> <span class="n">SENTINEL_FAILOVER_STATE_RECONF_SLAVES</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ============================ Config handling ============================= */</span>

<span class="c1">// Sentinel 配置文件分析器</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">sentinelHandleConfiguration</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>

    <span class="c1">// SENTINEL monitor 选项</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;monitor&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* monitor &lt;name&gt; &lt;host&gt; &lt;port&gt; &lt;quorum&gt; */</span>

        <span class="c1">// 读入 quorum 参数</span>
        <span class="kt">int</span> <span class="n">quorum</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

        <span class="c1">// 检查 quorum 参数必须大于 0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">quorum</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;Quorum must be 1 or greater.&quot;</span><span class="p">;</span>

        <span class="c1">// 创建主服务器实例</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">createSentinelRedisInstance</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">SRI_MASTER</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                        <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="n">quorum</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">switch</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nl">EBUSY</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;Duplicated master name.&quot;</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">ENOENT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;Can&#39;t resolve master instance hostname.&quot;</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">EINVAL</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;Invalid port number&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="c1">// SENTINEL down-after-milliseconds 选项</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;down-after-milliseconds&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* down-after-milliseconds &lt;name&gt; &lt;milliseconds&gt; */</span>

        <span class="c1">// 查找主服务器</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByName</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;No such master with specified name.&quot;</span><span class="p">;</span>

        <span class="c1">// 设置选项</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">down_after_period</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">down_after_period</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&quot;negative or zero time parameter.&quot;</span><span class="p">;</span>

    <span class="c1">// SENTINEL failover-timeout 选项</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;failover-timeout&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* failover-timeout &lt;name&gt; &lt;milliseconds&gt; */</span>

        <span class="c1">// 查找主服务器</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByName</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;No such master with specified name.&quot;</span><span class="p">;</span>

        <span class="c1">// 设置选项</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_timeout</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&quot;negative or zero time parameter.&quot;</span><span class="p">;</span>

   <span class="c1">// Sentinel parallel-syncs 选项</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;parallel-syncs&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* parallel-syncs &lt;name&gt; &lt;milliseconds&gt; */</span>

        <span class="c1">// 查找主服务器</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByName</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;No such master with specified name.&quot;</span><span class="p">;</span>

        <span class="c1">// 设置选项</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">parallel_syncs</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="c1">// SENTINEL notification-script 选项</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;notification-script&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* notification-script &lt;name&gt; &lt;path&gt; */</span>
        
        <span class="c1">// 查找主服务器</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByName</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;No such master with specified name.&quot;</span><span class="p">;</span>

        <span class="c1">// 检查给定路径所指向的文件是否存在，以及是否可执行</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">X_OK</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&quot;Notification script seems non existing or non executable.&quot;</span><span class="p">;</span>

        <span class="c1">// 设置选项</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">notification_script</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="c1">// SENTINEL client-reconfig-script 选项</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;client-reconfig-script&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* client-reconfig-script &lt;name&gt; &lt;path&gt; */</span>

        <span class="c1">// 查找主服务器</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByName</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;No such master with specified name.&quot;</span><span class="p">;</span>
        <span class="c1">// 检查给定路径所指向的文件是否存在，以及是否可执行</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">X_OK</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&quot;Client reconfiguration script seems non existing or &quot;</span>
                   <span class="s">&quot;non executable.&quot;</span><span class="p">;</span>

        <span class="c1">// 设置选项</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">client_reconfig_script</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="c1">// 设置 SENTINEL auth-pass 选项</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;auth-pass&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* auth-pass &lt;name&gt; &lt;password&gt; */</span>

        <span class="c1">// 查找主服务器</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByName</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;No such master with specified name.&quot;</span><span class="p">;</span>

        <span class="c1">// 设置选项</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">auth_pass</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="c1">// SENTINEL config-epoch 选项</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;config-epoch&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* config-epoch &lt;name&gt; &lt;epoch&gt; */</span>

        <span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByName</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;No such master with specified name.&quot;</span><span class="p">;</span>

        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">config_epoch</span> <span class="o">=</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">config_epoch</span> <span class="o">&gt;</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span><span class="p">)</span>
            <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">config_epoch</span><span class="p">;</span>

    <span class="c1">// SENTINEL known-slave 选项</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;known-slave&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">slave</span><span class="p">;</span>

        <span class="cm">/* known-slave &lt;name&gt; &lt;ip&gt; &lt;port&gt; */</span>

        <span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByName</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;No such master with specified name.&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">slave</span> <span class="o">=</span> <span class="n">createSentinelRedisInstance</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">SRI_SLAVE</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">quorum</span><span class="p">,</span> <span class="n">ri</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;Wrong hostname or port for slave.&quot;</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="c1">// SENTINEL known-sentinel 选项</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;known-sentinel&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
               <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">si</span><span class="p">;</span>

        <span class="cm">/* known-sentinel &lt;name&gt; &lt;ip&gt; &lt;port&gt; [runid] */</span>

        <span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByName</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;No such master with specified name.&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">si</span> <span class="o">=</span> <span class="n">createSentinelRedisInstance</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">SRI_SENTINEL</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">quorum</span><span class="p">,</span> <span class="n">ri</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;Wrong hostname or port for sentinel.&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">runid</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Unrecognized sentinel configuration statement.&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Implements CONFIG REWRITE for &quot;sentinel&quot; option.</span>
<span class="cm"> * This is used not just to rewrite the configuration given by the user</span>
<span class="cm"> * (the configured masters) but also in order to retain the state of</span>
<span class="cm"> * Sentinel across restarts: config epoch of masters, associated slaves</span>
<span class="cm"> * and sentinel instances, and so forth. */</span>
<span class="c1">// CONFIG REWIRTE 命令中和 sentinel 选项有关的部分</span>
<span class="c1">// 这个函数不仅用于用户执行 CONFIG REWRITE 的时候，</span>
<span class="c1">// 也用于保存 Sentinel 状态，以备 Sentinel 重启时载入状态使用</span>
<span class="kt">void</span> <span class="nf">rewriteConfigSentinelOption</span><span class="p">(</span><span class="k">struct</span> <span class="n">rewriteConfigState</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="o">*</span><span class="n">di2</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>

    <span class="cm">/* For every master emit a &quot;sentinel monitor&quot; config entry. */</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">masters</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>
        <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">master_addr</span><span class="p">;</span>
        <span class="n">sds</span> <span class="n">line</span><span class="p">;</span>

        <span class="cm">/* sentinel monitor */</span>
        <span class="n">master</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
        <span class="n">master_addr</span> <span class="o">=</span> <span class="n">sentinelGetCurrentMasterAddress</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span><span class="s">&quot;sentinel monitor %s %s %d %d&quot;</span><span class="p">,</span>
            <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">master_addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">master_addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
            <span class="n">master</span><span class="o">-&gt;</span><span class="n">quorum</span><span class="p">);</span>
        <span class="n">rewriteConfigRewriteLine</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="s">&quot;sentinel&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

        <span class="cm">/* sentinel down-after-milliseconds */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">down_after_period</span> <span class="o">!=</span> <span class="n">SENTINEL_DEFAULT_DOWN_AFTER</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span>
                <span class="s">&quot;sentinel down-after-milliseconds %s %ld&quot;</span><span class="p">,</span>
                <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">down_after_period</span><span class="p">);</span>
            <span class="n">rewriteConfigRewriteLine</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="s">&quot;sentinel&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* sentinel failover-timeout */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_timeout</span> <span class="o">!=</span> <span class="n">SENTINEL_DEFAULT_FAILOVER_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span>
                <span class="s">&quot;sentinel failover-timeout %s %ld&quot;</span><span class="p">,</span>
                <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_timeout</span><span class="p">);</span>
            <span class="n">rewriteConfigRewriteLine</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="s">&quot;sentinel&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* sentinel parallel-syncs */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">parallel_syncs</span> <span class="o">!=</span> <span class="n">SENTINEL_DEFAULT_PARALLEL_SYNCS</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span>
                <span class="s">&quot;sentinel parallel-syncs %s %d&quot;</span><span class="p">,</span>
                <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">parallel_syncs</span><span class="p">);</span>
            <span class="n">rewriteConfigRewriteLine</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="s">&quot;sentinel&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* sentinel notification-script */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">notification_script</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span>
                <span class="s">&quot;sentinel notification-script %s %s&quot;</span><span class="p">,</span>
                <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">notification_script</span><span class="p">);</span>
            <span class="n">rewriteConfigRewriteLine</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="s">&quot;sentinel&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* sentinel client-reconfig-script */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">client_reconfig_script</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span>
                <span class="s">&quot;sentinel client-reconfig-script %s %s&quot;</span><span class="p">,</span>
                <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">client_reconfig_script</span><span class="p">);</span>
            <span class="n">rewriteConfigRewriteLine</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="s">&quot;sentinel&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* sentinel auth-pass */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">auth_pass</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span>
                <span class="s">&quot;sentinel auth-pass %s %s&quot;</span><span class="p">,</span>
                <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">auth_pass</span><span class="p">);</span>
            <span class="n">rewriteConfigRewriteLine</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="s">&quot;sentinel&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* sentinel config-epoch */</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span>
            <span class="s">&quot;sentinel config-epoch %s %llu&quot;</span><span class="p">,</span>
            <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">config_epoch</span><span class="p">);</span>
        <span class="n">rewriteConfigRewriteLine</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="s">&quot;sentinel&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

        <span class="cm">/* sentinel known-slave */</span>
        <span class="n">di2</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">);</span>
        <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di2</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">slave_addr</span><span class="p">;</span>

            <span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
            <span class="n">slave_addr</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

            <span class="cm">/* If master_addr (obtained using sentinelGetCurrentMasterAddress()</span>
<span class="cm">             * so it may be the address of the promoted slave) is equal to this</span>
<span class="cm">             * slave&#39;s address, a failover is in progress and the slave was</span>
<span class="cm">             * already successfully promoted. So as the address of this slave</span>
<span class="cm">             * we use the old master address instead. */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sentinelAddrIsEqual</span><span class="p">(</span><span class="n">slave_addr</span><span class="p">,</span><span class="n">master_addr</span><span class="p">))</span>
                <span class="n">slave_addr</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span>
                <span class="s">&quot;sentinel known-slave %s %s %d&quot;</span><span class="p">,</span>
                <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
            <span class="n">rewriteConfigRewriteLine</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="s">&quot;sentinel&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di2</span><span class="p">);</span>

        <span class="cm">/* sentinel known-sentinel */</span>
        <span class="n">di2</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">);</span>
        <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di2</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span>
                <span class="s">&quot;sentinel known-sentinel %s %s %d%s%s&quot;</span><span class="p">,</span>
                <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span> <span class="o">?</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="nl">runid</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
            <span class="n">rewriteConfigRewriteLine</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="s">&quot;sentinel&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function uses the config rewriting Redis engine in order to persist</span>
<span class="cm"> * the state of the Sentinel in the current configuration file.</span>
<span class="cm"> *</span>
<span class="cm"> * 使用 CONFIG REWRITE 功能，将当前 Sentinel 的状态持久化到配置文件里面。</span>
<span class="cm"> *</span>
<span class="cm"> * Before returning the function calls fsync() against the generated</span>
<span class="cm"> * configuration file to make sure changes are committed to disk.</span>
<span class="cm"> *</span>
<span class="cm"> * 在函数返回之前，程序会调用一次 fsync() ，确保文件已经被保存到磁盘里面。</span>
<span class="cm"> *</span>
<span class="cm"> * On failure the function logs a warning on the Redis log. </span>
<span class="cm"> *</span>
<span class="cm"> * 如果保存失败，那么打印一条警告日志。</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sentinelFlushConfig</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rewriteConfig</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">configfile</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">redisLog</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;WARNING: Senitnel was not able to save the new configuration on disk!!!: %s&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">configfile</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fsync</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ====================== hiredis connection handling ======================= */</span>

<span class="cm">/* Completely disconnect an hiredis link from an instance. */</span>
<span class="c1">// 断开实例的连接</span>
<span class="kt">void</span> <span class="nf">sentinelKillLink</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// 打开断线标志</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_DISCONNECTED</span><span class="p">;</span>

    <span class="c1">// 断开连接</span>
    <span class="n">redisAsyncFree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function takes an hiredis context that is in an error condition</span>
<span class="cm"> * and make sure to mark the instance as disconnected performing the</span>
<span class="cm"> * cleanup needed.</span>
<span class="cm"> *</span>
<span class="cm"> * 函数将一个出错连接设置正确的断线标志，并执行清理操作</span>
<span class="cm"> *</span>
<span class="cm"> * Note: we don&#39;t free the hiredis context as hiredis will do it for us</span>
<span class="cm"> * for async connections. </span>
<span class="cm"> *</span>
<span class="cm"> * 这个函数没有手动释放连接，因为异步连接会自动释放</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sentinelDisconnectInstanceFromContext</span><span class="p">(</span><span class="k">const</span> <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">pubsub</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="cm">/* The instance no longer exists. */</span>

    <span class="c1">// 发送断线事件</span>
    <span class="n">pubsub</span> <span class="o">=</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="n">c</span><span class="p">);</span>
    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_DEBUG</span><span class="p">,</span> <span class="n">pubsub</span> <span class="o">?</span> <span class="s">&quot;-pubsub-link&quot;</span> <span class="o">:</span> <span class="s">&quot;-cmd-link&quot;</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span>
        <span class="s">&quot;%@ #%s&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pubsub</span><span class="p">)</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// 打开标志</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_DISCONNECTED</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 异步连接的连接回调函数</span>
<span class="kt">void</span> <span class="nf">sentinelLinkEstablishedCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelDisconnectInstanceFromContext</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pubsub</span> <span class="o">=</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="n">c</span><span class="p">);</span>

        <span class="c1">// 发送连接事件</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_DEBUG</span><span class="p">,</span> <span class="n">pubsub</span> <span class="o">?</span> <span class="s">&quot;+pubsub-link&quot;</span> <span class="o">:</span> <span class="s">&quot;+cmd-link&quot;</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span>
            <span class="s">&quot;%@&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 异步连接的断线回调函数</span>
<span class="kt">void</span> <span class="nf">sentinelDisconnectCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelDisconnectInstanceFromContext</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send the AUTH command with the specified master password if needed.</span>
<span class="cm"> * Note that for slaves the password set for the master is used.</span>
<span class="cm"> *</span>
<span class="cm"> * 如果 sentinel 设置了 auth-pass 选项，那么向主服务器或者从服务器发送验证密码。</span>
<span class="cm"> * 注意从服务器使用的是主服务器的密码。</span>
<span class="cm"> *</span>
<span class="cm"> * We don&#39;t check at all if the command was successfully transmitted</span>
<span class="cm"> * to the instance as if it fails Sentinel will detect the instance down,</span>
<span class="cm"> * will disconnect and reconnect the link and so forth. </span>
<span class="cm"> *</span>
<span class="cm"> * 函数不检查命令是否被成功发送，因为如果目标服务器掉线了的话， sentinel 会识别到，</span>
<span class="cm"> * 并对它进行重连接，然后又重新发送 AUTH 命令。</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sentinelSendAuthIfNeeded</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 如果 ri 是主服务器，那么使用实例自己的密码</span>
    <span class="c1">// 如果 ri 是从服务器，那么使用主服务器的密码</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">auth_pass</span> <span class="o">=</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="o">?</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="nl">auth_pass</span> <span class="p">:</span>
                                                 <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">auth_pass</span><span class="p">;</span>

    <span class="c1">// 发送 AUTH 命令</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">auth_pass</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">redisAsyncCommand</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">sentinelDiscardReplyCallback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AUTH %s&quot;</span><span class="p">,</span>
            <span class="n">auth_pass</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Create the async connections for the specified instance if the instance</span>
<span class="cm"> * is disconnected. Note that the SRI_DISCONNECTED flag is set even if just</span>
<span class="cm"> * one of the two links (commands and pub/sub) is missing. */</span>
<span class="c1">// 如果 sentinel 与实例处于断线（未连接）状态，那么创建连向实例的异步连接。</span>
<span class="kt">void</span> <span class="nf">sentinelReconnectInstance</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 示例未断线（已连接），返回</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_DISCONNECTED</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

    <span class="cm">/* Commands connection. */</span>
    <span class="c1">// 对所有实例创建一个用于发送 Redis 命令的连接</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 连接实例</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">=</span> <span class="n">redisAsyncConnect</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

        <span class="c1">// 连接出错</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_DEBUG</span><span class="p">,</span><span class="s">&quot;-cmd-link-reconnection&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@ #%s&quot;</span><span class="p">,</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
            <span class="n">sentinelKillLink</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">);</span>

        <span class="c1">// 连接成功</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// 设置连接属性</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc_conn_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ri</span><span class="p">;</span>
            <span class="n">redisAeAttach</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">);</span>
            <span class="c1">// 设置连线 callback</span>
            <span class="n">redisAsyncSetConnectCallback</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">,</span>
                                            <span class="n">sentinelLinkEstablishedCallback</span><span class="p">);</span>
            <span class="c1">// 设置断线 callback</span>
            <span class="n">redisAsyncSetDisconnectCallback</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">,</span>
                                            <span class="n">sentinelDisconnectCallback</span><span class="p">);</span>
            <span class="c1">// 发送 AUTH 命令，验证身份</span>
            <span class="n">sentinelSendAuthIfNeeded</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Pub / Sub */</span>
    <span class="c1">// 对主服务器和从服务器，创建一个用于订阅频道的连接</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_MASTER</span><span class="o">|</span><span class="n">SRI_SLAVE</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 连接实例</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">redisAsyncConnect</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

        <span class="c1">// 连接出错</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_DEBUG</span><span class="p">,</span><span class="s">&quot;-pubsub-link-reconnection&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@ #%s&quot;</span><span class="p">,</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
            <span class="n">sentinelKillLink</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>

        <span class="c1">// 连接成功</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

            <span class="c1">// 设置连接属性</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc_conn_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ri</span><span class="p">;</span>
            <span class="n">redisAeAttach</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
            <span class="c1">// 设置连接 callback</span>
            <span class="n">redisAsyncSetConnectCallback</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span>
                                            <span class="n">sentinelLinkEstablishedCallback</span><span class="p">);</span>
            <span class="c1">// 设置断线 callback</span>
            <span class="n">redisAsyncSetDisconnectCallback</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span>
                                            <span class="n">sentinelDisconnectCallback</span><span class="p">);</span>
            <span class="c1">// 发送 AUTH 命令，验证身份</span>
            <span class="n">sentinelSendAuthIfNeeded</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>

            <span class="cm">/* Now we subscribe to the Sentinels &quot;Hello&quot; channel. */</span>
            <span class="c1">// 发送 SUBSCRIBE __sentinel__:hello 命令，订阅频道</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">redisAsyncCommand</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span>
                <span class="n">sentinelReceiveHelloMessages</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;SUBSCRIBE %s&quot;</span><span class="p">,</span>
                    <span class="n">SENTINEL_HELLO_CHANNEL</span><span class="p">);</span>
            
            <span class="c1">// 订阅出错，断开连接</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* If we can&#39;t subscribe, the Pub/Sub connection is useless</span>
<span class="cm">                 * and we can simply disconnect it and try again. */</span>
                <span class="n">sentinelKillLink</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Clear the DISCONNECTED flags only if we have both the connections</span>
<span class="cm">     * (or just the commands connection if this is a slave or a</span>
<span class="cm">     * sentinel instance). */</span>
    <span class="c1">// 如果实例是主服务器或者从服务器，那么当 cc 和 pc 两个连接都创建成功时，关闭 DISCONNECTED 标识</span>
    <span class="c1">// 如果实例是 Sentinel ，那么当 cc 连接创建成功时，关闭 DISCONNECTED 标识</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_SLAVE</span><span class="o">|</span><span class="n">SRI_SENTINEL</span><span class="p">)</span> <span class="o">||</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">))</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRI_DISCONNECTED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ======================== Redis instances pinging  ======================== */</span>

<span class="cm">/* Return true if master looks &quot;sane&quot;, that is:</span>
<span class="cm"> *</span>
<span class="cm"> * 如果主服务器看上去是合理（sane），那么返回真。判断是否合理的条件如下：</span>
<span class="cm"> *</span>
<span class="cm"> * 1) It is actually a master in the current configuration.</span>
<span class="cm"> *    它在当前配置中的角色为主服务器</span>
<span class="cm"> * 2) It reports itself as a master.</span>
<span class="cm"> *    它报告自己是一个主服务器</span>
<span class="cm"> * 3) It is not SDOWN or ODOWN.</span>
<span class="cm"> *    这个主服务器不处于 SDOWN 或者 ODOWN 状态</span>
<span class="cm"> * 4) We obtained last INFO no more than two times the INFO period time ago. </span>
<span class="cm"> *    主服务器最近一次刷新 INFO 信息距离现在不超过 SENTINEL_INFO_PERIOD 的两倍时间</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sentinelMasterLooksSane</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span> <span class="o">&amp;&amp;</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">role_reported</span> <span class="o">==</span> <span class="n">SRI_MASTER</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_S_DOWN</span><span class="o">|</span><span class="n">SRI_O_DOWN</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">info_refresh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SENTINEL_INFO_PERIOD</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Process the INFO output from masters. */</span>
<span class="c1">// 从主服务器或者从服务器所返回的 INFO 命令的回复中分析相关信息</span>
<span class="c1">// （上面的英文注释错了，这个函数不仅处理主服务器的 INFO 回复，还处理从服务器的 INFO 回复）</span>
<span class="kt">void</span> <span class="nf">sentinelRefreshInstanceInfo</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sds</span> <span class="o">*</span><span class="n">lines</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">numlines</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">role</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">runid_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* true if runid changed. */</span>
    <span class="kt">int</span> <span class="n">first_runid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* true if this is the first runid we receive. */</span>

    <span class="cm">/* The following fields must be reset to a given value in the case they</span>
<span class="cm">     * are not found at all in the INFO output. */</span>
    <span class="c1">// 将该变量重置为 0 ，避免 INFO 回复中无该值的情况</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master_link_down_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Process line by line. */</span>
    <span class="c1">// 对 INFO 命令的回复进行逐行分析</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">sdssplitlen</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">info</span><span class="p">),</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">numlines</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numlines</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">slave</span><span class="p">;</span>
        <span class="n">sds</span> <span class="n">l</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

        <span class="cm">/* run_id:&lt;40 hex chars&gt;*/</span>
        <span class="c1">// 读取并分析 runid</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sdslen</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">47</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;run_id:&quot;</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span> <span class="p">{</span>

            <span class="c1">// 新设置 runid</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span> <span class="o">=</span> <span class="n">sdsnewlen</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span><span class="mi">40</span><span class="p">);</span>
                <span class="c1">// 标记这是新设置的 runid</span>
                <span class="n">first_runid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="c1">// 更新 runid</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span><span class="p">,</span><span class="n">l</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

                    <span class="c1">// 标记 runid 已改变</span>
                    <span class="n">runid_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                    <span class="c1">// 发送重启事件</span>
                    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;+reboot&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>

                    <span class="c1">// 释放旧 ID ，设置新 ID</span>
                    <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span><span class="p">);</span>
                    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span> <span class="o">=</span> <span class="n">sdsnewlen</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span><span class="mi">40</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// 读取从服务器的 ip 和端口号</span>
        <span class="cm">/* old versions: slave0:&lt;ip&gt;,&lt;port&gt;,&lt;state&gt;</span>
<span class="cm">         * new versions: slave0:ip=127.0.0.1,port=9999,... */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">sdslen</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;slave&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isdigit</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
        <span class="p">{</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;ip=&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* Old format. */</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="sc">&#39;:&#39;</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                <span class="n">ip</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* Now ip points to start of ip address. */</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="sc">&#39;,&#39;</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* nul term for easy access. */</span>
                <span class="n">port</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* Now port points to start of port number. */</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="sc">&#39;,&#39;</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">end</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* nul term for easy access. */</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="cm">/* New format. */</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;ip=&quot;</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                <span class="n">ip</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Now ip points to start of ip address. */</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;port=&quot;</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                <span class="n">port</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* Now port points to start of port number. */</span>
                <span class="cm">/* Nul term both fields for easy access. */</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="sc">&#39;,&#39;</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="sc">&#39;,&#39;</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="cm">/* Check if we already have this slave into our table,</span>
<span class="cm">             * otherwise add it. */</span>
            <span class="c1">// 如果发现有新的从服务器出现，那么为它添加实例</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sentinelRedisInstanceLookupSlave</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">atoi</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">slave</span> <span class="o">=</span> <span class="n">createSentinelRedisInstance</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">SRI_SLAVE</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span>
                            <span class="n">atoi</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">quorum</span><span class="p">,</span> <span class="n">ri</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;+slave&quot;</span><span class="p">,</span><span class="n">slave</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/* master_link_down_since_seconds:&lt;seconds&gt; */</span>
        <span class="c1">// 读取主从服务器的断线时长</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sdslen</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;master_link_down_since_seconds&quot;</span><span class="p">,</span><span class="mi">30</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master_link_down_time</span> <span class="o">=</span> <span class="n">strtoll</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">31</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* role:&lt;role&gt; */</span>
        <span class="c1">// 读取实例的角色</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;role:master&quot;</span><span class="p">,</span><span class="mi">11</span><span class="p">))</span> <span class="n">role</span> <span class="o">=</span> <span class="n">SRI_MASTER</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;role:slave&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span> <span class="n">role</span> <span class="o">=</span> <span class="n">SRI_SLAVE</span><span class="p">;</span>

        <span class="c1">// 处理从服务器</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="p">{</span>

            <span class="cm">/* master_host:&lt;host&gt; */</span>
            <span class="c1">// 读入主服务器的 IP</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sdslen</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;master_host:&quot;</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
                    <span class="n">strcasecmp</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span><span class="p">);</span>
                    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">12</span><span class="p">);</span>
                    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_conf_change_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="cm">/* master_port:&lt;port&gt; */</span>
            <span class="c1">// 读入主服务器的端口号</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sdslen</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;master_port:&quot;</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">slave_master_port</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">12</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_port</span> <span class="o">!=</span> <span class="n">slave_master_port</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_port</span> <span class="o">=</span> <span class="n">slave_master_port</span><span class="p">;</span>
                    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_conf_change_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="cm">/* master_link_status:&lt;status&gt; */</span>
            <span class="c1">// 读入主服务器的状态</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sdslen</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">19</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;master_link_status:&quot;</span><span class="p">,</span><span class="mi">19</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_link_status</span> <span class="o">=</span>
                    <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">19</span><span class="p">,</span><span class="s">&quot;up&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
                    <span class="nl">SENTINEL_MASTER_LINK_STATUS_UP</span> <span class="p">:</span>
                    <span class="n">SENTINEL_MASTER_LINK_STATUS_DOWN</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="cm">/* slave_priority:&lt;priority&gt; */</span>
            <span class="c1">// 读入从服务器的优先级</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sdslen</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;slave_priority:&quot;</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_priority</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">15</span><span class="p">);</span>

            <span class="cm">/* slave_repl_offset:&lt;offset&gt; */</span>
            <span class="c1">// 读入从服务器的复制偏移量</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sdslen</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">18</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="s">&quot;slave_repl_offset:&quot;</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_repl_offset</span> <span class="o">=</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">18</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 更新刷新 INFO 命令回复的时间</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">info_refresh</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="n">sdsfreesplitres</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">numlines</span><span class="p">);</span>

    <span class="cm">/* ---------------------------- Acting half -----------------------------</span>
<span class="cm">     * Some things will not happen if sentinel.tilt is true, but some will</span>
<span class="cm">     * still be processed. </span>
<span class="cm">     *</span>
<span class="cm">     * 如果 sentinel 进入了 TILT 模式，那么可能只有一部分动作会被执行</span>
<span class="cm">     */</span>

    <span class="cm">/* Handle master -&gt; slave role switch. */</span>
    <span class="c1">// 实例被 Sentinel 标识为主服务器，但根据 INFO 命令的回复</span>
    <span class="c1">// 这个实例的身份为从服务器</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">role</span> <span class="o">==</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 这是实例第一次通过 INFO 回复报告自己是一个从服务器</span>
        <span class="c1">// 更新相关属性</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported</span> <span class="o">!=</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 报告时间</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
            <span class="c1">// 报告的身份</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported</span> <span class="o">=</span> <span class="n">SRI_SLAVE</span><span class="p">;</span>
            <span class="c1">// 身份改变时间</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_conf_change_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Handle slave -&gt; master role switch. */</span>
    <span class="c1">// 处理从服务器转变为主服务器的情况</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">role</span> <span class="o">==</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 这是实例第一次通过 INFO 回复报告自己是一个主服务器</span>
        <span class="c1">// 更新相关属性</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported</span> <span class="o">!=</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported</span> <span class="o">=</span> <span class="n">SRI_MASTER</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* If this is a promoted slave we can change state to the</span>
<span class="cm">         * failover state machine. */</span>
        <span class="c1">// 如果这是被选中升级为新主服务器的从服务器</span>
        <span class="c1">// 那么更新相关的故障转移属性</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sentinel</span><span class="p">.</span><span class="n">tilt</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">==</span>
                <span class="n">SENTINEL_FAILOVER_STATE_WAIT_PROMOTION</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="cm">/* Now that we are sure the slave was reconfigured as a master</span>
<span class="cm">             * set the master configuration epoch to the epoch we won the</span>
<span class="cm">             * election to perform this failover. This will force the other</span>
<span class="cm">             * Sentinels to update their config (assuming there is not</span>
<span class="cm">             * a newer one already available). */</span>
            <span class="c1">// 这是一个被 Sentinel 发送 SLAVEOF no one 之后由从服务器变为主服务器的实例</span>
            <span class="c1">// 将这个新主服务器的配置纪元设置为 Sentinel 赢得领头选举的纪元</span>
            <span class="c1">// 这一操作会强制其他 Sentinel 更新它们自己的配置</span>
            <span class="c1">// （假设没有一个更新的纪元存在的话）</span>
            <span class="c1">// 更新从服务器的主服务器（已下线）的配置纪元</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">config_epoch</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_epoch</span><span class="p">;</span>
            <span class="c1">// 设置从服务器的主服务器（已下线）的故障转移状态</span>
            <span class="c1">// 这个状态会让从服务器开始同步新的主服务器</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">=</span> <span class="n">SENTINEL_FAILOVER_STATE_RECONF_SLAVES</span><span class="p">;</span>
            <span class="c1">// 更新从服务器的主服务器（已下线）的故障转移状态变更时间</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
            <span class="c1">// 将当前 Sentinel 状态保存到配置文件里面</span>
            <span class="n">sentinelFlushConfig</span><span class="p">();</span>
            <span class="c1">// 发送事件</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+promoted-slave&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+failover-state-reconf-slaves&quot;</span><span class="p">,</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
            <span class="c1">// 执行脚本</span>
            <span class="n">sentinelCallClientReconfScript</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span><span class="n">SENTINEL_LEADER</span><span class="p">,</span>
                <span class="s">&quot;start&quot;</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

        <span class="c1">// 这个实例由从服务器变为了主服务器，并且没有进入 TILT 模式</span>
        <span class="c1">// （可能是因为重启造成的）</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sentinel</span><span class="p">.</span><span class="n">tilt</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* A slave turned into a master. We want to force our view and</span>
<span class="cm">             * reconfigure as slave. Wait some time after the change before</span>
<span class="cm">             * going forward, to receive new configs if any. */</span>
            <span class="c1">// 如果一个从服务器变为了主服务器，那么我们会考虑将它变回一个从服务器</span>

            <span class="c1">// 将 PUBLISH 命令的发送时间乘以 4 ，给于一定缓冲时间</span>
            <span class="kt">mstime_t</span> <span class="n">wait_time</span> <span class="o">=</span> <span class="n">SENTINEL_PUBLISH_PERIOD</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>

            <span class="c1">// 如果这个实例的主服务器运作正常</span>
            <span class="c1">// 并且实例在一段时间内没有进入过 SDOWN 状态或者 ODOWN 状态</span>
            <span class="c1">// 并且实例报告它是主服务器的时间已经超过 wait_time</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sentinelMasterLooksSane</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
               <span class="n">sentinelRedisInstanceNoDownFor</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">wait_time</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
               <span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported_time</span> <span class="o">&gt;</span> <span class="n">wait_time</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// 重新将实例设置为从服务器</span>
                <span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">sentinelSendSlaveOf</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span>
                        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
                        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
                
                <span class="c1">// 发送 demote 事件</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">REDIS_OK</span><span class="p">)</span>
                    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;+convert-to-slave&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Handle slaves replicating to a different master address. */</span>
    <span class="c1">// 让从服务器重新复制回正确的主服务器</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sentinel</span><span class="p">.</span><span class="n">tilt</span> <span class="o">&amp;&amp;</span>
        <span class="n">role</span> <span class="o">==</span> <span class="n">SRI_SLAVE</span> <span class="o">&amp;&amp;</span>
        <span class="c1">// 从服务器现在的主服务器地址和 Sentinel 保存的信息不一致</span>
        <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_port</span> <span class="o">!=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">||</span>
         <span class="n">strcasecmp</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">)))</span>
    <span class="p">{</span>
        <span class="kt">mstime_t</span> <span class="n">wait_time</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_timeout</span><span class="p">;</span>

        <span class="cm">/* Make sure the master is sane before reconfiguring this instance</span>
<span class="cm">         * into a slave. */</span>
        <span class="c1">// 1) 检查实例的主服务器状态是否正常</span>
        <span class="c1">// 2) 检查实例在给定时间内是否进入过 SDOWN 或者 ODOWN 状态</span>
        <span class="c1">// 3) 检查实例身份变更的时长是否已经超过了指定时长</span>
        <span class="c1">// 如果是的话，执行代码。。。</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sentinelMasterLooksSane</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">sentinelRedisInstanceNoDownFor</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">wait_time</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_conf_change_time</span> <span class="o">&gt;</span> <span class="n">wait_time</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 重新将实例指向原本的主服务器</span>
            <span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">sentinelSendSlaveOf</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span>
                    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
                    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">REDIS_OK</span><span class="p">)</span>
                <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;+fix-slave-config&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* None of the following conditions are processed when in tilt mode, so</span>
<span class="cm">     * return asap. */</span>
    <span class="c1">// 以下动作都不能在 TILT 模式下执行</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">tilt</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="cm">/* Detect if the slave that is in the process of being reconfigured</span>
<span class="cm">     * changed state. */</span>
    <span class="c1">// Sentinel 监视的实例为从服务器，并且已经向它发送 SLAVEOF 命令</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">role</span> <span class="o">==</span> <span class="n">SRI_SLAVE</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_RECONF_SENT</span><span class="o">|</span><span class="n">SRI_RECONF_INPROG</span><span class="p">)))</span>
    <span class="p">{</span>
        <span class="cm">/* SRI_RECONF_SENT -&gt; SRI_RECONF_INPROG. */</span>
        <span class="c1">// 将 SENT 状态改为 INPROG 状态，表示同步正在进行</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_RECONF_SENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span> <span class="o">&amp;&amp;</span>
            <span class="n">strcmp</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span><span class="p">,</span>
                    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_port</span> <span class="o">==</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRI_RECONF_SENT</span><span class="p">;</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_RECONF_INPROG</span><span class="p">;</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;+slave-reconf-inprog&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* SRI_RECONF_INPROG -&gt; SRI_RECONF_DONE */</span>
        <span class="c1">// 将 INPROG 状态改为 DONE 状态，表示同步已完成</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_RECONF_INPROG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_link_status</span> <span class="o">==</span> <span class="n">SENTINEL_MASTER_LINK_STATUS_UP</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRI_RECONF_INPROG</span><span class="p">;</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_RECONF_DONE</span><span class="p">;</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;+slave-reconf-done&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 处理 INFO 命令的回复</span>
<span class="kt">void</span> <span class="nf">sentinelInfoReplyCallback</span><span class="p">(</span><span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="n">redisReply</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">--</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span> <span class="o">||</span> <span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">reply</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_STRING</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRefreshInstanceInfo</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Just discard the reply. We use this when we are not monitoring the return</span>
<span class="cm"> * value of the command but its effects directly. */</span>
<span class="c1">// 这个回调函数用于处理不需要检查回复的命令（只使用命令的副作用）</span>
<span class="kt">void</span> <span class="nf">sentinelDiscardReplyCallback</span><span class="p">(</span><span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 处理 PING 命令的回复</span>
<span class="kt">void</span> <span class="nf">sentinelPingReplyCallback</span><span class="p">(</span><span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="n">redisReply</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">--</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span> <span class="o">||</span> <span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">reply</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_STATUS</span> <span class="o">||</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_ERROR</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* Update the &quot;instance available&quot; field only if this is an</span>
<span class="cm">         * acceptable reply. */</span>
        <span class="c1">// 只在实例返回 acceptable 回复时更新 last_avail_time</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span><span class="s">&quot;PONG&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
            <span class="n">strncmp</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span><span class="s">&quot;LOADING&quot;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
            <span class="n">strncmp</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span><span class="s">&quot;MASTERDOWN&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 实例运作正常</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_avail_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

            <span class="c1">// 实例运作不正常</span>

            <span class="cm">/* Send a SCRIPT KILL command if the instance appears to be</span>
<span class="cm">             * down because of a busy script. */</span>
            <span class="c1">// 如果服务器因为执行脚本而进入 BUSY 状态，</span>
            <span class="c1">// 那么尝试通过发送 SCRIPT KILL 来恢复服务器</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span><span class="s">&quot;BUSY&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SCRIPT_KILL_SENT</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">redisAsyncCommand</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">,</span>
                        <span class="n">sentinelDiscardReplyCallback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
                        <span class="s">&quot;SCRIPT KILL&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDIS_OK</span><span class="p">)</span>
                    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">++</span><span class="p">;</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_SCRIPT_KILL_SENT</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 更新实例最后一次回复 PING 命令的时间</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_pong_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* This is called when we get the reply about the PUBLISH command we send</span>
<span class="cm"> * to the master to advertise this sentinel. */</span>
<span class="c1">// 处理 PUBLISH 命令的回复</span>
<span class="kt">void</span> <span class="nf">sentinelPublishReplyCallback</span><span class="p">(</span><span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="n">redisReply</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">--</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span> <span class="o">||</span> <span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">reply</span><span class="p">;</span>

    <span class="cm">/* Only update pub_time if we actually published our message. Otherwise</span>
<span class="cm">     * we&#39;ll retry against in 100 milliseconds. */</span>
    <span class="c1">// 如果命令发送成功，那么更新 last_pub_time</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">REDIS_REPLY_ERROR</span><span class="p">)</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_pub_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* This is our Pub/Sub callback for the Hello channel. It&#39;s useful in order</span>
<span class="cm"> * to discover other sentinels attached at the same master. */</span>
<span class="c1">// 此回调函数用于处理 Hello 频道的返回值，它可以发现其他正在订阅统一主服务器的 sentinel</span>
<span class="kt">void</span> <span class="nf">sentinelReceiveHelloMessages</span><span class="p">(</span><span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
    <span class="n">redisReply</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span> <span class="o">||</span> <span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">reply</span><span class="p">;</span>

    <span class="n">master</span> <span class="o">=</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="o">?</span> <span class="nl">ri</span> <span class="p">:</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>

    <span class="cm">/* Update the last activity in the pubsub channel. Note that since we</span>
<span class="cm">     * receive our messages as well this timestamp can be used to detect</span>
<span class="cm">     * if the link is probably disconnected even if it seems otherwise. */</span>
    <span class="c1">// 更新最后一次接收频道命令的时间</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc_last_activity</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
   
    <span class="cm">/* Sanity check in the reply we expect, so that the code that follows</span>
<span class="cm">     * can avoid to check for details. */</span>
    <span class="c1">// 只处理频道发来的信息，不处理订阅时和退订时产生的信息</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">REDIS_REPLY_ARRAY</span> <span class="o">||</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">elements</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">||</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">REDIS_REPLY_STRING</span> <span class="o">||</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">REDIS_REPLY_STRING</span> <span class="o">||</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">REDIS_REPLY_STRING</span> <span class="o">||</span>
        <span class="n">strcmp</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span><span class="s">&quot;message&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="cm">/* We are not interested in meeting ourselves */</span>
    <span class="c1">// 只处理非自己发送的信息</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">runid</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="p">{</span>
        <span class="cm">/* Format is composed of 8 tokens:</span>
<span class="cm">         * 0=ip,1=port,2=runid,3=current_epoch,4=master_name,</span>
<span class="cm">         * 5=master_ip,6=master_port,7=master_config_epoch. */</span>
        <span class="kt">int</span> <span class="n">numtokens</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">removed</span><span class="p">,</span> <span class="n">master_port</span><span class="p">;</span>
        <span class="kt">uint64_t</span> <span class="n">current_epoch</span><span class="p">,</span> <span class="n">master_config_epoch</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">**</span><span class="n">token</span> <span class="o">=</span> <span class="n">sdssplitlen</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span>
                                   <span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
                                   <span class="s">&quot;,&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">numtokens</span><span class="p">);</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">si</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">numtokens</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* First, try to see if we already have this sentinel. */</span>

            <span class="c1">// 端口号</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            <span class="n">master_port</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
            <span class="n">si</span> <span class="o">=</span> <span class="n">getSentinelRedisInstanceByAddrAndRunID</span><span class="p">(</span>
                            <span class="n">master</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">,</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">port</span><span class="p">,</span><span class="n">token</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
            <span class="n">current_epoch</span> <span class="o">=</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
            <span class="n">master_config_epoch</span> <span class="o">=</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
            <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">msgmaster</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">si</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* If not, remove all the sentinels that have the same runid</span>
<span class="cm">                 * OR the same ip/port, because it&#39;s either a restart or a</span>
<span class="cm">                 * network topology change. */</span>
                <span class="n">removed</span> <span class="o">=</span> <span class="n">removeMatchingSentinelsFromMaster</span><span class="p">(</span><span class="n">master</span><span class="p">,</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">port</span><span class="p">,</span>
                                <span class="n">token</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                <span class="c1">// 发送移除 sentinel 实例事件</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">removed</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;-dup-sentinel&quot;</span><span class="p">,</span><span class="n">master</span><span class="p">,</span>
                        <span class="s">&quot;%@ #duplicate of %s:%d or %s&quot;</span><span class="p">,</span>
                        <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">port</span><span class="p">,</span><span class="n">token</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                <span class="p">}</span>

                <span class="cm">/* Add the new sentinel. */</span>
                <span class="n">si</span> <span class="o">=</span> <span class="n">createSentinelRedisInstance</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">SRI_SENTINEL</span><span class="p">,</span>
                                <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">port</span><span class="p">,</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">quorum</span><span class="p">,</span><span class="n">master</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;+sentinel&quot;</span><span class="p">,</span><span class="n">si</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
                    <span class="cm">/* The runid is NULL after a new instance creation and</span>
<span class="cm">                     * for Sentinels we don&#39;t have a later chance to fill it,</span>
<span class="cm">                     * so do it now. */</span>
                    <span class="n">si</span><span class="o">-&gt;</span><span class="n">runid</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                    <span class="n">sentinelFlushConfig</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="cm">/* Update local current_epoch if received current_epoch is greater.*/</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">current_epoch</span> <span class="o">&gt;</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span> <span class="o">=</span> <span class="n">current_epoch</span><span class="p">;</span>
                <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+new-epoch&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%llu&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="cm">/* Update master info if received configuration is newer. */</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">msgmaster</span> <span class="o">=</span> <span class="n">sentinelGetMasterByName</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">msgmaster</span><span class="o">-&gt;</span><span class="n">config_epoch</span> <span class="o">&lt;</span> <span class="n">master_config_epoch</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">msgmaster</span><span class="o">-&gt;</span><span class="n">config_epoch</span> <span class="o">=</span> <span class="n">master_config_epoch</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">master_port</span> <span class="o">!=</span> <span class="n">msgmaster</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">||</span>
                        <span class="n">strcmp</span><span class="p">(</span><span class="n">msgmaster</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">token</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                    <span class="p">{</span>
                        <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">old_addr</span><span class="p">;</span>

                        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+switch-master&quot;</span><span class="p">,</span>
                            <span class="n">msgmaster</span><span class="p">,</span><span class="s">&quot;%s %s %d %s %d&quot;</span><span class="p">,</span>
                            <span class="n">msgmaster</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">msgmaster</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">msgmaster</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
                            <span class="n">token</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">master_port</span><span class="p">);</span>

                        <span class="n">old_addr</span> <span class="o">=</span> <span class="n">dupSentinelAddr</span><span class="p">(</span><span class="n">msgmaster</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
                        <span class="n">sentinelResetMasterAndChangeAddress</span><span class="p">(</span><span class="n">msgmaster</span><span class="p">,</span>
                                                    <span class="n">token</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">master_port</span><span class="p">);</span>
                        <span class="n">sentinelCallClientReconfScript</span><span class="p">(</span><span class="n">msgmaster</span><span class="p">,</span>
                            <span class="n">SENTINEL_OBSERVER</span><span class="p">,</span><span class="s">&quot;start&quot;</span><span class="p">,</span>
                            <span class="n">old_addr</span><span class="p">,</span><span class="n">msgmaster</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
                        <span class="n">releaseSentinelAddr</span><span class="p">(</span><span class="n">old_addr</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="cm">/* Update the state of the Sentinel. */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">last_hello_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">sdsfreesplitres</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="n">numtokens</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Send an &quot;Hello&quot; message via Pub/Sub to the specified &#39;ri&#39; Redis</span>
<span class="cm"> * instance in order to broadcast the current configuraiton for this</span>
<span class="cm"> * master, and to advertise the existence of this Sentinel at the same time.</span>
<span class="cm"> *</span>
<span class="cm"> * 向给定 ri 实例的频道发送信息，</span>
<span class="cm"> * 从而传播关于给定主服务器的配置，</span>
<span class="cm"> * 并向其他 Sentinel 宣告本 Sentinel 的存在。</span>
<span class="cm"> *</span>
<span class="cm"> * The message has the following format:</span>
<span class="cm"> *</span>
<span class="cm"> * 发送信息的格式如下： </span>
<span class="cm"> *</span>
<span class="cm"> * sentinel_ip,sentinel_port,sentinel_runid,current_epoch,</span>
<span class="cm"> * master_name,master_ip,master_port,master_config_epoch.</span>
<span class="cm"> *</span>
<span class="cm"> * Sentinel IP,Sentinel 端口号,Sentinel 的运行 ID,Sentinel 当前的纪元,</span>
<span class="cm"> * 主服务器的名称,主服务器的 IP,主服务器的端口号,主服务器的配置纪元.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns REDIS_OK if the PUBLISH was queued correctly, otherwise</span>
<span class="cm"> * REDIS_ERR is returned. </span>
<span class="cm"> *</span>
<span class="cm"> * PUBLISH 命令成功入队时返回 REDIS_OK ，</span>
<span class="cm"> * 否则返回 REDIS_ERR 。</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sentinelSendHello</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">ip</span><span class="p">[</span><span class="n">REDIS_IP_STR_LEN</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">payload</span><span class="p">[</span><span class="n">REDIS_IP_STR_LEN</span><span class="o">+</span><span class="mi">1024</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

    <span class="c1">// 如果实例是主服务器，那么使用此实例的信息</span>
    <span class="c1">// 如果实例是从服务器，那么使用这个从服务器的主服务器的信息</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="o">?</span> <span class="nl">ri</span> <span class="p">:</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>

    <span class="c1">// 获取地址信息</span>
    <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">master_addr</span> <span class="o">=</span> <span class="n">sentinelGetCurrentMasterAddress</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

    <span class="cm">/* Try to obtain our own IP address. */</span>
    <span class="c1">// 获取实例自身的地址</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">anetSockName</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">fd</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ip</span><span class="p">),</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_DISCONNECTED</span><span class="p">)</span> <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>

    <span class="cm">/* Format and send the Hello message. */</span>
    <span class="c1">// 格式化信息</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span>
        <span class="s">&quot;%s,%d,%s,%llu,&quot;</span> <span class="cm">/* Info about this sentinel. */</span>
        <span class="s">&quot;%s,%s,%d,%llu&quot;</span><span class="p">,</span> <span class="cm">/* Info about current master. */</span>
        <span class="n">ip</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">runid</span><span class="p">,</span>
        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span><span class="p">,</span>
        <span class="cm">/* --- */</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">master_addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span><span class="n">master_addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">config_epoch</span><span class="p">);</span>
    
    <span class="c1">// 发送信息</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">redisAsyncCommand</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">,</span>
        <span class="n">sentinelPublishReplyCallback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;PUBLISH %s %s&quot;</span><span class="p">,</span>
            <span class="n">SENTINEL_HELLO_CHANNEL</span><span class="p">,</span><span class="n">payload</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>

    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">++</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">REDIS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 根据时间和实例类型等情况，向实例发送命令，比如 INFO 、PING 和 PUBLISH</span>
<span class="c1">// 虽然函数的名字包含 Ping ，但命令并不只发送 PING 命令</span>
<span class="cm">/* Send periodic PING, INFO, and PUBLISH to the Hello channel to</span>
<span class="cm"> * the specified master or slave instance. */</span>
<span class="kt">void</span> <span class="nf">sentinelPingInstance</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 当前时间</span>
    <span class="kt">mstime_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

    <span class="c1">// 发送 INFO 命令的间隔</span>
    <span class="kt">mstime_t</span> <span class="n">info_period</span><span class="p">;</span>

    <span class="c1">// 返回值</span>
    <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

    <span class="cm">/* Return ASAP if we have already a PING or INFO already pending, or</span>
<span class="cm">     * in the case the instance is not properly connected. */</span>
    <span class="c1">// 函数不能在网络连接未创建时执行</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_DISCONNECTED</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="cm">/* For INFO, PING, PUBLISH that are not critical commands to send we</span>
<span class="cm">     * also have a limit of SENTINEL_MAX_PENDING_COMMANDS. We don&#39;t</span>
<span class="cm">     * want to use a lot of memory just because a link is not working</span>
<span class="cm">     * properly (note that anyway there is a redundant protection about this,</span>
<span class="cm">     * that is, the link will be disconnected and reconnected if a long</span>
<span class="cm">     * timeout condition is detected. */</span>
    <span class="c1">// 为了避免 sentinel 在实例处于不正常状态时，发送过多命令</span>
    <span class="c1">// sentinel 只在待发送命令的数量未超过 SENTINEL_MAX_PENDING_COMMANDS 常量时</span>
    <span class="c1">// 才进行命令发送</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">&gt;=</span> <span class="n">SENTINEL_MAX_PENDING_COMMANDS</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="cm">/* If this is a slave of a master in O_DOWN condition we start sending</span>
<span class="cm">     * it INFO every second, instead of the usual SENTINEL_INFO_PERIOD</span>
<span class="cm">     * period. In this state we want to closely monitor slaves in case they</span>
<span class="cm">     * are turned into masters by another Sentinel, or by the sysadmin. */</span>
    <span class="c1">// 对于从服务器来说， sentinel 默认每 SENTINEL_INFO_PERIOD 秒向它发送一次 INFO 命令</span>
    <span class="c1">// 但是，当从服务器的主服务器处于 SDOWN 状态，或者正在执行故障转移时</span>
    <span class="c1">// 为了更快速地捕捉从服务器的变动， sentinel 会将发送 INFO 命令的频率该为每秒一次</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_O_DOWN</span><span class="o">|</span><span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">info_period</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">info_period</span> <span class="o">=</span> <span class="n">SENTINEL_INFO_PERIOD</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 实例不是 Sentinel （主服务器或者从服务器）</span>
    <span class="c1">// 并且以下条件的其中一个成立：</span>
    <span class="c1">// 1）SENTINEL 未收到过这个服务器的 INFO 命令回复</span>
    <span class="c1">// 2）距离上一次该实例回复 INFO 命令已经超过 info_period 间隔</span>
    <span class="c1">// 那么向实例发送 INFO 命令</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SENTINEL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">info_refresh</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">info_refresh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">info_period</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="cm">/* Send INFO to masters and slaves, not sentinels. */</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">redisAsyncCommand</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">,</span>
            <span class="n">sentinelInfoReplyCallback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;INFO&quot;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">++</span><span class="p">;</span>

    <span class="c1">// 如果距离上次向实例发送 PING 命令已经过了 SENTINEL_PING_PERIOD 毫秒</span>
    <span class="c1">// 那么再次发送 PING 命令</span>
    <span class="c1">// 实例可以是任意类型：sentinel 、主服务器或者从服务器</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_pong_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SENTINEL_PING_PERIOD</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Send PING to all the three kinds of instances. */</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">redisAsyncCommand</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">,</span>
            <span class="n">sentinelPingReplyCallback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;PING&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">++</span><span class="p">;</span>

    <span class="c1">// 如果距离上次向实例（主服务器或者从服务器）发送 </span>
    <span class="c1">// PUBLISH 命令的时间已经超过了 SENTINEL_PUBLISH_PERIOD</span>
    <span class="c1">// 那么向实例发送新的 PUBLISH 命令</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SENTINEL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
               <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_pub_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SENTINEL_PUBLISH_PERIOD</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* PUBLISH hello messages to masters and slaves. */</span>
        <span class="c1">// 向主服务器（或者从服务器的主服务器）的频道发送信息</span>
        <span class="n">sentinelSendHello</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* =========================== SENTINEL command ============================= */</span>

<span class="c1">// 返回字符串表示的故障转移状态</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sentinelFailoverStateStr</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_NONE</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;none&quot;</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_WAIT_START</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;wait_start&quot;</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_SELECT_SLAVE</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;select_slave&quot;</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;send_slaveof_noone&quot;</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_WAIT_PROMOTION</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;wait_promotion&quot;</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_RECONF_SLAVES</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;reconf_slaves&quot;</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_UPDATE_CONFIG</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;update_config&quot;</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Redis instance to Redis protocol representation. */</span>
<span class="c1">// 以 Redis 协议的形式返回 Redis 实例的情况</span>
<span class="kt">void</span> <span class="nf">addReplySentinelRedisInstance</span><span class="p">(</span><span class="n">redisClient</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">flags</span> <span class="o">=</span> <span class="n">sdsempty</span><span class="p">();</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">mbl</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fields</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">mbl</span> <span class="o">=</span> <span class="n">addDeferredMultiBulkLength</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;name&quot;</span><span class="p">);</span>
    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;ip&quot;</span><span class="p">);</span>
    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
    <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;port&quot;</span><span class="p">);</span>
    <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
    <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;runid&quot;</span><span class="p">);</span>
    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">runid</span> <span class="o">?</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="nl">runid</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;flags&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;s_down,&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_O_DOWN</span><span class="p">)</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;o_down,&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;master,&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;slave,&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SENTINEL</span><span class="p">)</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;sentinel,&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_DISCONNECTED</span><span class="p">)</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;disconnected,&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER_DOWN</span><span class="p">)</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;master_down,&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;failover_in_progress,&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_PROMOTED</span><span class="p">)</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;promoted,&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_RECONF_SENT</span><span class="p">)</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;reconf_sent,&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_RECONF_INPROG</span><span class="p">)</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;reconf_inprog,&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_RECONF_DONE</span><span class="p">)</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="s">&quot;reconf_done,&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sdslen</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">sdsrange</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* remove last &quot;,&quot; */</span>
    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
    <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;pending-commands&quot;</span><span class="p">);</span>
    <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="p">);</span>
    <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;failover-state&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">sentinelFailoverStateStr</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state</span><span class="p">));</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;last-ok-ping-reply&quot;</span><span class="p">);</span>
    <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_avail_time</span><span class="p">);</span>
    <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

    <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;last-ping-reply&quot;</span><span class="p">);</span>
    <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_pong_time</span><span class="p">);</span>
    <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;s-down-time&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">mstime</span><span class="p">()</span><span class="o">-</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">s_down_since_time</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_O_DOWN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;o-down-time&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">mstime</span><span class="p">()</span><span class="o">-</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">o_down_since_time</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Masters and Slaves */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_MASTER</span><span class="o">|</span><span class="n">SRI_SLAVE</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;info-refresh&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">info_refresh</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;role-reported&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported</span> <span class="o">==</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;master&quot;</span> <span class="o">:</span>
                                                                   <span class="s">&quot;slave&quot;</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;role-reported-time&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported_time</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Only masters */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;config-epoch&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">config_epoch</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;num-slaves&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">dictSize</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">));</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;num-other-sentinels&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">dictSize</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">));</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;quorum&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">quorum</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Only slaves */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SLAVE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;master-link-down-time&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">master_link_down_time</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;master-link-status&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>
            <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_link_status</span> <span class="o">==</span> <span class="n">SENTINEL_MASTER_LINK_STATUS_UP</span><span class="p">)</span> <span class="o">?</span>
            <span class="s">&quot;ok&quot;</span> <span class="o">:</span> <span class="s">&quot;err&quot;</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;master-host&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_host</span> <span class="o">?</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="nl">slave_master_host</span> <span class="p">:</span> <span class="s">&quot;?&quot;</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;master-port&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_master_port</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;slave-priority&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_priority</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;slave-repl-offset&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slave_repl_offset</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Only sentinels */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_SENTINEL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;last-hello-message&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_hello_time</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;voted-leader&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span> <span class="o">?</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="nl">leader</span> <span class="p">:</span> <span class="s">&quot;?&quot;</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>

        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;voted-leader-epoch&quot;</span><span class="p">);</span>
        <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader_epoch</span><span class="p">);</span>
        <span class="n">fields</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">setDeferredMultiBulkLength</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">mbl</span><span class="p">,</span><span class="n">fields</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Output a number of instances contained inside a dictionary as</span>
<span class="cm"> * Redis protocol. */</span>
<span class="c1">// 打印各个实例的情况</span>
<span class="kt">void</span> <span class="nf">addReplyDictOfRedisInstances</span><span class="p">(</span><span class="n">redisClient</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">dict</span> <span class="o">*</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>

    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">instances</span><span class="p">);</span>
    <span class="n">addReplyMultiBulkLen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">dictSize</span><span class="p">(</span><span class="n">instances</span><span class="p">));</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="n">addReplySentinelRedisInstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Lookup the named master into sentinel.masters.</span>
<span class="cm"> * If the master is not found reply to the client with an error and returns</span>
<span class="cm"> * NULL. */</span>
<span class="c1">// 在 sentinel.masters 字典中查找给定名字的 master</span>
<span class="c1">// 没找到则返回 NULL</span>
<span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="nf">sentinelGetMasterByNameOrReplyError</span><span class="p">(</span><span class="n">redisClient</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
                        <span class="n">robj</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>

    <span class="n">ri</span> <span class="o">=</span> <span class="n">dictFetchValue</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">masters</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;No such master with that name&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ri</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// SENTINEL 命令的实现</span>
<span class="kt">void</span> <span class="nf">sentinelCommand</span><span class="p">(</span><span class="n">redisClient</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="s">&quot;masters&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* SENTINEL MASTERS */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">goto</span> <span class="n">numargserr</span><span class="p">;</span>

        <span class="n">addReplyDictOfRedisInstances</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">sentinel</span><span class="p">.</span><span class="n">masters</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="s">&quot;slaves&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* SENTINEL SLAVES &lt;master-name&gt; */</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="k">goto</span> <span class="n">numargserr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByNameOrReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="n">addReplyDictOfRedisInstances</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="s">&quot;sentinels&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* SENTINEL SENTINELS &lt;master-name&gt; */</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="k">goto</span> <span class="n">numargserr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByNameOrReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="n">addReplyDictOfRedisInstances</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="s">&quot;is-master-down-by-addr&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* SENTINEL IS-MASTER-DOWN-BY-ADDR &lt;ip&gt; &lt;port&gt; &lt;current-epoch&gt; &lt;runid&gt; */</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>
        <span class="kt">long</span> <span class="kt">long</span> <span class="n">req_epoch</span><span class="p">;</span>
        <span class="kt">uint64_t</span> <span class="n">leader_epoch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">leader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">isdown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span> <span class="k">goto</span> <span class="n">numargserr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">getLongFromObjectOrReply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="o">&amp;</span><span class="n">port</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">REDIS_OK</span> <span class="o">||</span>
            <span class="n">getLongLongFromObjectOrReply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="o">&amp;</span><span class="n">req_epoch</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span>
                                                              <span class="o">!=</span> <span class="n">REDIS_OK</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">getSentinelRedisInstanceByAddrAndRunID</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">masters</span><span class="p">,</span>
            <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>

        <span class="cm">/* It exists? Is actually a master? Is subjectively down? It&#39;s down.</span>
<span class="cm">         * Note: if we are in tilt mode we always reply with &quot;0&quot;. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sentinel</span><span class="p">.</span><span class="n">tilt</span> <span class="o">&amp;&amp;</span> <span class="n">ri</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                                    <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">))</span>
            <span class="n">isdown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="cm">/* Vote for the master (or fetch the previous vote) if the request</span>
<span class="cm">         * includes a runid, otherwise the sender is not seeking for a vote. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">&amp;&amp;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span> <span class="o">&amp;&amp;</span> <span class="n">strcasecmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="s">&quot;*&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">leader</span> <span class="o">=</span> <span class="n">sentinelVoteLeader</span><span class="p">(</span><span class="n">ri</span><span class="p">,(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">req_epoch</span><span class="p">,</span>
                                            <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span>
                                            <span class="o">&amp;</span><span class="n">leader_epoch</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* Reply with a three-elements multi-bulk reply:</span>
<span class="cm">         * down state, leader, vote epoch. */</span>
        <span class="n">addReplyMultiBulkLen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
        <span class="n">addReply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">isdown</span> <span class="o">?</span> <span class="n">shared</span><span class="p">.</span><span class="nl">cone</span> <span class="p">:</span> <span class="n">shared</span><span class="p">.</span><span class="n">czero</span><span class="p">);</span>
        <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">leader</span> <span class="o">?</span> <span class="nl">leader</span> <span class="p">:</span> <span class="s">&quot;*&quot;</span><span class="p">);</span>
        <span class="n">addReplyLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">leader_epoch</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">leader</span><span class="p">)</span> <span class="n">sdsfree</span><span class="p">(</span><span class="n">leader</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="s">&quot;reset&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* SENTINEL RESET &lt;pattern&gt; */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="k">goto</span> <span class="n">numargserr</span><span class="p">;</span>
        <span class="n">addReplyLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">sentinelResetMastersByPattern</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="n">SENTINEL_GENERATE_EVENT</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="s">&quot;get-master-addr-by-name&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* SENTINEL GET-MASTER-ADDR-BY-NAME &lt;master-name&gt; */</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="k">goto</span> <span class="n">numargserr</span><span class="p">;</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByName</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">addReply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">shared</span><span class="p">.</span><span class="n">nullmultibulk</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">info_refresh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">addReplySds</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">sdsnew</span><span class="p">(</span><span class="s">&quot;-IDONTKNOW I have not enough information to reply. Please ask another Sentinel.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sentinelAddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">sentinelGetCurrentMasterAddress</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>

            <span class="n">addReplyMultiBulkLen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
            <span class="n">addReplyBulkCString</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
            <span class="n">addReplyBulkLongLong</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="s">&quot;failover&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* SENTINEL FAILOVER &lt;master-name&gt; */</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="k">goto</span> <span class="n">numargserr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ri</span> <span class="o">=</span> <span class="n">sentinelGetMasterByNameOrReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">addReplySds</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">sdsnew</span><span class="p">(</span><span class="s">&quot;-INPROG Failover already in progress</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sentinelSelectSlave</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">addReplySds</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">sdsnew</span><span class="p">(</span><span class="s">&quot;-NOGOODSLAVE No suitable slave to promote</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">redisLog</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;Executing user requested FAILOVER of &#39;%s&#39;&quot;</span><span class="p">,</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="n">sentinelStartFailover</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_FORCE_FAILOVER</span><span class="p">;</span>
        <span class="n">addReply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">shared</span><span class="p">.</span><span class="n">ok</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="s">&quot;pending-scripts&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* SENTINEL PENDING-SCRIPTS */</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">goto</span> <span class="n">numargserr</span><span class="p">;</span>
        <span class="n">sentinelPendingScriptsCommand</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">addReplyErrorFormat</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;Unknown sentinel subcommand &#39;%s&#39;&quot;</span><span class="p">,</span>
                               <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>

<span class="nl">numargserr</span><span class="p">:</span>
    <span class="n">addReplyErrorFormat</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;Wrong number of commands for &#39;sentinel %s&#39;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// sentinel 模式下的 INFO 命令实现</span>
<span class="kt">void</span> <span class="nf">sentinelInfoCommand</span><span class="p">(</span><span class="n">redisClient</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">section</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="nl">ptr</span> <span class="p">:</span> <span class="s">&quot;default&quot;</span><span class="p">;</span>
    <span class="n">sds</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sdsempty</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">defsections</span> <span class="o">=</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="s">&quot;default&quot;</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">sections</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">shared</span><span class="p">.</span><span class="n">syntaxerr</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="s">&quot;server&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">defsections</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sections</span><span class="o">++</span><span class="p">)</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">sds</span> <span class="n">serversection</span> <span class="o">=</span> <span class="n">genRedisInfoString</span><span class="p">(</span><span class="s">&quot;server&quot;</span><span class="p">);</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">sdscatlen</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">serversection</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">serversection</span><span class="p">));</span>
        <span class="n">sdsfree</span><span class="p">(</span><span class="n">serversection</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="s">&quot;sentinel&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">defsections</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
        <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">master_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sections</span><span class="o">++</span><span class="p">)</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sdscat</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
            <span class="s">&quot;# Sentinel</span><span class="se">\r\n</span><span class="s">&quot;</span>
            <span class="s">&quot;sentinel_masters:%lu</span><span class="se">\r\n</span><span class="s">&quot;</span>
            <span class="s">&quot;sentinel_tilt:%d</span><span class="se">\r\n</span><span class="s">&quot;</span>
            <span class="s">&quot;sentinel_running_scripts:%d</span><span class="se">\r\n</span><span class="s">&quot;</span>
            <span class="s">&quot;sentinel_scripts_queue_length:%ld</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">dictSize</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">masters</span><span class="p">),</span>
            <span class="n">sentinel</span><span class="p">.</span><span class="n">tilt</span><span class="p">,</span>
            <span class="n">sentinel</span><span class="p">.</span><span class="n">running_scripts</span><span class="p">,</span>
            <span class="n">listLength</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">scripts_queue</span><span class="p">));</span>

        <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">masters</span><span class="p">);</span>
        <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;ok&quot;</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_O_DOWN</span><span class="p">)</span> <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;odown&quot;</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span> <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;sdown&quot;</span><span class="p">;</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
                <span class="s">&quot;master%d:name=%s,status=%s,address=%s:%d,&quot;</span>
                <span class="s">&quot;slaves=%lu,sentinels=%lu</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">master_id</span><span class="o">++</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
                <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
                <span class="n">dictSize</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">),</span>
                <span class="n">dictSize</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">addReplySds</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">sdscatprintf</span><span class="p">(</span><span class="n">sdsempty</span><span class="p">(),</span><span class="s">&quot;$%lu</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sdslen</span><span class="p">(</span><span class="n">info</span><span class="p">)));</span>
    <span class="n">addReplySds</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">info</span><span class="p">);</span>
    <span class="n">addReply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">shared</span><span class="p">.</span><span class="n">crlf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ===================== SENTINEL availability checks ======================= */</span>

<span class="cm">/* Is this instance down from our point of view? */</span>
<span class="c1">// 检查实例是否以下线（从本 Sentinel 的角度来看）</span>
<span class="kt">void</span> <span class="nf">sentinelCheckSubjectivelyDown</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 实例上次正确回复 PING 命令距离现在有多久</span>
    <span class="kt">mstime_t</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_avail_time</span><span class="p">;</span>

    <span class="cm">/* Check if we are in need for a reconnection of one of the </span>
<span class="cm">     * links, because we are detecting low activity.</span>
<span class="cm">     *</span>
<span class="cm">     * 如果检测到连接的活跃度（activity）很低，那么考虑重断开连接，并进行重连</span>
<span class="cm">     *</span>
<span class="cm">     * 1) Check if the command link seems connected, was connected not less</span>
<span class="cm">     *    than SENTINEL_MIN_LINK_RECONNECT_PERIOD, but still we have an</span>
<span class="cm">     *    idle time that is greater than down_after_period / 2 seconds. */</span>
    <span class="c1">// 考虑断开实例的 cc 连接</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc_conn_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SENTINEL_MIN_LINK_RECONNECT_PERIOD</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_pong_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">down_after_period</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">sentinelKillLink</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* 2) Check if the pubsub link seems connected, was connected not less</span>
<span class="cm">     *    than SENTINEL_MIN_LINK_RECONNECT_PERIOD, but still we have no</span>
<span class="cm">     *    activity in the Pub/Sub channel for more than</span>
<span class="cm">     *    SENTINEL_PUBLISH_PERIOD * 3.</span>
<span class="cm">     */</span>
    <span class="c1">// 考虑断开实例的 pc 连接</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc_conn_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SENTINEL_MIN_LINK_RECONNECT_PERIOD</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc_last_activity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">SENTINEL_PUBLISH_PERIOD</span><span class="o">*</span><span class="mi">3</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">sentinelKillLink</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Update the SDOWN flag. We believe the instance is SDOWN if:</span>
<span class="cm">     *</span>
<span class="cm">     * 更新 SDOWN 标识。如果以下条件被满足，那么 Sentinel 认为实例已下线：</span>
<span class="cm">     *</span>
<span class="cm">     * 1) It is not replying.</span>
<span class="cm">     *    它没有回应命令</span>
<span class="cm">     * 2) We believe it is a master, it reports to be a slave for enough time</span>
<span class="cm">     *    to meet the down_after_period, plus enough time to get two times</span>
<span class="cm">     *    INFO report from the instance. </span>
<span class="cm">     *    Sentinel 认为实例是主服务器，这个服务器向 Sentinel 报告它将成为从服务器，</span>
<span class="cm">     *    但在超过给定时限之后，服务器仍然没有完成这一角色转换。</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">down_after_period</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span> <span class="o">&amp;&amp;</span>
         <span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported</span> <span class="o">==</span> <span class="n">SRI_SLAVE</span> <span class="o">&amp;&amp;</span>
         <span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">role_reported_time</span> <span class="o">&gt;</span>
          <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">down_after_period</span><span class="o">+</span><span class="n">SENTINEL_INFO_PERIOD</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span>
    <span class="p">{</span>
        <span class="cm">/* Is subjectively down */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 发送事件</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+sdown&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
            <span class="c1">// 记录进入 SDOWN 状态的时间</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">s_down_since_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
            <span class="c1">// 打开 SDOWN 标志</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_S_DOWN</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 移除（可能有的） SDOWN 状态</span>
        <span class="cm">/* Is subjectively up */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 发送事件</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;-sdown&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
            <span class="c1">// 移除相关标志</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SRI_S_DOWN</span><span class="o">|</span><span class="n">SRI_SCRIPT_KILL_SENT</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Is this instance down according to the configured quorum?</span>
<span class="cm"> *</span>
<span class="cm"> * 根据给定数量的 Sentinel 投票，判断实例是否已下线。</span>
<span class="cm"> *</span>
<span class="cm"> * Note that ODOWN is a weak quorum, it only means that enough Sentinels</span>
<span class="cm"> * reported in a given time range that the instance was not reachable.</span>
<span class="cm"> *</span>
<span class="cm"> * 注意 ODOWN 是一个 weak quorum ，它只意味着有足够多的 Sentinel </span>
<span class="cm"> * 在**给定的时间范围内**报告实例不可达。</span>
<span class="cm"> *</span>
<span class="cm"> * However messages can be delayed so there are no strong guarantees about</span>
<span class="cm"> * N instances agreeing at the same time about the down state. </span>
<span class="cm"> *</span>
<span class="cm"> * 因为 Sentinel 对实例的检测信息可能带有延迟，</span>
<span class="cm"> * 所以实际上 N 个 Sentinel **不可能在同一时间内**判断主服务器进入了下线状态。</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sentinelCheckObjectivelyDown</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">quorum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">odown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// 如果当前 Sentinel 将主服务器判断为主观下线</span>
    <span class="c1">// 那么检查是否有其他 Sentinel 同意这一判断</span>
    <span class="c1">// 当同意的数量足够时，将主服务器判断为客观下线</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Is down for enough sentinels? */</span>

        <span class="c1">// 统计同意的 Sentinel 数量（起始的 1 代表本 Sentinel）</span>
        <span class="n">quorum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* the current sentinel. */</span>

        <span class="cm">/* Count all the other sentinels. */</span>
        <span class="c1">// 统计其他认为 master 进入下线状态的 Sentinel 的数量</span>
        <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">);</span>
        <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
                
            <span class="c1">// 该 SENTINEL 也认为 master 已下线</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER_DOWN</span><span class="p">)</span> <span class="n">quorum</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
        
        <span class="c1">// 如果投票得出的支持数目大于等于判断 ODOWN 所需的票数</span>
        <span class="c1">// 那么进入 ODOWN 状态</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">quorum</span> <span class="o">&gt;=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">quorum</span><span class="p">)</span> <span class="n">odown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Set the flag accordingly to the outcome. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">odown</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// master 已 ODOWN</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_O_DOWN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 发送事件</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+odown&quot;</span><span class="p">,</span><span class="n">master</span><span class="p">,</span><span class="s">&quot;%@ #quorum %d/%d&quot;</span><span class="p">,</span>
                <span class="n">quorum</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">quorum</span><span class="p">);</span>
            <span class="c1">// 打开 ODOWN 标志</span>
            <span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_O_DOWN</span><span class="p">;</span>
            <span class="c1">// 记录进入 ODOWN 的时间</span>
            <span class="n">master</span><span class="o">-&gt;</span><span class="n">o_down_since_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

        <span class="c1">// 未进入 ODOWN</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_O_DOWN</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// 如果 master 曾经进入过 ODOWN 状态，那么移除该状态</span>

            <span class="c1">// 发送事件</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;-odown&quot;</span><span class="p">,</span><span class="n">master</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
            <span class="c1">// 移除 ODOWN 标志</span>
            <span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRI_O_DOWN</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Receive the SENTINEL is-master-down-by-addr reply, see the</span>
<span class="cm"> * sentinelAskMasterStateToOtherSentinels() function for more information. */</span>
<span class="c1">// 本回调函数用于处理SENTINEL 接收到其他 SENTINEL </span>
<span class="c1">// 发回的 SENTINEL is-master-down-by-addr 命令的回复</span>
<span class="kt">void</span> <span class="nf">sentinelReceiveIsMasterDownReply</span><span class="p">(</span><span class="n">redisAsyncContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="n">redisReply</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">--</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span> <span class="o">||</span> <span class="o">!</span><span class="n">ri</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">reply</span><span class="p">;</span>

    <span class="cm">/* Ignore every error or unexpected reply.</span>
<span class="cm">     * 忽略错误回复</span>
<span class="cm">     * Note that if the command returns an error for any reason we&#39;ll</span>
<span class="cm">     * end clearing the SRI_MASTER_DOWN flag for timeout anyway. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_ARRAY</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">elements</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_INTEGER</span> <span class="o">&amp;&amp;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_STRING</span> <span class="o">&amp;&amp;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_INTEGER</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 更新最后一次回复询问的时间</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_master_down_reply_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

        <span class="c1">// 设置 SENTINEL 认为主服务器的状态</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">integer</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 已下线</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_MASTER_DOWN</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// 未下线</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRI_MASTER_DOWN</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 如果运行 ID 不是 &quot;*&quot; 的话，那么这是一个带投票的回复</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span><span class="s">&quot;*&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="cm">/* If the runid in the reply is not &quot;*&quot; the Sentinel actually</span>
<span class="cm">             * replied with a vote. */</span>
            <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span><span class="p">);</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader_epoch</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* If we think the master is down, we start sending</span>
<span class="cm"> * SENTINEL IS-MASTER-DOWN-BY-ADDR requests to other sentinels</span>
<span class="cm"> * in order to get the replies that allow to reach the quorum</span>
<span class="cm"> * needed to mark the master in ODOWN state and trigger a failover. */</span>
<span class="c1">// 如果 Sentinel 认为主服务器已下线，</span>
<span class="c1">// 那么它会通过向其他 Sentinel 发送 SENTINEL is-master-down-by-addr 命令，</span>
<span class="c1">// 尝试获得足够的票数，将主服务器标记为 ODOWN 状态，并开始一次故障转移操作</span>
<span class="cp">#define SENTINEL_ASK_FORCED (1&lt;&lt;0)</span>
<span class="kt">void</span> <span class="nf">sentinelAskMasterStateToOtherSentinels</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>

    <span class="c1">// 遍历正在监视相同 master 的所有 sentinel</span>
    <span class="c1">// 向它们发送 SENTINEL is-master-down-by-addr 命令</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="c1">// 距离该 sentinel 最后一次回复 SENTINEL master-down-by-addr 命令已经过了多久</span>
        <span class="kt">mstime_t</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_master_down_reply_time</span><span class="p">;</span>

        <span class="kt">char</span> <span class="n">port</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

        <span class="cm">/* If the master state from other sentinel is too old, we clear it. */</span>
        <span class="c1">// 如果目标 Sentinel 关于主服务器的信息已经太久没更新，那么我们清除它</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">SENTINEL_ASK_PERIOD</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRI_MASTER_DOWN</span><span class="p">;</span>
            <span class="n">sdsfree</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span><span class="p">);</span>
            <span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* Only ask if master is down to other sentinels if:</span>
<span class="cm">         *</span>
<span class="cm">         * 只在以下情况满足时，才向其他 sentinel 询问主服务器是否已下线</span>
<span class="cm">         *</span>
<span class="cm">         * 1) We believe it is down, or there is a failover in progress.</span>
<span class="cm">         *    本 sentinel 相信服务器已经下线，或者针对该主服务器的故障转移操作正在执行</span>
<span class="cm">         * 2) Sentinel is connected.</span>
<span class="cm">         *    目标 Sentinel 与本 Sentinel 已连接</span>
<span class="cm">         * 3) We did not received the info within SENTINEL_ASK_PERIOD ms. </span>
<span class="cm">         *    当前 Sentinel 在 SENTINEL_ASK_PERIOD 毫秒内没有获得过目标 Sentinel 发来的信息</span>
<span class="cm">         * 4) 条件 1 和条件 2 满足而条件 3 不满足，但是 flags 参数给定了 SENTINEL_ASK_FORCED 标识</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_DISCONNECTED</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENTINEL_ASK_FORCED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">last_master_down_reply_time</span> <span class="o">&lt;</span> <span class="n">SENTINEL_ASK_PERIOD</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="cm">/* Ask */</span>
        <span class="c1">// 发送 SENTINEL is-master-down-by-addr 命令</span>
        <span class="n">ll2string</span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">port</span><span class="p">),</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">redisAsyncCommand</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">,</span>
                    <span class="n">sentinelReceiveIsMasterDownReply</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
                    <span class="s">&quot;SENTINEL is-master-down-by-addr %s %s %llu %s&quot;</span><span class="p">,</span>
                    <span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
                    <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">&gt;</span> <span class="n">SENTINEL_FAILOVER_STATE_NONE</span><span class="p">)</span> <span class="o">?</span>
                    <span class="n">server</span><span class="p">.</span><span class="nl">runid</span> <span class="p">:</span> <span class="s">&quot;*&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* =============================== FAILOVER ================================= */</span>

<span class="cm">/* Vote for the sentinel with &#39;req_runid&#39; or return the old vote if already</span>
<span class="cm"> * voted for the specifed &#39;req_epoch&#39; or one greater.</span>
<span class="cm"> *</span>
<span class="cm"> * 为运行 ID 为 req_runid 的 Sentinel 投上一票，有两种额外情况可能出现：</span>
<span class="cm"> * 1) 如果 Sentinel 在 req_epoch 纪元已经投过票了，那么返回之前投的票。</span>
<span class="cm"> * 2) 如果 Sentinel 已经为大于 req_epoch 的纪元投过票了，那么返回更大纪元的投票。</span>
<span class="cm"> *</span>
<span class="cm"> * If a vote is not available returns NULL, otherwise return the Sentinel</span>
<span class="cm"> * runid and populate the leader_epoch with the epoch of the vote. </span>
<span class="cm"> *</span>
<span class="cm"> * 如果投票暂时不可用，那么返回 NULL 。</span>
<span class="cm"> * 否则返回 Sentinel 的运行 ID ，并将被投票的纪元保存到 leader_epoch 指针的值里面。</span>
<span class="cm"> */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">sentinelVoteLeader</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">req_epoch</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">req_runid</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">leader_epoch</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">req_epoch</span> <span class="o">&gt;</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span> <span class="o">=</span> <span class="n">req_epoch</span><span class="p">;</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+new-epoch&quot;</span><span class="p">,</span><span class="n">master</span><span class="p">,</span><span class="s">&quot;%llu&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">leader_epoch</span> <span class="o">&lt;</span> <span class="n">req_epoch</span> <span class="o">&amp;&amp;</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span> <span class="o">&lt;=</span> <span class="n">req_epoch</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sdsfree</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">leader</span><span class="p">);</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">leader</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">req_runid</span><span class="p">);</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">leader_epoch</span> <span class="o">=</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span><span class="p">;</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+vote-for-leader&quot;</span><span class="p">,</span><span class="n">master</span><span class="p">,</span><span class="s">&quot;%s %llu&quot;</span><span class="p">,</span>
            <span class="n">master</span><span class="o">-&gt;</span><span class="n">leader</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">leader_epoch</span><span class="p">);</span>
        <span class="cm">/* If we did not voted for ourselves, set the master failover start</span>
<span class="cm">         * time to now, in order to force a delay before we can start a</span>
<span class="cm">         * failover for the same master.</span>
<span class="cm">         *</span>
<span class="cm">         * The random addition is useful to desynchronize a bit the slaves</span>
<span class="cm">         * and reduce the chance that no slave gets majority. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">leader</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">runid</span><span class="p">))</span>
            <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_start_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">()</span> <span class="o">+</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2000</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">leader_epoch</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">leader_epoch</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">leader</span> <span class="o">?</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">leader</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 记录客观 leader 投票的结构</span>
<span class="k">struct</span> <span class="n">sentinelLeader</span> <span class="p">{</span>

    <span class="c1">// sentinel 的运行 id</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">runid</span><span class="p">;</span>

    <span class="c1">// 该 sentinel 获得的票数</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">votes</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Helper function for sentinelGetLeader, increment the counter</span>
<span class="cm"> * relative to the specified runid. */</span>
<span class="c1">// 为给定 ID 的 Sentinel 实例增加一票</span>
<span class="kt">int</span> <span class="nf">sentinelLeaderIncr</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">counters</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">runid</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictFind</span><span class="p">(</span><span class="n">counters</span><span class="p">,</span><span class="n">runid</span><span class="p">);</span>
    <span class="kt">uint64_t</span> <span class="n">oldval</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">oldval</span> <span class="o">=</span> <span class="n">dictGetUnsignedIntegerVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
        <span class="n">dictSetUnsignedIntegerVal</span><span class="p">(</span><span class="n">de</span><span class="p">,</span><span class="n">oldval</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">oldval</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">de</span> <span class="o">=</span> <span class="n">dictAddRaw</span><span class="p">(</span><span class="n">counters</span><span class="p">,</span><span class="n">runid</span><span class="p">);</span>
        <span class="n">redisAssert</span><span class="p">(</span><span class="n">de</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">dictSetUnsignedIntegerVal</span><span class="p">(</span><span class="n">de</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Scan all the Sentinels attached to this master to check if there</span>
<span class="cm"> * is a leader for the specified epoch.</span>
<span class="cm"> *</span>
<span class="cm"> * 扫描所有监视 master 的 Sentinels ，查看是否有 Sentinels 是这个纪元的领头。</span>
<span class="cm"> *</span>
<span class="cm"> * To be a leader for a given epoch, we should have the majorify of</span>
<span class="cm"> * the Sentinels we know that reported the same instance as</span>
<span class="cm"> * leader for the same epoch. </span>
<span class="cm"> *</span>
<span class="cm"> * 要让一个 Sentinel 成为本纪元的领头，</span>
<span class="cm"> * 这个 Sentinel 必须让大多数其他 Sentinel 承认它是该纪元的领头才行。</span>
<span class="cm"> */</span>
<span class="c1">// 选举出 master 在指定 epoch 上的领头</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">sentinelGetLeader</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">epoch</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">counters</span><span class="p">;</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">voters</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">voters_quorum</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">myvote</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">winner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">leader_epoch</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">max_votes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">redisAssert</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_O_DOWN</span><span class="o">|</span><span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="p">));</span>

    <span class="c1">// 统计器</span>
    <span class="n">counters</span> <span class="o">=</span> <span class="n">dictCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaderVotesDictType</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>

    <span class="cm">/* Count other sentinels votes */</span>
    <span class="c1">// 统计其他 sentinel 的主观 leader 投票</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="c1">// 为目标 Sentinel 选出的领头 Sentinel 增加一票</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader_epoch</span> <span class="o">==</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span><span class="p">)</span>
            <span class="n">sentinelLeaderIncr</span><span class="p">(</span><span class="n">counters</span><span class="p">,</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">leader</span><span class="p">);</span>

        <span class="c1">// 统计投票数量</span>
        <span class="n">voters</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

    <span class="cm">/* Check what&#39;s the winner. For the winner to win, it needs two conditions:</span>
<span class="cm">     *</span>
<span class="cm">     * 选出领头 leader ，它必须满足以下两个条件：</span>
<span class="cm">     *</span>
<span class="cm">     * 1) Absolute majority between voters (50% + 1).</span>
<span class="cm">     *    有多于一般的 Sentinel 支持</span>
<span class="cm">     * 2) And anyway at least master-&gt;quorum votes. </span>
<span class="cm">     *    投票数至少要有 master-&gt;quorum 那么多</span>
<span class="cm">     */</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">counters</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 取出票数</span>
        <span class="kt">uint64_t</span> <span class="n">votes</span> <span class="o">=</span> <span class="n">dictGetUnsignedIntegerVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="c1">// 选出票数最大的人</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">votes</span> <span class="o">&gt;</span> <span class="n">max_votes</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">max_votes</span> <span class="o">=</span> <span class="n">votes</span><span class="p">;</span>
            <span class="n">winner</span> <span class="o">=</span> <span class="n">dictGetKey</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

    <span class="cm">/* Count this Sentinel vote:</span>
<span class="cm">     * if this Sentinel did not voted yet, either vote for the most</span>
<span class="cm">     * common voted sentinel, or for itself if no vote exists at all. */</span>
    <span class="c1">// 本 Sentinel 进行投票</span>
    <span class="c1">// 如果 Sentinel 之前还没有进行投票，那么有两种选择：</span>
    <span class="c1">// 1）如果选出了 winner （最多票数支持的 Sentinel ），那么这个 Sentinel 也投 winner 一票</span>
    <span class="c1">// 2）如果没有选出 winner ，那么 Sentinel 投自己一票</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">winner</span><span class="p">)</span>
        <span class="n">myvote</span> <span class="o">=</span> <span class="n">sentinelVoteLeader</span><span class="p">(</span><span class="n">master</span><span class="p">,</span><span class="n">epoch</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="o">&amp;</span><span class="n">leader_epoch</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">myvote</span> <span class="o">=</span> <span class="n">sentinelVoteLeader</span><span class="p">(</span><span class="n">master</span><span class="p">,</span><span class="n">epoch</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">runid</span><span class="p">,</span><span class="o">&amp;</span><span class="n">leader_epoch</span><span class="p">);</span>

    <span class="c1">// 领头 Sentinel 已选出，并且领头的纪元和给定的纪元一样</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">myvote</span> <span class="o">&amp;&amp;</span> <span class="n">leader_epoch</span> <span class="o">==</span> <span class="n">epoch</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 为领头 Sentinel 增加一票（这一票来自本 Sentinel ）</span>
        <span class="kt">uint64_t</span> <span class="n">votes</span> <span class="o">=</span> <span class="n">sentinelLeaderIncr</span><span class="p">(</span><span class="n">counters</span><span class="p">,</span><span class="n">myvote</span><span class="p">);</span>

        <span class="c1">// 如果投票之后的票数比最大票数要大，那么更换领头 Sentinel</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">votes</span> <span class="o">&gt;</span> <span class="n">max_votes</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">max_votes</span> <span class="o">=</span> <span class="n">votes</span><span class="p">;</span>
            <span class="n">winner</span> <span class="o">=</span> <span class="n">myvote</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">voters</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* Anyway, count me as one of the voters. */</span>

    <span class="c1">// 如果支持领头的投票数量不超过半数</span>
    <span class="c1">// 并且支持票数不超过 master 配置指定的投票数量</span>
    <span class="c1">// 那么这次领头选举无效</span>
    <span class="n">voters_quorum</span> <span class="o">=</span> <span class="n">voters</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">winner</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">max_votes</span> <span class="o">&lt;</span> <span class="n">voters_quorum</span> <span class="o">||</span> <span class="n">max_votes</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">quorum</span><span class="p">))</span>
        <span class="n">winner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// 返回领头 Sentinel ，或者 NULL</span>
    <span class="n">winner</span> <span class="o">=</span> <span class="n">winner</span> <span class="o">?</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">winner</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">myvote</span><span class="p">);</span>
    <span class="n">dictRelease</span><span class="p">(</span><span class="n">counters</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">winner</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send SLAVEOF to the specified instance, always followed by a</span>
<span class="cm"> * CONFIG REWRITE command in order to store the new configuration on disk</span>
<span class="cm"> * when possible (that is, if the Redis instance is recent enough to support</span>
<span class="cm"> * config rewriting, and if the server was started with a configuration file).</span>
<span class="cm"> *</span>
<span class="cm"> * 向指定实例发送 SLAVEOF 命令，并在可能时，执行 CONFIG REWRITE 命令，</span>
<span class="cm"> * 将当前配置保存到磁盘中。</span>
<span class="cm"> *</span>
<span class="cm"> * If Host is NULL the function sends &quot;SLAVEOF NO ONE&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * 如果 host 参数为 NULL ，那么向实例发送 SLAVEOF NO ONE 命令</span>
<span class="cm"> *</span>
<span class="cm"> * The command returns REDIS_OK if the SLAVEOF command was accepted for</span>
<span class="cm"> * (later) delivery otherwise REDIS_ERR. The command replies are just</span>
<span class="cm"> * discarded. </span>
<span class="cm"> *</span>
<span class="cm"> * 命令入队成功（异步发送）时，函数返回 REDIS_OK ，</span>
<span class="cm"> * 入队失败时返回 REDIS_ERR ，</span>
<span class="cm"> * 命令回复会被丢弃。</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sentinelSendSlaveOf</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">portstr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

    <span class="n">ll2string</span><span class="p">(</span><span class="n">portstr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">portstr</span><span class="p">),</span><span class="n">port</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;NO&quot;</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">portstr</span><span class="p">,</span><span class="s">&quot;ONE&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 发送 SLAVEOF NO ONE</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">redisAsyncCommand</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">,</span>
        <span class="n">sentinelDiscardReplyCallback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;SLAVEOF %s %s&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">portstr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">REDIS_ERR</span><span class="p">)</span> <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">++</span><span class="p">;</span>

    <span class="c1">// 发送 CONFIG REWRITE</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">redisAsyncCommand</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">cc</span><span class="p">,</span>
        <span class="n">sentinelDiscardReplyCallback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CONFIG REWRITE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDIS_OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pending_commands</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">REDIS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Setup the master state to start a failover. */</span>
<span class="c1">// 设置主服务器的状态，开始一次故障转移</span>
<span class="kt">void</span> <span class="nf">sentinelStartFailover</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">redisAssert</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">);</span>

    <span class="c1">// 更新故障转移状态</span>
    <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">=</span> <span class="n">SENTINEL_FAILOVER_STATE_WAIT_START</span><span class="p">;</span>

    <span class="c1">// 更新主服务器状态</span>
    <span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="p">;</span>

    <span class="c1">// 更新纪元</span>
    <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_epoch</span> <span class="o">=</span> <span class="o">++</span><span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span><span class="p">;</span>

    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+new-epoch&quot;</span><span class="p">,</span><span class="n">master</span><span class="p">,</span><span class="s">&quot;%llu&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">current_epoch</span><span class="p">);</span>

    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+try-failover&quot;</span><span class="p">,</span><span class="n">master</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>

    <span class="c1">// 记录故障转移的开始时间</span>
    <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_start_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="c1">// 记录故障转移状态的变更时间</span>
    <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* This function checks if there are the conditions to start the failover,</span>
<span class="cm"> * that is:</span>
<span class="cm"> *</span>
<span class="cm"> * 这个函数检查是否需要开始一次故障转移操作：</span>
<span class="cm"> *</span>
<span class="cm"> * 1) Master must be in ODOWN condition.</span>
<span class="cm"> *    主服务器已经计入 ODOWN 状态。</span>
<span class="cm"> * 2) No failover already in progress.</span>
<span class="cm"> *    当前没有针对同一主服务器的故障转移操作在执行。</span>
<span class="cm"> * 3) No failover already attempted recently.</span>
<span class="cm"> *    最近时间内，这个主服务器没有尝试过执行故障转移</span>
<span class="cm"> *    （应该是为了防止频繁执行）。</span>
<span class="cm"> * </span>
<span class="cm"> * We still don&#39;t know if we&#39;ll win the election so it is possible that we</span>
<span class="cm"> * start the failover but that we&#39;ll not be able to act.</span>
<span class="cm"> *</span>
<span class="cm"> * 虽然 Sentinel 可以发起一次故障转移，但因为故障转移操作是由领头 Sentinel 执行的，</span>
<span class="cm"> * 所以发起故障转移的 Sentinel 不一定就是执行故障转移的 Sentinel 。</span>
<span class="cm"> *</span>
<span class="cm"> * Return non-zero if a failover was started. </span>
<span class="cm"> *</span>
<span class="cm"> * 如果故障转移操作成功开始，那么函数返回非 0 值。</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sentinelStartFailoverIfNeeded</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* We can&#39;t failover if the master is not in O_DOWN state. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_O_DOWN</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Failover already in progress? */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Last failover attempt started too little time ago? */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_start_time</span> <span class="o">&lt;</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_timeout</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// 开始一次故障转移</span>
    <span class="n">sentinelStartFailover</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Select a suitable slave to promote. The current algorithm only uses</span>
<span class="cm"> * the following parameters:</span>
<span class="cm"> *</span>
<span class="cm"> * 在多个从服务器中选出一个作为新的主服务器。</span>
<span class="cm"> * 算法使用以下参数：</span>
<span class="cm"> *</span>
<span class="cm"> * 1) None of the following conditions: S_DOWN, O_DOWN, DISCONNECTED.</span>
<span class="cm"> *    带有 S_DOWN 、 O_DOWN 和 DISCONNECTED 状态的从服务器不会被选中。</span>
<span class="cm"> * 2) Last time the slave replied to ping no more than 5 times the PING period.</span>
<span class="cm"> *    距离最近一次回复 PING 命令超过 5 秒以上的从服务区不会被选中。</span>
<span class="cm"> * 3) info_refresh not older than 3 times the INFO refresh period.</span>
<span class="cm"> *    距离最后一次回复 INFO 命令的时间超过 info_refresh 时长三倍的从服务器不会被考虑。</span>
<span class="cm"> * 4) master_link_down_time no more than:</span>
<span class="cm"> *    主从服务器之间的连接断开时间不能超过：</span>
<span class="cm"> *     (now - master-&gt;s_down_since_time) + (master-&gt;down_after_period * 10).</span>
<span class="cm"> *    Basically since the master is down from our POV, the slave reports</span>
<span class="cm"> *    to be disconnected no more than 10 times the configured down-after-period.</span>
<span class="cm"> *    因为从当前 Sentinel 来看，主服务器已经处于下线状态，</span>
<span class="cm"> *    所以正常来说，</span>
<span class="cm"> *    从服务器与主服务器之间的连接断开时间不应该超过 down-after-period 的十倍。</span>
<span class="cm"> *    This is pretty much black magic but the idea is, the master was not</span>
<span class="cm"> *    available so the slave may be lagging, but not over a certain time.</span>
<span class="cm"> *    这听上去有点像黑魔法，不过这个判断的主意是这样的：</span>
<span class="cm"> *    当主服务器下线之后，主从服务器的连接就会断开，但只要先下线的是主服务器而不是从服务器</span>
<span class="cm"> *    （换句话说，连接断开是由主服务器而不是从服务器造成的）</span>
<span class="cm"> *    那么主从服务器之间的连接断开时间就不会太长。</span>
<span class="cm"> *    Anyway we&#39;ll select the best slave according to replication offset.</span>
<span class="cm"> *    不过这只是一个辅助手段，因为最终我们都会使用复制偏移量来挑选从服务器。</span>
<span class="cm"> * 5) Slave priority can&#39;t be zero, otherwise the slave is discarded.</span>
<span class="cm"> *    从服务器的优先级不能为 0 ，优先级为 0 的从服务器表示被禁用。</span>
<span class="cm"> *</span>
<span class="cm"> * Among all the slaves matching the above conditions we select the slave</span>
<span class="cm"> * with, in order of sorting key:</span>
<span class="cm"> *</span>
<span class="cm"> * 符合以上条件的从服务器，我们会按以下条件对从服务器进行排序：</span>
<span class="cm"> *</span>
<span class="cm"> * - lower slave_priority.</span>
<span class="cm"> *   优先级更小的从服务器优先。</span>
<span class="cm"> * - bigger processed replication offset.</span>
<span class="cm"> *   复制偏移量较大的从服务器优先。</span>
<span class="cm"> * - lexicographically smaller runid.</span>
<span class="cm"> *   运行 ID 较小的从服务器优先。</span>
<span class="cm"> *</span>
<span class="cm"> * Basically if runid is the same, the slave that processed more commands</span>
<span class="cm"> * from the master is selected.</span>
<span class="cm"> *</span>
<span class="cm"> * 如果运行 ID 相同，那么执行命令数量较多的那个从服务器会被选中。</span>
<span class="cm"> *</span>
<span class="cm"> * The function returns the pointer to the selected slave, otherwise</span>
<span class="cm"> * NULL if no suitable slave was found.</span>
<span class="cm"> *</span>
<span class="cm"> * sentinelSelectSlave 函数返回被选中从服务器的实例指针，</span>
<span class="cm"> * 如果没有何时的从服务器，那么返回 NULL 。</span>
<span class="cm"> */</span>

<span class="cm">/* Helper for sentinelSelectSlave(). This is used by qsort() in order to</span>
<span class="cm"> * sort suitable slaves in a &quot;better first&quot; order, to take the first of</span>
<span class="cm"> * the list. */</span>
<span class="c1">// 排序函数，用于选出更好的从服务器</span>
<span class="kt">int</span> <span class="nf">compareSlavesForPromotion</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">**</span><span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">**</span><span class="p">)</span><span class="n">a</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">sb</span> <span class="o">=</span> <span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">**</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">sa_runid</span><span class="p">,</span> <span class="o">*</span><span class="n">sb_runid</span><span class="p">;</span>

    <span class="c1">// 优先级较小的从服务器胜出</span>
    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">sa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slave_priority</span> <span class="o">!=</span> <span class="p">(</span><span class="o">*</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slave_priority</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">sa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slave_priority</span> <span class="o">-</span> <span class="p">(</span><span class="o">*</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slave_priority</span><span class="p">;</span>

    <span class="cm">/* If priority is the same, select the slave with greater replication</span>
<span class="cm">     * offset (processed more data frmo the master). */</span>
    <span class="c1">// 如果优先级相同，那么复制偏移量较大的那个从服务器胜出</span>
    <span class="c1">// （偏移量较大表示从主服务器获取的数据更多，更完整）</span>
    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">sa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slave_repl_offset</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">*</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slave_repl_offset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* a &lt; b */</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">sa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slave_repl_offset</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slave_repl_offset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* b &gt; a */</span>
    <span class="p">}</span>

    <span class="cm">/* If the replication offset is the same select the slave with that has</span>
<span class="cm">     * the lexicographically smaller runid. Note that we try to handle runid</span>
<span class="cm">     * == NULL as there are old Redis versions that don&#39;t publish runid in</span>
<span class="cm">     * INFO. A NULL runid is considered bigger than any other runid. */</span>
    <span class="c1">// 如果复制偏移量也相同，那么选出运行 ID 较低的那个从服务器</span>
    <span class="c1">// 注意，对于没有运行 ID 的旧版 Redis 来说，默认的运行 ID 为 NULL</span>
    <span class="n">sa_runid</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">sa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">runid</span><span class="p">;</span>
    <span class="n">sb_runid</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">runid</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sa_runid</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">sb_runid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sa_runid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* a &gt; b */</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sb_runid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* a &lt; b */</span>
    <span class="k">return</span> <span class="n">strcasecmp</span><span class="p">(</span><span class="n">sa_runid</span><span class="p">,</span> <span class="n">sb_runid</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 从主服务器的所有从服务器中，挑选一个作为新的主服务器</span>
<span class="c1">// 如果没有合格的新主服务器，那么返回 NULL</span>
<span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="nf">sentinelSelectSlave</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">sentinelRedisInstance</span> <span class="o">**</span><span class="n">instance</span> <span class="o">=</span>
        <span class="n">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">dictSize</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">));</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">selected</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">instances</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
    <span class="kt">mstime_t</span> <span class="n">max_master_down_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// 计算可以接收的，从服务器与主服务器之间的最大下线时间</span>
    <span class="c1">// 这个值可以保证被选中的从服务器的数据库不会太旧</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span>
        <span class="n">max_master_down_time</span> <span class="o">+=</span> <span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">s_down_since_time</span><span class="p">;</span>
    <span class="n">max_master_down_time</span> <span class="o">+=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">down_after_period</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>

    <span class="c1">// 遍历所有从服务器</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 从服务器实例</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
        <span class="kt">mstime_t</span> <span class="n">info_validity_time</span><span class="p">;</span>

        <span class="c1">// 忽略所有 SDOWN 、ODOWN 或者已断线的从服务器</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_S_DOWN</span><span class="o">|</span><span class="n">SRI_O_DOWN</span><span class="o">|</span><span class="n">SRI_DISCONNECTED</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">last_avail_time</span> <span class="o">&gt;</span> <span class="n">SENTINEL_PING_PERIOD</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">slave_priority</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="cm">/* If the master is in SDOWN state we get INFO for slaves every second.</span>
<span class="cm">         * Otherwise we get it with the usual period so we need to account for</span>
<span class="cm">         * a larger delay. */</span>
        <span class="c1">// 如果主服务器处于 SDOWN 状态，那么 Sentinel 以每秒一次的频率向从服务器发送 INFO 命令</span>
        <span class="c1">// 否则以平常频率向从服务器发送 INFO 命令</span>
        <span class="c1">// 这里要检查 INFO 命令的返回值是否合法，检查的时间会乘以一个倍数，以计算延迟</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span>
            <span class="n">info_validity_time</span> <span class="o">=</span> <span class="n">SENTINEL_PING_PERIOD</span><span class="o">*</span><span class="mi">5</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">info_validity_time</span> <span class="o">=</span> <span class="n">SENTINEL_INFO_PERIOD</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>

        <span class="c1">// INFO 回复已过期，不考虑</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">info_refresh</span> <span class="o">&gt;</span> <span class="n">info_validity_time</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// 从服务器下线的时间过长，不考虑</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">master_link_down_time</span> <span class="o">&gt;</span> <span class="n">max_master_down_time</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// 将被选中的 slave 保存到数组中</span>
        <span class="n">instance</span><span class="p">[</span><span class="n">instances</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 对被选中的从服务器进行排序</span>
        <span class="n">qsort</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span><span class="n">instances</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sentinelRedisInstance</span><span class="o">*</span><span class="p">),</span>
            <span class="n">compareSlavesForPromotion</span><span class="p">);</span>
        
        <span class="c1">// 分值最低的从服务器为被选中服务器</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">zfree</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

    <span class="c1">// 返回被选中的从服务区</span>
    <span class="k">return</span> <span class="n">selected</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------- Failover state machine implementation ------------------- */</span>

<span class="c1">// 准备执行故障转移</span>
<span class="kt">void</span> <span class="nf">sentinelFailoverWaitStart</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">leader</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">isleader</span><span class="p">;</span>

    <span class="cm">/* Check if we are the leader for the failover epoch. */</span>
    <span class="c1">// 获取给定纪元的领头 Sentinel</span>
    <span class="n">leader</span> <span class="o">=</span> <span class="n">sentinelGetLeader</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_epoch</span><span class="p">);</span>
    <span class="c1">// 本 Sentinel 是否为领头 Sentinel ？</span>
    <span class="n">isleader</span> <span class="o">=</span> <span class="n">leader</span> <span class="o">&amp;&amp;</span> <span class="n">strcasecmp</span><span class="p">(</span><span class="n">leader</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">runid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">leader</span><span class="p">);</span>

    <span class="cm">/* If I&#39;m not the leader, and it is not a forced failover via</span>
<span class="cm">     * SENTINEL FAILOVER, then I can&#39;t continue with the failover. */</span>
    <span class="c1">// 如果本 Sentinel 不是领头，并且这次故障迁移不是一次强制故障迁移操作</span>
    <span class="c1">// 那么本 Sentinel 不做动作</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isleader</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_FORCE_FAILOVER</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">election_timeout</span> <span class="o">=</span> <span class="n">SENTINEL_ELECTION_TIMEOUT</span><span class="p">;</span>

        <span class="cm">/* The election timeout is the MIN between SENTINEL_ELECTION_TIMEOUT</span>
<span class="cm">         * and the configured failover timeout. */</span>
        <span class="c1">// 当选的时长（类似于任期）是 SENTINEL_ELECTION_TIMEOUT</span>
        <span class="c1">// 和 Sentinel 设置的故障迁移时长之间的较小那个值</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">election_timeout</span> <span class="o">&gt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_timeout</span><span class="p">)</span>
            <span class="n">election_timeout</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_timeout</span><span class="p">;</span>

        <span class="cm">/* Abort the failover if I&#39;m not the leader after some time. */</span>
        <span class="c1">// Sentinel 的当选时间已过，取消故障转移计划</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_start_time</span> <span class="o">&gt;</span> <span class="n">election_timeout</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;-failover-abort-not-elected&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
            <span class="c1">// 取消故障转移</span>
            <span class="n">sentinelAbortFailover</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 本 Sentinel 作为领头，开始执行故障迁移操作...</span>

    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+elected-leader&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>

    <span class="c1">// 进入选择从服务器状态</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">=</span> <span class="n">SENTINEL_FAILOVER_STATE_SELECT_SLAVE</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+failover-state-select-slave&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 选择合适的从服务器作为新的主服务器</span>
<span class="kt">void</span> <span class="nf">sentinelFailoverSelectSlave</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 在旧主服务器所属的从服务器中，选择新服务器</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">sentinelSelectSlave</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>

    <span class="cm">/* We don&#39;t handle the timeout in this state as the function aborts</span>
<span class="cm">     * the failover or go forward in the next state. */</span>
    <span class="c1">// 没有合适的从服务器，直接终止故障转移操作</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">slave</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 没有可用的从服务器可以提升为新主服务器，故障转移操作无法执行</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;-failover-abort-no-good-slave&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>

        <span class="c1">// 中止故障转移</span>
        <span class="n">sentinelAbortFailover</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

        <span class="c1">// 成功选定新主服务器</span>

        <span class="c1">// 发送事件</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+selected-slave&quot;</span><span class="p">,</span><span class="n">slave</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>

        <span class="c1">// 打开实例的升级标记</span>
        <span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_PROMOTED</span><span class="p">;</span>

        <span class="c1">// 记录被选中的从服务器</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">promoted_slave</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>

        <span class="c1">// 更新故障转移状态</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">=</span> <span class="n">SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE</span><span class="p">;</span>

        <span class="c1">// 更新状态改变时间</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

        <span class="c1">// 发送事件</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;+failover-state-send-slaveof-noone&quot;</span><span class="p">,</span>
            <span class="n">slave</span><span class="p">,</span> <span class="s">&quot;%@&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 向被选中的从服务器发送 SLAVEOF no one 命令</span>
<span class="c1">// 将它升级为新的主服务器</span>
<span class="kt">void</span> <span class="nf">sentinelFailoverSendSlaveOfNoOne</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

    <span class="cm">/* We can&#39;t send the command to the promoted slave if it is now</span>
<span class="cm">     * disconnected. Retry again and again with this state until the timeout</span>
<span class="cm">     * is reached, then abort the failover. */</span>
    <span class="c1">// 如果选中的从服务器断线了，那么在给定的时间内重试</span>
    <span class="c1">// 如果给定时间内选中的从服务器也没有上线，那么终止故障迁移操作</span>
    <span class="c1">// （一般来说出现这种情况的机会很小，因为在选择新的主服务器时，</span>
    <span class="c1">// 已经断线的从服务器是不会被选中的，所以这种情况只会出现在</span>
    <span class="c1">// 从服务器被选中，并且发送 SLAVEOF NO ONE 命令之前的这段时间内）</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_DISCONNECTED</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 如果超过时限，就不再重试</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span> <span class="o">&gt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_timeout</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;-failover-abort-slave-timeout&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
            <span class="n">sentinelAbortFailover</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Send SLAVEOF NO ONE command to turn the slave into a master.</span>
<span class="cm">     *</span>
<span class="cm">     * 向被升级的从服务器发送 SLAVEOF NO ONE 命令，将它变为一个主服务器。</span>
<span class="cm">     *</span>
<span class="cm">     * We actually register a generic callback for this command as we don&#39;t</span>
<span class="cm">     * really care about the reply. We check if it worked indirectly observing</span>
<span class="cm">     * if INFO returns a different role (master instead of slave). </span>
<span class="cm">     *</span>
<span class="cm">     * 这里没有为命令回复关联一个回调函数，因为从服务器是否已经转变为主服务器可以</span>
<span class="cm">     * 通过向从服务器发送 INFO 命令来确认</span>
<span class="cm">     */</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">sentinelSendSlaveOf</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span> <span class="s">&quot;+failover-state-wait-promotion&quot;</span><span class="p">,</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>

    <span class="c1">// 更新状态</span>
    <span class="c1">// 这个状态会让 Sentinel 等待被选中的从服务器升级为主服务器</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">=</span> <span class="n">SENTINEL_FAILOVER_STATE_WAIT_PROMOTION</span><span class="p">;</span>

    <span class="c1">// 更新状态改变的时间</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* We actually wait for promotion indirectly checking with INFO when the</span>
<span class="cm"> * slave turns into a master. */</span>
<span class="c1">// Sentinel 会通过 INFO 命令的回复检查从服务器是否已经转变为主服务器</span>
<span class="c1">// 这里只负责检查时限</span>
<span class="kt">void</span> <span class="nf">sentinelFailoverWaitPromotion</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Just handle the timeout. Switching to the next state is handled</span>
<span class="cm">     * by the function parsing the INFO command of the promoted slave. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span> <span class="o">&gt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_timeout</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;-failover-abort-slave-timeout&quot;</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
        <span class="n">sentinelAbortFailover</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 判断故障转移操作是否结束</span>
<span class="c1">// 结束可以因为超时，也可以因为所有从服务器已经同步到新主服务器</span>
<span class="kt">void</span> <span class="nf">sentinelFailoverDetectEnd</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">not_reconfigured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>

    <span class="c1">// 上次 failover 状态更新以来，经过的时间</span>
    <span class="kt">mstime_t</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span><span class="p">;</span>

    <span class="cm">/* We can&#39;t consider failover finished if the promoted slave is</span>
<span class="cm">     * not reachable. */</span>
    <span class="c1">// 如果新主服务器已经下线，那么故障转移操作不成功</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="cm">/* The failover terminates once all the reachable slaves are properly</span>
<span class="cm">     * configured. */</span>
    <span class="c1">// 计算未完成同步的从服务器的数量</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="c1">// 新主服务器和已完成同步的从服务器不计算在内</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_PROMOTED</span><span class="o">|</span><span class="n">SRI_RECONF_DONE</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// 已下线的从服务器不计算在内</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_S_DOWN</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// 增一</span>
        <span class="n">not_reconfigured</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

    <span class="cm">/* Force end of failover on timeout. */</span>
    <span class="c1">// 故障操作因为超时而结束</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_timeout</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 忽略未完成的从服务器</span>
        <span class="n">not_reconfigured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="c1">// 打开超时标志</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="c1">// 发送超时事件</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+failover-end-for-timeout&quot;</span><span class="p">,</span><span class="n">master</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 所有从服务器都已完成同步，故障转移结束</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">not_reconfigured</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+failover-end&quot;</span><span class="p">,</span><span class="n">master</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
        <span class="c1">// 更新故障转移状态</span>
        <span class="c1">// 这一状态将告知 Sentinel ，所有从服务器都已经同步到新主服务器</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">=</span> <span class="n">SENTINEL_FAILOVER_STATE_UPDATE_CONFIG</span><span class="p">;</span>
        <span class="c1">// 更新状态改变的时间</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cm">/* If I&#39;m the leader it is a good idea to send a best effort SLAVEOF</span>
<span class="cm">     * command to all the slaves still not reconfigured to replicate with</span>
<span class="cm">     * the new master. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
        <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>

        <span class="c1">// 遍历所有从服务器</span>
        <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">);</span>
        <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
            <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

            <span class="c1">// 跳过已发送 SLAVEOF 命令，以及已经完成同步的所有从服务器</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">SRI_RECONF_DONE</span><span class="o">|</span><span class="n">SRI_RECONF_SENT</span><span class="o">|</span><span class="n">SRI_DISCONNECTED</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

            <span class="c1">// 发送命令</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">sentinelSendSlaveOf</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span>
                    <span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
                    <span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;+slave-reconf-sent-be&quot;</span><span class="p">,</span><span class="n">slave</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
                <span class="c1">// 打开从服务器的 SLAVEOF 命令已发送标记</span>
                <span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_RECONF_SENT</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Send SLAVE OF &lt;new master address&gt; to all the remaining slaves that</span>
<span class="cm"> * still don&#39;t appear to have the configuration updated. */</span>
<span class="c1">// 向所有尚未同步新主服务器的从服务器发送 SLAVEOF &lt;new-master-address&gt; 命令</span>
<span class="kt">void</span> <span class="nf">sentinelFailoverReconfNextSlave</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// 计算正在同步新主服务器的从服务器数量</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="c1">// SLAVEOF 命令已发送，或者同步正在进行</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_RECONF_SENT</span><span class="o">|</span><span class="n">SRI_RECONF_INPROG</span><span class="p">))</span>
            <span class="n">in_progress</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

    <span class="c1">// 如果正在同步的从服务器的数量少于 parallel-syncs 选项的值</span>
    <span class="c1">// 那么继续遍历从服务器，并让从服务器对新主服务器进行同步</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="n">in_progress</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">parallel_syncs</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

        <span class="cm">/* Skip the promoted slave, and already configured slaves. */</span>
        <span class="c1">// 跳过新主服务器，以及已经完成了同步的从服务器</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_PROMOTED</span><span class="o">|</span><span class="n">SRI_RECONF_DONE</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

        <span class="cm">/* Clear the SRI_RECONF_SENT flag if too much time elapsed without</span>
<span class="cm">         * the slave moving forward to the next state. */</span>
        <span class="c1">// 如果 SLAVEOF 命令已经发送了很久，但从服务器仍未完成同步</span>
        <span class="c1">// 那么尝试重新发送命令</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_RECONF_SENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">mstime</span><span class="p">()</span> <span class="o">-</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">slave_reconf_sent_time</span><span class="p">)</span> <span class="o">&gt;</span>
            <span class="n">SENTINEL_SLAVE_RECONF_RETRY_PERIOD</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 发送重拾同步事件</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;-slave-reconf-sent-timeout&quot;</span><span class="p">,</span><span class="n">slave</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
            <span class="c1">// 清除已发送 SLAVEOF 命令的标记</span>
            <span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRI_RECONF_SENT</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* Nothing to do for instances that are disconnected or already</span>
<span class="cm">         * in RECONF_SENT state. */</span>
        <span class="c1">// 如果已向从服务器发送 SLAVEOF 命令，或者同步正在进行</span>
        <span class="c1">// 又或者从服务器已断线，那么略过该服务器</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_DISCONNECTED</span><span class="o">|</span><span class="n">SRI_RECONF_SENT</span><span class="o">|</span><span class="n">SRI_RECONF_INPROG</span><span class="p">))</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="cm">/* Send SLAVEOF &lt;new master&gt;. */</span>
        <span class="c1">// 向从服务器发送 SLAVEOF 命令，让它同步新主服务器</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">sentinelSendSlaveOf</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span>
                <span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
                <span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// 将状态改为 SLAVEOF 命令已发送</span>
            <span class="n">slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRI_RECONF_SENT</span><span class="p">;</span>
            <span class="c1">// 更新发送 SLAVEOF 命令的时间</span>
            <span class="n">slave</span><span class="o">-&gt;</span><span class="n">slave_reconf_sent_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
            <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_NOTICE</span><span class="p">,</span><span class="s">&quot;+slave-reconf-sent&quot;</span><span class="p">,</span><span class="n">slave</span><span class="p">,</span><span class="s">&quot;%@&quot;</span><span class="p">);</span>
            <span class="c1">// 增加当前正在同步的从服务器的数量</span>
            <span class="n">in_progress</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

    <span class="cm">/* Check if all the slaves are reconfigured and handle timeout. */</span>
    <span class="c1">// 判断是否所有从服务器的同步都已经完成</span>
    <span class="n">sentinelFailoverDetectEnd</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function is called when the slave is in</span>
<span class="cm"> * SENTINEL_FAILOVER_STATE_UPDATE_CONFIG state. In this state we need</span>
<span class="cm"> * to remove it from the master table and add the promoted slave instead. */</span>
<span class="c1">// 这个函数在 master 已下线，并且对这个 master 的故障迁移操作已经完成时调用</span>
<span class="c1">// 这个 master 会被移除出 master 表格，并由新的主服务器代替</span>
<span class="kt">void</span> <span class="nf">sentinelFailoverSwitchToPromotedSlave</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">/// 选出要添加的 master</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ref</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">promoted_slave</span> <span class="o">?</span>
                                 <span class="n">master</span><span class="o">-&gt;</span><span class="nl">promoted_slave</span> <span class="p">:</span> <span class="n">master</span><span class="p">;</span>
    <span class="n">sds</span> <span class="n">old_master_ip</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">old_master_port</span><span class="p">;</span>

    <span class="c1">// 发送更新 master 事件</span>
    <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+switch-master&quot;</span><span class="p">,</span><span class="n">master</span><span class="p">,</span><span class="s">&quot;%s %s %d %s %d&quot;</span><span class="p">,</span>
        <span class="c1">// 原 master 信息</span>
        <span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
        <span class="c1">// 新 master 信息</span>
        <span class="n">ref</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

    <span class="c1">// 记录原 master 信息</span>
    <span class="n">old_master_ip</span> <span class="o">=</span> <span class="n">sdsdup</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
    <span class="n">old_master_port</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

    <span class="c1">// 用新主服务器的信息代替原 master 的信息</span>
    <span class="n">sentinelResetMasterAndChangeAddress</span><span class="p">(</span><span class="n">master</span><span class="p">,</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
    <span class="n">sdsfree</span><span class="p">(</span><span class="n">old_master_ip</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 执行故障转移</span>
<span class="kt">void</span> <span class="nf">sentinelFailoverStateMachine</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">redisAssert</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">);</span>

    <span class="c1">// master 未进入故障转移状态，直接返回</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 等待故障转移开始</span>
        <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_WAIT_START</span><span class="p">:</span>
            <span class="n">sentinelFailoverWaitStart</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="c1">// 选择新主服务器</span>
        <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_SELECT_SLAVE</span><span class="p">:</span>
            <span class="n">sentinelFailoverSelectSlave</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        
        <span class="c1">// 升级被选中的从服务器为新主服务器</span>
        <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE</span><span class="p">:</span>
            <span class="n">sentinelFailoverSendSlaveOfNoOne</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="c1">// 等待升级生效，如果升级超时，那么重新选择新主服务器</span>
        <span class="c1">// 具体情况请看 sentinelRefreshInstanceInfo 函数</span>
        <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_WAIT_PROMOTION</span><span class="p">:</span>
            <span class="n">sentinelFailoverWaitPromotion</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="c1">// 向从服务器发送 SLAVEOF 命令，让它们同步新主服务器</span>
        <span class="k">case</span> <span class="nl">SENTINEL_FAILOVER_STATE_RECONF_SLAVES</span><span class="p">:</span>
            <span class="n">sentinelFailoverReconfNextSlave</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Abort a failover in progress:</span>
<span class="cm"> *</span>
<span class="cm"> * 关于中途停止执行故障转移：</span>
<span class="cm"> *</span>
<span class="cm"> * This function can only be called before the promoted slave acknowledged</span>
<span class="cm"> * the slave -&gt; master switch. Otherwise the failover can&#39;t be aborted and</span>
<span class="cm"> * will reach its end (possibly by timeout). </span>
<span class="cm"> *</span>
<span class="cm"> * 这个函数只能在被选中的从服务器升级为新的主服务器之前调用，</span>
<span class="cm"> * 否则故障转移就不能中途停止，</span>
<span class="cm"> * 并且会一直执行到结束。</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sentinelAbortFailover</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">redisAssert</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="p">);</span>
    <span class="n">redisAssert</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">&lt;=</span> <span class="n">SENTINEL_FAILOVER_STATE_WAIT_PROMOTION</span><span class="p">);</span>

    <span class="c1">// 移除相关标识</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SRI_FAILOVER_IN_PROGRESS</span><span class="o">|</span><span class="n">SRI_FORCE_FAILOVER</span><span class="p">);</span>

    <span class="c1">// 清除状态</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">=</span> <span class="n">SENTINEL_FAILOVER_STATE_NONE</span><span class="p">;</span>
    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state_change_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

    <span class="c1">// 清除新主服务器的升级标识</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">promoted_slave</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRI_PROMOTED</span><span class="p">;</span>
        <span class="c1">// 清空新服务器</span>
        <span class="n">ri</span><span class="o">-&gt;</span><span class="n">promoted_slave</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ======================== SENTINEL timer handler ==========================</span>
<span class="cm"> * This is the &quot;main&quot; our Sentinel, being sentinel completely non blocking</span>
<span class="cm"> * in design. The function is called every second.</span>
<span class="cm"> * -------------------------------------------------------------------------- */</span>

<span class="cm">/* Perform scheduled operations for the specified Redis instance. */</span>
<span class="c1">// 对给定的实例执行定期操作</span>
<span class="kt">void</span> <span class="nf">sentinelHandleRedisInstance</span><span class="p">(</span><span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* ========== MONITORING HALF ============ */</span>
    <span class="cm">/* ==========     监控操作    =========*/</span>

    <span class="cm">/* Every kind of instance */</span>
    <span class="cm">/* 对所有类型实例进行处理 */</span>

    <span class="c1">// 如果有需要的话，创建连向实例的网络连接</span>
    <span class="n">sentinelReconnectInstance</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>

    <span class="c1">// 根据情况，向实例发送 PING、 INFO 或者 PUBLISH 命令</span>
    <span class="n">sentinelPingInstance</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>

    <span class="cm">/* ============== ACTING HALF ============= */</span>
    <span class="cm">/* ==============  故障检测   ============= */</span>

    <span class="cm">/* We don&#39;t proceed with the acting half if we are in TILT mode.</span>
<span class="cm">     * TILT happens when we find something odd with the time, like a</span>
<span class="cm">     * sudden change in the clock. */</span>
    <span class="c1">// 如果 Sentinel 处于 TILT 模式，那么不执行故障检测。</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">tilt</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 如果 TILI 模式未解除，那么不执行动作</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mstime</span><span class="p">()</span><span class="o">-</span><span class="n">sentinel</span><span class="p">.</span><span class="n">tilt_start_time</span> <span class="o">&lt;</span> <span class="n">SENTINEL_TILT_PERIOD</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="c1">// 时间已过，退出 TILT 模式</span>
        <span class="n">sentinel</span><span class="p">.</span><span class="n">tilt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;-tilt&quot;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="s">&quot;#tilt mode exited&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Every kind of instance */</span>
    <span class="c1">// 检查给定实例是否进入 SDOWN 状态</span>
    <span class="n">sentinelCheckSubjectivelyDown</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>

    <span class="cm">/* Masters and slaves */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRI_MASTER</span><span class="o">|</span><span class="n">SRI_SLAVE</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* Nothing so far. */</span>
    <span class="p">}</span>

    <span class="cm">/* Only masters */</span>
    <span class="cm">/* 对主服务器进行处理 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 判断 master 是否进入 ODOWN 状态</span>
        <span class="n">sentinelCheckObjectivelyDown</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>

        <span class="c1">// 如果主服务器进入了 ODOWN 状态，那么开始一次故障转移操作</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sentinelStartFailoverIfNeeded</span><span class="p">(</span><span class="n">ri</span><span class="p">))</span>
            <span class="c1">// 强制向其他 Sentinel 发送 SENTINEL is-master-down-by-addr 命令</span>
            <span class="c1">// 刷新其他 Sentinel 关于主服务器的状态</span>
            <span class="n">sentinelAskMasterStateToOtherSentinels</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">SENTINEL_ASK_FORCED</span><span class="p">);</span>

        <span class="c1">// 执行故障转移</span>
        <span class="n">sentinelFailoverStateMachine</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>

        <span class="c1">// 如果有需要的话，向其他 Sentinel 发送 SENTINEL is-master-down-by-addr 命令</span>
        <span class="c1">// 刷新其他 Sentinel 关于主服务器的状态</span>
        <span class="c1">// 这一句是对那些没有进入 if(sentinelStartFailoverIfNeeded(ri)) { /* ... */ }</span>
        <span class="c1">// 语句的主服务器使用的</span>
        <span class="n">sentinelAskMasterStateToOtherSentinels</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">SENTINEL_NO_FLAGS</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Perform scheduled operations for all the instances in the dictionary.</span>
<span class="cm"> * Recursively call the function against dictionaries of slaves. */</span>
<span class="c1">// 对被 Sentinel 监视的所有实例（包括主服务器、从服务器和其他 Sentinel ）</span>
<span class="c1">// 进行定期操作</span>
<span class="c1">//</span>
<span class="c1">//  sentinelHandleRedisInstance</span>
<span class="c1">//              |</span>
<span class="c1">//              |</span>
<span class="c1">//              v</span>
<span class="c1">//            master</span>
<span class="c1">//             /  \</span>
<span class="c1">//            /    \</span>
<span class="c1">//           v      v</span>
<span class="c1">//       slaves    sentinels</span>
<span class="kt">void</span> <span class="nf">sentinelHandleDictOfRedisInstances</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
    <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">switch_to_promoted</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* There are a number of things we need to perform against every master. */</span>
    <span class="c1">// 遍历多个实例，这些实例可以是多个主服务器、多个从服务器或者多个 sentinel</span>
    <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">instances</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 取出实例对应的实例结构</span>
        <span class="n">sentinelRedisInstance</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="c1">// 执行调度操作</span>
        <span class="n">sentinelHandleRedisInstance</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>

        <span class="c1">// 如果被遍历的是主服务器，那么递归地遍历该主服务器的所有从服务器</span>
        <span class="c1">// 以及所有 sentinel</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRI_MASTER</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// 所有从服务器</span>
            <span class="n">sentinelHandleDictOfRedisInstances</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">slaves</span><span class="p">);</span>

            <span class="c1">// 所有 sentinel</span>
            <span class="n">sentinelHandleDictOfRedisInstances</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">sentinels</span><span class="p">);</span>

            <span class="c1">// 对已下线主服务器（ri）的故障迁移已经完成</span>
            <span class="c1">// ri 的所有从服务器都已经同步到新主服务器</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">failover_state</span> <span class="o">==</span> <span class="n">SENTINEL_FAILOVER_STATE_UPDATE_CONFIG</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 已选出新的主服务器</span>
                <span class="n">switch_to_promoted</span> <span class="o">=</span> <span class="n">ri</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 将原主服务器（已下线）从主服务器表格中移除，并使用新主服务器代替它</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">switch_to_promoted</span><span class="p">)</span>
        <span class="n">sentinelFailoverSwitchToPromotedSlave</span><span class="p">(</span><span class="n">switch_to_promoted</span><span class="p">);</span>

    <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function checks if we need to enter the TITL mode.</span>
<span class="cm"> *</span>
<span class="cm"> * 这个函数检查 sentinel 是否需要进入 TITL 模式。</span>
<span class="cm"> *</span>
<span class="cm"> * The TILT mode is entered if we detect that between two invocations of the</span>
<span class="cm"> * timer interrupt, a negative amount of time, or too much time has passed.</span>
<span class="cm"> *</span>
<span class="cm"> * 当程序发现两次执行 sentinel 之间的时间差为负值，或者过大时，</span>
<span class="cm"> * 就会进入 TILT 模式。</span>
<span class="cm"> *</span>
<span class="cm"> * Note that we expect that more or less just 100 milliseconds will pass</span>
<span class="cm"> * if everything is fine. However we&#39;ll see a negative number or a</span>
<span class="cm"> * difference bigger than SENTINEL_TILT_TRIGGER milliseconds if one of the</span>
<span class="cm"> * following conditions happen:</span>
<span class="cm"> *</span>
<span class="cm"> * 通常来说，两次执行 sentinel 之间的差会在 100 毫秒左右，</span>
<span class="cm"> * 但当出现以下内容时，这个差就可能会出现异常：</span>
<span class="cm"> *</span>
<span class="cm"> * 1) The Sentinel process for some time is blocked, for every kind of</span>
<span class="cm"> * random reason: the load is huge, the computer was frozen for some time</span>
<span class="cm"> * in I/O or alike, the process was stopped by a signal. Everything.</span>
<span class="cm"> *    sentinel 进程因为某些原因而被阻塞，比如载入的数据太大，计算机 I/O 任务繁重，</span>
<span class="cm"> *    进程被信号停止，诸如此类。</span>
<span class="cm"> *</span>
<span class="cm"> * 2) The system clock was altered significantly.</span>
<span class="cm"> *    系统的时钟产生了非常明显的变化。</span>
<span class="cm"> *</span>
<span class="cm"> * Under both this conditions we&#39;ll see everything as timed out and failing</span>
<span class="cm"> * without good reasons. Instead we enter the TILT mode and wait</span>
<span class="cm"> * for SENTINEL_TILT_PERIOD to elapse before starting to act again.</span>
<span class="cm"> *</span>
<span class="cm"> * 当出现以上两种情况时， sentinel 可能会将任何实例都视为掉线，并无原因地判断实例为失效。</span>
<span class="cm"> * 为了避免这种情况，我们让 sentinel 进入 TILT 模式，</span>
<span class="cm"> * 停止进行任何动作，并等待 SENTINEL_TILT_PERIOD 秒钟。 </span>
<span class="cm"> *</span>
<span class="cm"> * During TILT time we still collect information, we just do not act. </span>
<span class="cm"> *</span>
<span class="cm"> * TILT 模式下的 sentinel 仍然会进行监控并收集信息，</span>
<span class="cm"> * 它只是不执行诸如故障转移、下线判断之类的操作而已。</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sentinelCheckTiltCondition</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 计算当前时间</span>
    <span class="kt">mstime_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

    <span class="c1">// 计算上次运行 sentinel 和当前时间的差</span>
    <span class="kt">mstime_t</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">sentinel</span><span class="p">.</span><span class="n">previous_time</span><span class="p">;</span>

    <span class="c1">// 如果差为负数，或者大于 2 秒钟，那么进入 TILT 模式</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">SENTINEL_TILT_TRIGGER</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 打开标记</span>
        <span class="n">sentinel</span><span class="p">.</span><span class="n">tilt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="c1">// 记录进入 TILT 模式的开始时间</span>
        <span class="n">sentinel</span><span class="p">.</span><span class="n">tilt_start_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
        <span class="c1">// 打印事件</span>
        <span class="n">sentinelEvent</span><span class="p">(</span><span class="n">REDIS_WARNING</span><span class="p">,</span><span class="s">&quot;+tilt&quot;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="s">&quot;#tilt mode entered&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 更新最后一次 sentinel 运行时间</span>
    <span class="n">sentinel</span><span class="p">.</span><span class="n">previous_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// sentinel 模式的主函数，由 redis.c/serverCron 函数调用</span>
<span class="kt">void</span> <span class="nf">sentinelTimer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 记录本次 sentinel 调用的事件，</span>
    <span class="c1">// 并判断是否需要进入 TITL 模式</span>
    <span class="n">sentinelCheckTiltCondition</span><span class="p">();</span>

    <span class="c1">// 执行定期操作</span>
    <span class="c1">// 比如 PING 实例、分析主服务器和从服务器的 INFO 命令</span>
    <span class="c1">// 向其他监视相同主服务器的 sentinel 发送问候信息</span>
    <span class="c1">// 并接收其他 sentinel 发来的问候信息</span>
    <span class="c1">// 执行故障转移操作，等等</span>
    <span class="n">sentinelHandleDictOfRedisInstances</span><span class="p">(</span><span class="n">sentinel</span><span class="p">.</span><span class="n">masters</span><span class="p">);</span>

    <span class="c1">// 运行等待执行的脚本</span>
    <span class="n">sentinelRunPendingScripts</span><span class="p">();</span>

    <span class="c1">// 清理已执行完毕的脚本，并重试出错的脚本</span>
    <span class="n">sentinelCollectTerminatedScripts</span><span class="p">();</span>

    <span class="c1">// 杀死运行超时的脚本</span>
    <span class="n">sentinelKillTimedoutScripts</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>



            <div class="section" id="discuss">

    <h2>
        留言
        <a class="headerlink" href="#discuss" title="永久链接至标题">¶</a>
    </h2>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'notehuangzme'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="replication.html"
                        title="previous chapter">复制（replication）</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="cluster.html"
                        title="next chapter">集群（cluster）</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
        &copy; Copyright 2014, huangz.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3b1.
    </div>
  </body>
</html>