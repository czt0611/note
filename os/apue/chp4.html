<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>第 4 章：文件和目录 &mdash; huangz/note</title>
    
    <link rel="stylesheet" href="../../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'present',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="huangz/note" href="../../index.html" />
    <link rel="up" title="《UNIX 环境高级编程》笔记" href="index.html" />
    <link rel="next" title="第 8 章：进程控制" href="chp8.html" />
    <link rel="prev" title="第 3 章：文件 I/O" href="chp3.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->





</head>
<body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="chp8.html" title="第 8 章：进程控制"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="chp3.html" title="第 3 章：文件 I/O"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">huangz/note</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">《UNIX 环境高级编程》笔记</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="id1">
<h1>第 4 章：文件和目录<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id2">
<h2>获取文件信息<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>使用以下函数可以获取一个指定文件的相关信息：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>

<span class="kt">int</span> <span class="nf">stat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">fstat</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">lstat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">stat</span></code> 取出 <code class="docutils literal"><span class="pre">path</span></code> 文件的相关信息，并将它保存到 <code class="docutils literal"><span class="pre">buf</span></code> 中。</p>
<p><code class="docutils literal"><span class="pre">lstat</span></code> 和 <code class="docutils literal"><span class="pre">stat</span></code> 类似，唯一的不同是，如果 <code class="docutils literal"><span class="pre">path</span></code> 是一个符号链接（symbolic link），
那么 <code class="docutils literal"><span class="pre">lstat</span></code> 返回的是链接文件的信息，而不是链接所指向的文件的信息。</p>
<p><code class="docutils literal"><span class="pre">fstat</span></code> 和 <code class="docutils literal"><span class="pre">stat</span></code> 类似，唯一的不同是， <code class="docutils literal"><span class="pre">fstat</span></code> 接受的参数是文件描述符 <code class="docutils literal"><span class="pre">fd</span></code> ，而不是文件的路径。</p>
<p>以上三个函数在执行成功时，返回 <code class="docutils literal"><span class="pre">0</span></code> ，失败时，返回 <code class="docutils literal"><span class="pre">-1</span></code> ，并将错误原因设置到 <code class="docutils literal"><span class="pre">errno</span></code> 。</p>
</div>
<div class="section" id="id3">
<h2>获取文件信息所需的权限<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>除了使用 <code class="docutils literal"><span class="pre">stat</span></code> 和 <code class="docutils literal"><span class="pre">lstat</span></code> 对文件进行查看时，需要对路径上的所有文件夹有执行（查找）权限之外，
调用这些函数无须任何其他权限。</p>
<p>举个例子，要成功调用 <code class="docutils literal"><span class="pre">stat(&quot;/foo/bar/spam&quot;,</span> <span class="pre">buf);</span></code> ，必须对 <code class="docutils literal"><span class="pre">foo</span></code> 和 <code class="docutils literal"><span class="pre">bar</span></code> 文件夹都拥有执行权限。</p>
</div>
<div class="section" id="id4">
<h2>文件信息<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">stat</span></code> 等三个函数将文件的信息保存到一个 <code class="docutils literal"><span class="pre">struct</span> <span class="pre">stat</span></code> 类型的结构中，这个结构包含以下域：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">struct</span> <span class="n">stat</span> <span class="p">{</span>
    <span class="kt">dev_t</span>     <span class="n">st_dev</span><span class="p">;</span>     <span class="c1">// 包含文件的设备的 ID</span>
    <span class="kt">ino_t</span>     <span class="n">st_ino</span><span class="p">;</span>     <span class="c1">// i-node 号码</span>
    <span class="kt">mode_t</span>    <span class="n">st_mode</span><span class="p">;</span>    <span class="c1">// 文件的访问权限、以及文件的类型</span>
    <span class="kt">nlink_t</span>   <span class="n">st_nlink</span><span class="p">;</span>   <span class="c1">// 硬链接（hard links）的数量</span>
    <span class="kt">uid_t</span>     <span class="n">st_uid</span><span class="p">;</span>     <span class="c1">// 拥有者的用户 ID</span>
    <span class="kt">gid_t</span>     <span class="n">st_gid</span><span class="p">;</span>     <span class="c1">// 拥有者的组 ID</span>
    <span class="kt">dev_t</span>     <span class="n">st_rdev</span><span class="p">;</span>    <span class="c1">// 设备 ID （只在文件是特殊文件时使用）</span>
    <span class="kt">off_t</span>     <span class="n">st_size</span><span class="p">;</span>    <span class="c1">// 文件的大小（以字节计算）</span>
    <span class="kt">blksize_t</span> <span class="n">st_blksize</span><span class="p">;</span> <span class="c1">// 推荐 I/O 操作对文件使用的块大小</span>
    <span class="kt">blkcnt_t</span>  <span class="n">st_blocks</span><span class="p">;</span>  <span class="c1">// 文件占用的块数量（每块 512 字节）</span>
    <span class="kt">time_t</span>    <span class="n">st_atime</span><span class="p">;</span>   <span class="c1">// 文件数据最后访问时间（例如 read）</span>
    <span class="kt">time_t</span>    <span class="n">st_mtime</span><span class="p">;</span>   <span class="c1">// 文件数据最后修改时间（例如 write）</span>
    <span class="kt">time_t</span>    <span class="n">st_ctime</span><span class="p">;</span>   <span class="c1">// 文件的 i 节点最后一次被修改的时间（例如 chmod）</span>
<span class="p">};</span>
</pre></div>
</div>
<p>以下分多个小节介绍各个域的相关信息。</p>
</div>
<div class="section" id="id5">
<h2>文件类型<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">stat.st_mode</span></code> 属性包含了文件的访问权限，以及文件的类型。</p>
<p>文件的类型可以是：</p>
<ol class="arabic simple">
<li><strong>普通文件</strong>（regular file）：包含了某种形式的数据。这种数据是文本还是二进制数据对于内核而言并无区别，因为对普通文件内容的解释是由处理该文件的应用程序执行的。</li>
<li><strong>目录文件</strong>（directory file）：包含了目录中所有文件的名字，以及指向文件相关信息的指针。</li>
<li><strong>块特殊文件</strong>（block special file）：对设备（比如磁盘）提供带缓冲的访问，每次访问以固定长度为单位进行。</li>
<li><strong>字符特殊文件</strong>（character special file）：对设备提供不带缓冲的访问，每次访问长度可变。系统中的设备要么是字符串特殊文件，要么是块特殊文件。</li>
<li><strong>先进先出队列</strong>（FIFO）：用于进程间通信，有时也将其称为命名管道（named pipe）。</li>
<li><strong>套接字</strong>（socket）：用于进程间的网络通信，也可以在同一台主机的进程上进行非网络通信。</li>
<li><strong>符号链接</strong>（symbolic link）：指向另一个文件。</li>
</ol>
<p><code class="docutils literal"><span class="pre">sys/stat.h</span></code> 文件提供了一组宏，通过它们对 <code class="docutils literal"><span class="pre">stat.st_mode</span></code> 的值进行判断，可以获得文件的类型：</p>
<table border="1" class="docutils">
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">宏</th>
<th class="head">进行的检查</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">S_ISREG(m)</span></code></td>
<td>普通文件？</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">S_ISDIR(m)</span></code></td>
<td>目录？</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">S_ISBLK(m)</span></code></td>
<td>块设备？</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">S_ISCHR(m)</span></code></td>
<td>字符串设备？</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">S_ISFIFO(m)</span></code></td>
<td>FIFO 设备？</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">S_ISSOCK(m)</span></code></td>
<td>套接字？</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">S_ISLNK(m)</span></code></td>
<td>符号链接？</td>
</tr>
</tbody>
</table>
<p>以下程序读入一个文件路径，并打印该文件的类型：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// 4-print-type.c</span>

<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: ./a.out filepath</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">file</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;get file %s info fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;regular</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;character device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;block device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;FIFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;symbolic link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISSOCK</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;socket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;unknow type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>执行结果：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ./4-print-type.out /dev/null
character device

$ ./4-print-type.out /dev/sda
block device

$ ./4-print-type.out /
directory

$ ./4-print-type.out 4-print-type.c       // 纯文本
regular

$ ./4-print-type.out 4-print-type.out     // 二进制
regular
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h2>另一种获取文件类型的方法<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>除了使用 <code class="docutils literal"><span class="pre">S_ISXXX</span></code> 宏之外，还可以用 <code class="docutils literal"><span class="pre">st_mode</span></code> 属性和 <code class="docutils literal"><span class="pre">S_IFMT</span></code> 屏蔽位做二进制求并计算，
然后通过计算结果判断文件的类型：</p>
<table border="1" class="docutils">
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><code class="docutils literal"><span class="pre">st_mode</span> <span class="pre">&amp;</span> <span class="pre">S_IFMT</span></code> 的值</th>
<th class="head">文件类型</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">S_IFSOCK</span></code></td>
<td>套接字</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">S_IFLNK</span></code></td>
<td>符号链接</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">S_IFREG</span></code></td>
<td>普通文件</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">S_IFBLK</span></code></td>
<td>块设备</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">S_IFDIR</span></code></td>
<td>文件夹</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">S_IFCHR</span></code></td>
<td>字符设备</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">S_IFIFO</span></code></td>
<td>FIFO</td>
</tr>
</tbody>
</table>
<p>除了 <code class="docutils literal"><span class="pre">S_IFIFO</span></code> 之外，表中的常量 <code class="docutils literal"><span class="pre">S_IFXXX</span></code> 和前面的宏命名 <code class="docutils literal"><span class="pre">S_ISXXX</span></code> 是保持一致的。</p>
<p>实际上 <code class="docutils literal"><span class="pre">S_ISXXX</span></code> 宏就是用这些位运算来定义的。</p>
<p>以下是使用这一判断方式的程序：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// 4-printf-type-2.c</span>

<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: ./a.out filepath</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">file</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;get file %s info fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">S_IFREG</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;regular</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">S_IFDIR</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">S_IFCHR</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;character device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">S_IFBLK</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;block device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">S_IFIFO</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;FIFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">S_IFLNK</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;symbolic link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">S_IFSOCK</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;socket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;unknow type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>执行结果：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ./4-print-type-2.out /dev/sda
block device

$ ./4-print-type-2.out /dev/null
character device

$ ./4-print-type-2.out /
directory

$ ./4-print-type-2.out 4-print-type-2.out
regular

$ ./4-print-type-2.out 4-print-type-2.c
regular
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2>文件所有者<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>文件所有者的用户 ID 和组 ID 分别保存在 <code class="docutils literal"><span class="pre">st_uid</span></code> 和 <code class="docutils literal"><span class="pre">st_gid</span></code> 中。</p>
<p>以下程序打印出文件所有者的用户 ID 以及组 ID ：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// 4-owner-c</span>

<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="c1">// 1) check argument</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: ./a.out filepath</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 2) get file info</span>

    <span class="k">struct</span> <span class="n">stat</span> <span class="n">file</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;get file %s info fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 3) print owner info</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;file owner uid = %u , gid = %u .</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">st_uid</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">st_gid</span><span class="p">);</span>

    <span class="c1">// 4)</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>执行：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ./4-owner.out 4-owner.c
file owner uid = 1000 , gid = 1000 .

$ ./4-owner.out /
file owner uid = 0 , gid = 0 .
</pre></div>
</div>
</div>
<div class="section" id="id-id">
<h2>修改所有者的用户 ID 和组 ID<a class="headerlink" href="#id-id" title="Permalink to this headline">¶</a></h2>
<p>以下函数可以用于更改文件的用户 ID 和组 ID ：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#include &lt;unistd.h&gt;</span>

<span class="kt">int</span> <span class="nf">chown</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">uid_t</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">gid_t</span> <span class="n">group</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">fchown</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">uid_t</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">gid_t</span> <span class="n">group</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">lchown</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">uid_t</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">gid_t</span> <span class="n">group</span><span class="p">);</span>

<span class="c1">// 设置成功返回 0 ，失败返回 -1 ，并将错误代码设置到 errno</span>
</pre></div>
</div>
<p>三个函数的作用都是类似的，区别在于：</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">chown</span></code> 和 <code class="docutils literal"><span class="pre">lchown</span></code> 修改的是给定路径上的文件，而 <code class="docutils literal"><span class="pre">fchown</span></code> 修改的则是给定的文件描述符。</li>
<li><code class="docutils literal"><span class="pre">chown</span></code> 在遇上符号链接时，修改的是符号链接所指向的文件，而 <code class="docutils literal"><span class="pre">lchown</span></code> 则修改符号链接本身。</li>
</ul>
<p><code class="docutils literal"><span class="pre">owner</span></code> 和 <code class="docutils literal"><span class="pre">group</span></code> 参数用于指定文件的新用户 ID 和新组 ID ，
如果 <code class="docutils literal"><span class="pre">owner</span></code> / <code class="docutils literal"><span class="pre">group</span></code> 参数的值为 <code class="docutils literal"><span class="pre">-1</span></code> ，那么维持该文件原有的用户/组 ID 不变。</p>
<p>以下程序将给定文件的用户 ID 和组 ID 都设为 <code class="docutils literal"><span class="pre">0</span></code> ，也即是，将给定文件的用户和组都设置为 root ：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// 4-change-owner.c</span>

<span class="cp">#include &lt;unistd.h&gt; </span><span class="c1">// chown</span>
<span class="cp">#include &lt;stdio.h&gt;  </span><span class="c1">// printf, perror</span>

<span class="cp">#define ROOT_UID 0</span>
<span class="cp">#define ROOT_GID 0</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="c1">// 1)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: ./a.out filepath&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 2)</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">chown</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">ROOT_UID</span><span class="p">,</span> <span class="n">ROOT_GID</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;Change owner fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 3)</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>执行结果：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ls -l /tmp/ttt
-rw-rw-r-- 1 huangz huangz 0  1月 24 10:27 /tmp/ttt

$ ./a.out /tmp/ttt
Change owner fail: Operation not permitted

$ sudo ./a.out /tmp/ttt

$ ls -l /tmp/ttt
-rw-rw-r-- 1 root root 0  1月 24 10:27 /tmp/ttt
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">一般来说，需要有 root 权限才能修改文件的所有者。</p>
</div>
</div>
<div class="section" id="id8">
<h2>文件的权限<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>文件的权限保存在 <code class="docutils literal"><span class="pre">st_mode</span></code> 属性当中，通过和以下常量做二进制并计算，可以检查文件是否拥有某种特定权限：</p>
<p><strong>拥有者</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">常量</th>
<th class="head">含义</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>S_IRWXU</td>
<td>mask for file owner permissions</td>
</tr>
<tr class="row-odd"><td>S_IRUSR</td>
<td>owner has read permission</td>
</tr>
<tr class="row-even"><td>S_IWUSR</td>
<td>owner has write permission</td>
</tr>
<tr class="row-odd"><td>S_IXUSR</td>
<td>owner has execute permission</td>
</tr>
</tbody>
</table>
<p><strong>组</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">常量</th>
<th class="head">含义</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>S_IRWXG</td>
<td>mask for group permissions</td>
</tr>
<tr class="row-odd"><td>S_IRGRP</td>
<td>group has read permission</td>
</tr>
<tr class="row-even"><td>S_IWGRP</td>
<td>group has write permission</td>
</tr>
<tr class="row-odd"><td>S_IXGRP</td>
<td>group has execute permission</td>
</tr>
</tbody>
</table>
<p><strong>其他人</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">常量</th>
<th class="head">含义</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>S_IRWXO</td>
<td>mask for permissions for others (not in group)</td>
</tr>
<tr class="row-odd"><td>S_IROTH</td>
<td>others have read permission</td>
</tr>
<tr class="row-even"><td>S_IWOTH</td>
<td>others have write permission</td>
</tr>
<tr class="row-odd"><td>S_IXOTH</td>
<td>others have execute permission</td>
</tr>
</tbody>
</table>
<p>以下程序演示了如何以数字形式打印文件的权限：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// 4-permission.c</span>

<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="cp">#define READ_PERMISSION 4</span>
<span class="cp">#define WRITE_PERMISSION 2</span>
<span class="cp">#define EXECUTE_PERMISSION 1</span>

<span class="cp">#define RWX_PERMISSION 7</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
   
    <span class="c1">// 1) check argument</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: ./a.out filepath&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 2) get file info</span>

    <span class="k">struct</span> <span class="n">stat</span> <span class="n">file</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;get file info fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 3) test permission</span>

    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// owner test</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IRWXU</span> <span class="o">==</span> <span class="n">S_IRWXU</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="n">RWX_PERMISSION</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IRUSR</span><span class="p">)</span> 
            <span class="n">owner</span> <span class="o">+=</span> <span class="n">READ_PERMISSION</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IWUSR</span><span class="p">)</span>
            <span class="n">owner</span> <span class="o">+=</span> <span class="n">WRITE_PERMISSION</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IXUSR</span><span class="p">)</span>
            <span class="n">owner</span> <span class="o">+=</span> <span class="n">EXECUTE_PERMISSION</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// group test</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IRWXG</span> <span class="o">==</span> <span class="n">S_IRWXG</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">RWX_PERMISSION</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IRGRP</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">+=</span> <span class="n">READ_PERMISSION</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IWGRP</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">+=</span> <span class="n">WRITE_PERMISSION</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IXGRP</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">+=</span> <span class="n">EXECUTE_PERMISSION</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// other test</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IRWXO</span> <span class="o">==</span> <span class="n">S_IRWXO</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">RWX_PERMISSION</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IROTH</span><span class="p">)</span>
            <span class="n">other</span> <span class="o">+=</span> <span class="n">READ_PERMISSION</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IWOTH</span><span class="p">)</span>
            <span class="n">other</span> <span class="o">+=</span> <span class="n">WRITE_PERMISSION</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IXOTH</span><span class="p">)</span>
            <span class="n">other</span> <span class="o">+=</span> <span class="n">EXECUTE_PERMISSION</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 4) print permission</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;file %s permission = %u%u%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">other</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>执行：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ls -l /tmp/t
-rw-rw-r-- 1 huangz huangz 0  1月 24 00:52 /tmp/t

$ ./4-permission.out /tmp/t
file /tmp/t permission = 664

$ chmod u+x /tmp/t

$ ls -l /tmp/t
-rwxrw-r-- 1 huangz huangz 0  1月 24 00:52 /tmp/t

$ ./4-permission.out /tmp/t
file /tmp/t permission = 764
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h2>特殊权限<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>除了上一节提到的访问权限之外，文件还可以带有设置用户 ID 位（set-user-ID bit）、设置组 ID 位（set-group-ID bit）和粘住位（sticky bit）三种特殊权限。</p>
<p>设置用户 ID 位用于在进程执行文件时，将进程的有效用户 ID 设置为文件所有者的用户 ID （<code class="docutils literal"><span class="pre">st_uid</span></code>）。</p>
<p>与此类似，设置用户 ID 用于在进程执行文件时，将进程的有效组 ID 设置为文件所有者的组 ID （<code class="docutils literal"><span class="pre">st_gid</span></code>）。</p>
<p><code class="docutils literal"><span class="pre">passwd</span></code> 程序是设置用户 ID 的一个例子：这个程序让任何用户都可以修改密码，但对密码文件的实际写入工作，却是通过设置位 ID 获得的 root 权限来执行的。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">关于有效用户 ID 和实际用户 ID 等讨论，请参见进程相关章节。</p>
</div>
<p>粘住位作用于文件夹，当一个文件夹设置了粘住位之后，要对文件夹中的文件进行改名或者删除，必须满足以下任一条件：</p>
<ul class="simple">
<li>当前用户是文件的所有者（owner）</li>
<li>当前用户是文件夹的所有者</li>
<li>特权进程</li>
</ul>
<p>作为例子， <code class="docutils literal"><span class="pre">/tmp</span></code> 文件通过使用粘住位，确保文件夹中的临时文件一般情况下只能被创建者自己删除。</p>
<p>和检查访问权限一样，相应的特殊权限也可以通过对 <code class="docutils literal"><span class="pre">st_mode</span></code> 属性做二进制并计算来得出：</p>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">常量</th>
<th class="head">含义</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>S_ISUID</td>
<td>设置用户 ID 位</td>
</tr>
<tr class="row-odd"><td>S_ISGID</td>
<td>设置组 ID 位</td>
</tr>
<tr class="row-even"><td>S_ISVTX</td>
<td>设置粘住位</td>
</tr>
</tbody>
</table>
<p>以下程序检查给定文件是否设置了以上三个特殊权限：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// 4-special-permission.c</span>

<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>

<span class="kt">void</span> <span class="nf">print_set_or_not</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">bit_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_set</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="c1">// check argument</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;usage: ./a.out filepath</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// get file info</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">file</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;Get file info fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// check regular file</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>

        <span class="n">print_set_or_not</span><span class="p">(</span>
            <span class="s">&quot;set-user-ID&quot;</span><span class="p">,</span>
            <span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_ISUID</span> <span class="o">==</span> <span class="n">S_ISUID</span>
        <span class="p">);</span>

        <span class="n">print_set_or_not</span><span class="p">(</span>
            <span class="s">&quot;set-group-ID&quot;</span><span class="p">,</span> 
            <span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_ISGID</span> <span class="o">==</span> <span class="n">S_ISGID</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// check directory</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>

        <span class="n">print_set_or_not</span><span class="p">(</span>
            <span class="s">&quot;sticky&quot;</span><span class="p">,</span>
            <span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_ISVTX</span> <span class="o">==</span> <span class="n">S_ISVTX</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_set_or_not</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">bit_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_set</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s bit is &quot;</span><span class="p">,</span> <span class="n">bit_name</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">is_set</span><span class="p">)</span> 
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;set&quot;</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;not set&quot;</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>执行：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ./a.out /tmp
sticky bit is set

$ ./a.out /usr/bin/passwd
set-user-ID bit is set
set-group-ID bit is set

$ ./a.out 4-special-permission.c
set-user-ID bit is not set
set-group-ID bit is not set
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h2>设置权限<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<p>设置文件权限的工作可以使用 <code class="docutils literal"><span class="pre">chmod</span></code> 或者 <code class="docutils literal"><span class="pre">fchmod</span></code> 两个函数来完成，其中前者输入文件的路径，而后者输入文件描述符：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#include &lt;sys/stat.h&gt;</span>

<span class="kt">int</span> <span class="nf">chmod</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">mode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">fchmod</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">mode_t</span> <span class="n">mode</span><span class="p">);</span>

<span class="c1">// 执行成功返回 0 ，失败返回 -1</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">mode</span></code> 参数的值可以是前面提到的，任意和权限相关的 <code class="docutils literal"><span class="pre">S_IXXXX</span></code> 常量的二进制或，比如 <code class="docutils literal"><span class="pre">S_ISUID</span></code> 可以设置文件的设置 UID 位，而 <code class="docutils literal"><span class="pre">S_ISUID</span> <span class="pre">|</span> <span class="pre">S_IRWXU</span></code> 则设置文件的设置 ID 位、以及拥有者的读写和执行权限，等等。</p>
<p>所有可被设置的权限及其作用如下表所示：</p>
<img alt="../../_images/4-12.png" src="../../_images/4-12.png" />
<p>以下程序在保留输入文件原有权限的前提下，为文件添加拥有者执行权限：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// 4-set-x-permission.c</span>

<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
   
    <span class="c1">// </span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;usage: ./a.out filepath</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// </span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">file</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;Get file info fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">chmod</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">S_IXUSR</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;Set owner execute permission fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal"><span class="pre">chmod</span></code> 修改权限的方式是“设置”而不是“添加”，
程序使用了 <code class="docutils literal"><span class="pre">stat.st_mode</span> <span class="pre">|</span> <span class="pre">new_permission</span></code> 的形式来增加新的权限。</p>
<p class="last">如果只将 <code class="docutils literal"><span class="pre">mode</span></code> 参数设置为 <code class="docutils literal"><span class="pre">new_permission</span></code> 的话，文件原来的权限就会被清除掉， 这一点要小心处理。</p>
</div>
<p>执行：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ls -l /tmp/ttt
-rw-rw-r-- 1 huangz huangz 0  1月 24 13:49 /tmp/ttt

$ ./a.out /tmp/ttt

$ ls -l /tmp/ttt
-rwxrw-r-- 1 huangz huangz 0  1月 24 13:49 /tmp/ttt
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h2>文件长度<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">stat</span></code> 结构的 <code class="docutils literal"><span class="pre">st_size</span></code> 属性以字节大小保存了普通文件或符号链接的大小。</p>
<p>其中符号链接的大小是它所指向的目标路径的长度（不带末尾的 <code class="docutils literal"><span class="pre">\0</span></code> ）。 以下是这方面的一个例子：</p>
<div class="highlight-c"><div class="highlight"><pre>lrwxrwxrwx  1 huangz huangz   12 12月  6 12:26 redis -&gt; code/c/redis
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">redis</span></code> 指向 <code class="docutils literal"><span class="pre">code/c/redis</span></code> 路径，路径的长度为 <code class="docutils literal"><span class="pre">12</span></code> 字节。</p>
<p>以下程序打印输入文件的大小：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// 4-print-size.c</span>

<span class="cp">#include &lt;stdio.h&gt;      </span><span class="c1">// perror, fprintf, printf</span>
<span class="cp">#include &lt;sys/stat.h&gt;   </span><span class="c1">// lstat, struct stat, S_ISREG, S_ISLNK</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;usage: ./a.out filepath</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">file</span><span class="p">;</span>

    <span class="c1">// use lstat() instead of stat()</span>
    <span class="c1">// not follow if filepath is a symbolic link</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lstat</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;Get file info fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span><span class="p">)</span> <span class="o">||</span> <span class="n">S_ISLNK</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s length = %lld bytes .</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">file</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
    <span class="k">else</span> 
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s is not regular file or symbolic link , length unknow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">);</span>
        
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>输入为普通文件：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ./a.out 4-print-type.c
4-print-type.c length = 951 bytes .

$ ls -l 4-print-type.c
-rw-rw-r-- 1 huangz huangz 951  1月 23 21:20 4-print-type.c
</pre></div>
</div>
<p>输入为符号链接：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ./a.out /home/huangz/redis
/home/huangz/redis length = 12 bytes .

$ ls -l /home/huangz/redis
lrwxrwxrwx 1 huangz huangz 12 12月  6 12:26 /home/huangz/redis -&gt; code/c/redis
</pre></div>
</div>
<p>输入为没有大小的块设备：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ./a.out /dev/sda
/dev/sda is not regular file or symbolic link , length unknow.
</pre></div>
</div>
<p>输入为不存在的文件：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ./a.out not-exists-file
Get file info fail: No such file or directory
</pre></div>
</div>
<p>程序使用了 <code class="docutils literal"><span class="pre">lstat</span></code> 函数而不是 <code class="docutils literal"><span class="pre">stat</span></code> 函数，在遇上符号链接时，它返回符号链接本身的大小，而不是符号链接所指向文件的大小。</p>
</div>
<div class="section" id="id12">
<h2>截断文件为指定大小<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
<p>使用 <code class="docutils literal"><span class="pre">truncate</span></code> 和 <code class="docutils literal"><span class="pre">ftruncate</span></code> 可以将一个文件的大小截断为给定的字节，
它们的唯一区别是前者接受文件路径名为输入，而后者接受文件描述符为输入：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>

<span class="kt">int</span> <span class="nf">truncate</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">length</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">ftruncate</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">length</span><span class="p">);</span>

<span class="c1">// 执行成功返回 0 ，出错返回 -1</span>
</pre></div>
</div>
<p>如果文件原本的大小比 <code class="docutils literal"><span class="pre">length</span></code> 要大，那么截断之后， <code class="docutils literal"><span class="pre">length</span></code> 字节后的数据不再存在。</p>
<p>如果文件原本的大小比 <code class="docutils literal"><span class="pre">length</span></code> 要小，那么截断之后，文件的长度被扩展为 <code class="docutils literal"><span class="pre">length</span></code> ，其中新分配的空间以 <code class="docutils literal"><span class="pre">\0</span></code> 填充。</p>
<p>两个函数都不会修改文件的当前偏移量。</p>
<p>当执行 <code class="docutils literal"><span class="pre">ftruncate()</span></code> 时，文件需要以写模式打开，而 <code class="docutils literal"><span class="pre">truncate()</span></code> 执行时，文件应该对进程是可写的。</p>
<p>以下程序可以接受两个参数，一个文件路径和一个长度，并将文件截断为给定的长度：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// 4-truncate.c</span>

<span class="cp">#include &lt;unistd.h&gt; </span><span class="c1">// truncate</span>
<span class="cp">#include &lt;stdio.h&gt;  </span><span class="c1">// stderr, fprintf, perror</span>
<span class="cp">#include &lt;stdlib.h&gt; </span><span class="c1">// atoll</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;usage: ./a.out filepath new_size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">new_size</span> <span class="o">=</span> <span class="n">atoll</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">truncate</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">new_size</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;Truncate fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>以下示例展示了如何将一个四百多字节的文件截断为一百字节：</p>
<div class="highlight-c"><div class="highlight"><pre>$ ls -l test-4-truncate
-rw-rw-r-- 1 huangz huangz 467  1月 24 19:51 test-4-truncate

$ ./a.out test-4-truncate 100

$ ls -l test-4-truncate
-rw-rw-r-- 1 huangz huangz 100  1月 24 19:51 test-4-truncate
</pre></div>
</div>
</div>
</div>



            <div class="section" id="discuss">

    <h2>
        留言
        <a class="headerlink" href="#discuss" title="永久链接至标题">¶</a>
    </h2>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'notehuangzme'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">第 4 章：文件和目录</a><ul>
<li><a class="reference internal" href="#id2">获取文件信息</a></li>
<li><a class="reference internal" href="#id3">获取文件信息所需的权限</a></li>
<li><a class="reference internal" href="#id4">文件信息</a></li>
<li><a class="reference internal" href="#id5">文件类型</a></li>
<li><a class="reference internal" href="#id6">另一种获取文件类型的方法</a></li>
<li><a class="reference internal" href="#id7">文件所有者</a></li>
<li><a class="reference internal" href="#id-id">修改所有者的用户 ID 和组 ID</a></li>
<li><a class="reference internal" href="#id8">文件的权限</a></li>
<li><a class="reference internal" href="#id9">特殊权限</a></li>
<li><a class="reference internal" href="#id10">设置权限</a></li>
<li><a class="reference internal" href="#id11">文件长度</a></li>
<li><a class="reference internal" href="#id12">截断文件为指定大小</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="chp3.html"
                        title="previous chapter">第 3 章：文件 I/O</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="chp8.html"
                        title="next chapter">第 8 章：进程控制</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
        &copy; Copyright 2014, huangz.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3b1.
    </div>
  </body>
</html>