<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>字符串对象 RString &mdash; huangz/note</title>
    
    <link rel="stylesheet" href="../../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'present',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="huangz/note" href="../../index.html" />
    <link rel="up" title="MRuby 源码分析" href="index.html" />
    <link rel="next" title="Redis 源码分析" href="../../storage/redis_code_analysis/index.html" />
    <link rel="prev" title="MRuby 源码分析" href="index.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->





</head>
<body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../storage/redis_code_analysis/index.html" title="Redis 源码分析"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="MRuby 源码分析"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">huangz/note</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">MRuby 源码分析</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="rstring">
<h1>字符串对象 RString<a class="headerlink" href="#rstring" title="Permalink to this headline">¶</a></h1>
<p>本文将对 <a class="reference external" href="http://www.mruby.org/">MRuby</a> 中的 <code class="docutils literal"><span class="pre">RString</span></code> 对象的相关代码进行分析，
并对 <code class="docutils literal"><span class="pre">RString</span></code> 对象的三种底层实现进行介绍，
它们分别是嵌入式字符串、不定长字符串和共享字符串。</p>
<div class="section" id="id1">
<h2><code class="docutils literal"><span class="pre">RString</span></code> 对象<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">RString</span></code> 结构是 MRuby 的字符串实现，
它的定义位于 <code class="docutils literal"><span class="pre">/include/mruby/string.h</span></code> ：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">struct</span> <span class="n">RString</span> <span class="p">{</span>

  <span class="c1">// 对象的文件头，记录了对象的类型、状态等信息</span>
  <span class="n">MRB_OBJECT_HEADER</span><span class="p">;</span>

  <span class="k">union</span> <span class="p">{</span>

    <span class="k">struct</span> <span class="p">{</span>

      <span class="c1">// 缓冲区中保存的字符串长度</span>
      <span class="n">mrb_int</span> <span class="n">len</span><span class="p">;</span>

      <span class="k">union</span> <span class="p">{</span>

        <span class="c1">// 缓冲区的大小</span>
        <span class="c1">// 刚创建字符串对象时 capa 和 len 相同，</span>
        <span class="c1">// 但之后如果对字符串对象进行 cat 等操作的话，</span>
        <span class="c1">// MRuby 就会在缓冲区里面预留额外的空间，</span>
        <span class="c1">// 用于减少执行内存分配的次数</span>
        <span class="n">mrb_int</span> <span class="n">capa</span><span class="p">;</span>

        <span class="c1">// 共享字符串（这是被多个对象所共享的部分）</span>
        <span class="k">struct</span> <span class="n">mrb_shared_string</span> <span class="o">*</span><span class="n">shared</span><span class="p">;</span>

      <span class="p">}</span> <span class="n">aux</span><span class="p">;</span>

      <span class="c1">// 字符串缓冲区</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

    <span class="p">}</span> <span class="n">heap</span><span class="p">;</span>

    <span class="c1">// 长度受限的嵌入式字符</span>
    <span class="kt">char</span> <span class="n">ary</span><span class="p">[</span><span class="n">RSTRING_EMBED_LEN_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

  <span class="p">}</span> <span class="n">as</span><span class="p">;</span>

<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>对象头<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">RString</span></code> 包含一个 <code class="docutils literal"><span class="pre">MRB_OBJECT_HEADER</span></code> 常量定义，
这个常量定义了每个对象共有的属性，
该常量的定义位于 <code class="docutils literal"><span class="pre">/include/mruby/value.h</span></code> ：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define MRB_OBJECT_HEADER \</span>
<span class="hll"><span class="cp">  enum mrb_vtype tt:8;\</span>
</span><span class="cp">  uint32_t color:3;\</span>
<span class="hll"><span class="cp">  uint32_t flags:21;\</span>
</span><span class="cp">  struct RClass *c;\</span>
<span class="cp">  struct RBasic *gcnext</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">MRB_OBJECT_HEADER</span></code> 常量里面定义的属性当中，
目前对我们需要知道的是 <code class="docutils literal"><span class="pre">tt</span></code> 属性和 <code class="docutils literal"><span class="pre">flags</span></code> 属性：</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">tt</span></code> 属性记录了对象的类型，它的值可以是 <code class="docutils literal"><span class="pre">/include/mruby/value.h/mrb_vtype</span></code> 枚举中列出的任意一个常量。对于字符串对象来说，它的 <code class="docutils literal"><span class="pre">tt</span></code> 属性的值为枚举中的 <code class="docutils literal"><span class="pre">MRB_TT_STRING</span></code> 常量：</p>
<div class="highlight-c"><div class="highlight"><pre> <span class="k">enum</span> <span class="n">mrb_vtype</span> <span class="p">{</span>
   <span class="n">MRB_TT_FALSE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>   <span class="cm">/*   1 */</span>
   <span class="n">MRB_TT_FREE</span><span class="p">,</span>        <span class="cm">/*   2 */</span>
   <span class="c1">// ...</span>
<span class="hll">   <span class="n">MRB_TT_STRING</span><span class="p">,</span>      <span class="cm">/*  17 */</span>
</span>   <span class="c1">// ...</span>
   <span class="n">MRB_TT_FIBER</span><span class="p">,</span>       <span class="cm">/*  23 */</span>
   <span class="n">MRB_TT_MAXDEFINE</span>    <span class="cm">/*  24 */</span>
 <span class="p">};</span>
</pre></div>
</div>
</li>
</ul>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">flags</span></code> 属性记录了对象的状态，以及对象的底层实现方式。对于字符串对象来说， <code class="docutils literal"><span class="pre">flags</span></code> 属性的值可以是 <code class="docutils literal"><span class="pre">/include/mruby/string.h</span></code> 里面的五个 <code class="docutils literal"><span class="pre">MRB_STR_*</span></code> 常量的其中一个：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// 共享字符串</span>
<span class="cp">#define MRB_STR_SHARED    1</span>
<span class="c1">// 非释放共享字符串</span>
<span class="cp">#define MRB_STR_NOFREE    2</span>
<span class="c1">// 嵌入字符串</span>
<span class="cp">#define MRB_STR_EMBED     4</span>
<span class="c1">// 嵌入字符串的长度计算掩码（mask）</span>
<span class="cp">#define MRB_STR_EMBED_LEN_MASK 0xf8</span>
<span class="c1">// 嵌入字符串的长度计算偏移位</span>
<span class="cp">#define MRB_STR_EMBED_LEN_SHIFT 3</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id3">
<h2>长度受限的嵌入式字符串<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>除了 <code class="docutils literal"><span class="pre">MRB_OBJECT_HEADER</span></code> 常量定义的属性之外，
<code class="docutils literal"><span class="pre">RString</span></code> 结构的定义只包含一个 <code class="docutils literal"><span class="pre">as</span></code> 联合，
这个联合分别包含一个 <code class="docutils literal"><span class="pre">heap</span></code> 结构和一个 <code class="docutils literal"><span class="pre">ary</span></code> 字符数组：</p>
<div class="highlight-c"><div class="highlight"><pre> <span class="k">struct</span> <span class="n">RString</span> <span class="p">{</span>

   <span class="c1">// ...</span>

   <span class="k">union</span> <span class="p">{</span>

     <span class="k">struct</span> <span class="p">{</span>

         <span class="c1">// ...</span>

     <span class="p">}</span> <span class="n">heap</span><span class="p">;</span>

<span class="hll">     <span class="c1">// 长度受限的嵌入式字符串</span>
</span><span class="hll">     <span class="kt">char</span> <span class="n">ary</span><span class="p">[</span><span class="n">RSTRING_EMBED_LEN_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class="hll">
</span>   <span class="p">}</span> <span class="n">as</span><span class="p">;</span>

 <span class="p">};</span>
</pre></div>
</div>
<p>其中 <code class="docutils literal"><span class="pre">ary</span></code> 数组的长度是受限的，
MRuby 会根据机器的位长度来决定这个数组的最大长度：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// 嵌入字符串的最大长度，实际长度为三个指针的长度减去一个字节：</span>
<span class="c1">// 以 64 位机器为例， 8 bytes * 3 - 1 byte = 23 bytes 。</span>
<span class="c1">// 以 32 位机器为例， 4 bytes * 3 - 1 byte = 11 bytes 。</span>
<span class="cp">#define RSTRING_EMBED_LEN_MAX ((mrb_int)(sizeof(void*) * 3 - 1))</span>
</pre></div>
</div>
<p>对性能敏感的读者可能会对 <code class="docutils literal"><span class="pre">ary</span></code> 数组感到担心：
因为 <code class="docutils literal"><span class="pre">as</span></code> 联合里面并没有一个属性来记录 <code class="docutils literal"><span class="pre">ary</span></code> 数组的长度，
那么在使用 <code class="docutils literal"><span class="pre">ary</span></code> 数组时，
程序是否需要对 <code class="docutils literal"><span class="pre">ary</span></code> 数组进行 O(N) 复杂度的遍历来计算 <code class="docutils literal"><span class="pre">ary</span></code> 数组的长度呢？</p>
<p>答案是不必的，
因为 MRuby 已经帮我们解决了这个问题 ——
当 <code class="docutils literal"><span class="pre">RString</span></code> 使用 <code class="docutils literal"><span class="pre">ary</span></code> 数组时，
<code class="docutils literal"><span class="pre">RString</span></code> 会将字符串的长度通过二进制位操作记录到 <code class="docutils literal"><span class="pre">flags</span></code> 标识里面，
所以获取 <code class="docutils literal"><span class="pre">ary</span></code> 数组的长度的复杂度仍然为 O(1) 。</p>
<p><code class="docutils literal"><span class="pre">string.c</span></code> 里面的 <code class="docutils literal"><span class="pre">STR_SET_EMBED_LEN</span></code> 宏清楚地定义了对 <code class="docutils literal"><span class="pre">ary</span></code> 数组的长度设置操作：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define MRB_STR_EMBED_LEN_MASK 0xf8</span>
<span class="cp">#define MRB_STR_EMBED_LEN_SHIFT 3</span>

<span class="cp">#define STR_SET_EMBED_LEN(s, n) do {\</span>
<span class="cp">  size_t tmp_n = (n);\</span>
<span class="cp">  s-&gt;flags &amp;= ~MRB_STR_EMBED_LEN_MASK;\</span>
<span class="cp">  s-&gt;flags |= (tmp_n) &lt;&lt; MRB_STR_EMBED_LEN_SHIFT;\</span>
<span class="cp">} while (0)</span>
</pre></div>
</div>
<p>作为例子，
下图展示了一个长度为 <code class="docutils literal"><span class="pre">11</span></code> 字节，
保存了字符串 <code class="docutils literal"><span class="pre">&quot;hello</span> <span class="pre">world&quot;</span></code> 的嵌入字符串：</p>
<p class="graphviz">
<img src="../../_images/graphviz-934168bf4da432e361ff2982fb74a2e99760853d.png" alt="digraph {

    rankdir = LR;

    //

    node [shape = record]

    RString [label = &quot; &lt;head&gt; RString | ... | &lt;ary&gt; as.ary &quot;];

    buffer [label = &quot; { &lt;0&gt; 'h' | 'e' | 'l' | 'l' | &lt;4&gt; 'o' | ' ' | 'w' | 'o' | 'r' | 'l' | &lt;10&gt; 'd' | '\\0' } &quot;];

    //

    RString:ary -&gt; buffer;

}" />
</p>
</div>
<div class="section" id="id4">
<h2>不定长字符串<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">ary</span></code> 的性质确定了它只能用来保存一些比较短的字符串，
而当 MRuby 需要保存一些比较长的字符串时，
它就会使用 <code class="docutils literal"><span class="pre">as</span></code> 联合的 <code class="docutils literal"><span class="pre">heap</span></code> 结构，
该结构和常见的字符串实现非常相似：</p>
<div class="highlight-c"><div class="highlight"><pre> <span class="k">struct</span> <span class="n">RString</span> <span class="p">{</span>

   <span class="c1">// ...</span>

   <span class="k">union</span> <span class="p">{</span>

<span class="hll">     <span class="k">struct</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">       <span class="c1">// 缓冲区中保存的字符串长度</span>
</span><span class="hll">       <span class="n">mrb_int</span> <span class="n">len</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">       <span class="k">union</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">         <span class="c1">// 缓冲区的大小</span>
</span><span class="hll">         <span class="c1">// 刚创建字符串对象时 capa 和 len 相同，</span>
</span><span class="hll">         <span class="c1">// 但之后如果对字符串对象进行 cat 等操作的话，</span>
</span><span class="hll">         <span class="c1">// MRuby 就会在缓冲区里面预留额外的空间，</span>
</span><span class="hll">         <span class="c1">// 用于减少执行内存分配的次数</span>
</span><span class="hll">         <span class="n">mrb_int</span> <span class="n">capa</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">         <span class="c1">// 共享字符串（这是被多个对象所共享的部分）</span>
</span><span class="hll">         <span class="k">struct</span> <span class="n">mrb_shared_string</span> <span class="o">*</span><span class="n">shared</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">       <span class="p">}</span> <span class="n">aux</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">       <span class="c1">// 字符串缓冲区</span>
</span><span class="hll">       <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">     <span class="p">}</span> <span class="n">heap</span><span class="p">;</span>
</span><span class="hll">
</span>     <span class="c1">// ...</span>

   <span class="p">}</span> <span class="n">as</span><span class="p">;</span>

 <span class="p">};</span>
</pre></div>
</div>
<p>了解不定长字符串的一个不错的办法是阅读 <code class="docutils literal"><span class="pre">string.c/str_new</span></code> 函数的定义，
这个函数接受一个长度为 <code class="docutils literal"><span class="pre">len</span></code> 的字符串 <code class="docutils literal"><span class="pre">p</span></code> ，
并创建一个包含相同字符串内容的字符串对象：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">RString</span><span class="o">*</span>
<span class="nf">str_new</span><span class="p">(</span><span class="n">mrb_state</span> <span class="o">*</span><span class="n">mrb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">RString</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

  <span class="c1">// 为新的字符串对象分配内存</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">mrb_obj_alloc_string</span><span class="p">(</span><span class="n">mrb</span><span class="p">);</span>

  <span class="c1">// 如果输入字符串的长度小于 RSTRING_EMBED_LEN_MAX</span>
  <span class="c1">// 那么创建一个嵌入字符串，否则的话就创建一个不定长字符串</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">RSTRING_EMBED_LEN_MAX</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 创建嵌入字符串</span>

    <span class="n">STR_SET_EMBED_FLAG</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">STR_SET_EMBED_LEN</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">.</span><span class="n">ary</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

    <span class="c1">// 创建不定长字符串</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">MRB_INT_MAX</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mrb_raise</span><span class="p">(</span><span class="n">mrb</span><span class="p">,</span> <span class="n">E_ARGUMENT_ERROR</span><span class="p">,</span> <span class="s">&quot;string size too big&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">s</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
    <span class="n">s</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">capa</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
    <span class="n">s</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mrb_malloc</span><span class="p">(</span><span class="n">mrb</span><span class="p">,</span> <span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 在字符串的末尾添加空字符</span>
  <span class="n">STR_PTR</span><span class="p">(</span><span class="n">s</span><span class="p">)[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

  <span class="c1">// 返回新创建的字符串对象</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如代码所示，
<code class="docutils literal"><span class="pre">str_new</span></code> 函数会根据 <code class="docutils literal"><span class="pre">len</span></code> 的大小来判断应该创建嵌入字符串还是不定长字符串。</p>
<p>下图展示了一个不定长字符串对象示例：</p>
<p class="graphviz">
<img src="../../_images/graphviz-e74c19922334fa27d3eb5721b4873c9157dfae69.png" alt="digraph {

    rankdir = LR;

    node [shape = record]

    RString [label = &quot; &lt;head&gt; RString | ... | as.heap.len \n 100 | as.heap.aux.capa \n 100 | &lt;ptr&gt; as.heap.ptr &quot;];

    buffer [label = &quot; { 'l' | 'o' | 'n' | 'g' | ' ' | 't' | 'e' | 'x' | 't' | ... | '\\0' } &quot;];

    //

    RString:ptr -&gt; buffer;
}" />
</p>
</div>
<div class="section" id="id5">
<h2>共享字符串<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>假设现在有一个字符串对象 <code class="docutils literal"><span class="pre">orig</span></code> ：</p>
<div class="highlight-Ruby"><div class="highlight"><pre><span class="n">mirb</span> <span class="o">-</span> <span class="no">Embeddable</span> <span class="no">Interactive</span> <span class="no">Ruby</span> <span class="no">Shell</span>

<span class="o">&gt;</span> <span class="n">orig</span> <span class="o">=</span> <span class="s2">&quot;hello world&quot;</span>
<span class="o">=&gt;</span> <span class="s2">&quot;hello world&quot;</span>
</pre></div>
</div>
<p>这个字符串对象指向一个包含 <code class="docutils literal"><span class="pre">11</span></code> 个字符的缓冲区，
如下图所示（结尾的空字符不计算在字符串长度之内，下同）：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">orig</span> <span class="o">--&gt;</span> <span class="o">|</span> <span class="sc">&#39;h&#39;</span> <span class="o">|</span> <span class="sc">&#39;e&#39;</span> <span class="o">|</span> <span class="sc">&#39;l&#39;</span> <span class="o">|</span> <span class="sc">&#39;l&#39;</span> <span class="o">|</span> <span class="sc">&#39;o&#39;</span> <span class="o">|</span> <span class="sc">&#39; &#39;</span> <span class="o">|</span> <span class="sc">&#39;w&#39;</span> <span class="o">|</span> <span class="sc">&#39;o&#39;</span> <span class="o">|</span> <span class="sc">&#39;r&#39;</span> <span class="o">|</span> <span class="sc">&#39;l&#39;</span> <span class="o">|</span> <span class="sc">&#39;d&#39;</span> <span class="o">|</span> <span class="sc">&#39;\0&#39;</span> <span class="o">|</span>
</pre></div>
</div>
<p>如果这时用户对 <code class="docutils literal"><span class="pre">orig</span></code> 执行以下操作：</p>
<div class="highlight-Ruby"><div class="highlight"><pre><span class="o">&gt;</span> <span class="n">after</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">&quot;hello&quot;</span>

<span class="o">&gt;</span> <span class="n">after</span>
<span class="o">=&gt;</span> <span class="s2">&quot;hello&quot;</span>
</pre></div>
</div>
<p>那么实现这个 <code class="docutils literal"><span class="pre">slice</span></code> 操作的方法可能是这样的：</p>
<ol class="arabic simple">
<li>为 <code class="docutils literal"><span class="pre">after</span></code> 新创建一个字符串对象，
并为这个字符串对象分配缓冲区；</li>
<li>将 <code class="docutils literal"><span class="pre">orig</span></code> 对象的缓冲区里面，
索引从 <code class="docutils literal"><span class="pre">0</span></code> 到 <code class="docutils literal"><span class="pre">5</span></code> 为止的内容 <code class="docutils literal"><span class="pre">&quot;hello&quot;</span></code> 复制到 <code class="docutils literal"><span class="pre">after</span></code> 对象的缓冲区里面；</li>
</ol>
<p><code class="docutils literal"><span class="pre">slice</span></code> 操作执行之后的两个对象如下图所示：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">orig</span>   <span class="o">--&gt;</span> <span class="o">|</span> <span class="sc">&#39;h&#39;</span> <span class="o">|</span> <span class="sc">&#39;e&#39;</span> <span class="o">|</span> <span class="sc">&#39;l&#39;</span> <span class="o">|</span> <span class="sc">&#39;l&#39;</span> <span class="o">|</span> <span class="sc">&#39;o&#39;</span> <span class="o">|</span> <span class="sc">&#39; &#39;</span> <span class="o">|</span> <span class="sc">&#39;w&#39;</span> <span class="o">|</span> <span class="sc">&#39;o&#39;</span> <span class="o">|</span> <span class="sc">&#39;r&#39;</span> <span class="o">|</span> <span class="sc">&#39;l&#39;</span> <span class="o">|</span> <span class="sc">&#39;d&#39;</span> <span class="o">|</span> <span class="sc">&#39;\0&#39;</span> <span class="o">|</span>

<span class="n">after</span>  <span class="o">--&gt;</span> <span class="o">|</span> <span class="sc">&#39;h&#39;</span> <span class="o">|</span> <span class="sc">&#39;e&#39;</span> <span class="o">|</span> <span class="sc">&#39;l&#39;</span> <span class="o">|</span> <span class="sc">&#39;l&#39;</span> <span class="o">|</span> <span class="sc">&#39;o&#39;</span> <span class="o">|</span> <span class="sc">&#39;\0&#39;</span> <span class="o">|</span>
</pre></div>
</div>
<p>上面给出的 <code class="docutils literal"><span class="pre">slice</span></code> 实现是可行的，
但并不是最优化的：</p>
<ul class="simple">
<li>因为 <code class="docutils literal"><span class="pre">after</span></code> 保存的字符串只是 <code class="docutils literal"><span class="pre">orig</span></code> 保存的字符串的一个子集，
所以 <code class="docutils literal"><span class="pre">slice</span></code> 实际上可以将 <code class="docutils literal"><span class="pre">orig</span></code> 的缓冲区共享给 <code class="docutils literal"><span class="pre">after</span></code> 使用，
然后让 <code class="docutils literal"><span class="pre">orig</span></code> 和 <code class="docutils literal"><span class="pre">after</span></code> 分别使用缓冲区的不同部分就可以了；</li>
<li>共享缓冲区的做法可以避免为了创建 <code class="docutils literal"><span class="pre">after</span></code> 的缓冲区而执行内存分配操作，
并且 <code class="docutils literal"><span class="pre">after</span></code> 对象也无须再从 <code class="docutils literal"><span class="pre">orig</span></code> 对象那里复制 <code class="docutils literal"><span class="pre">&quot;hello&quot;</span></code> 字符串了。</li>
</ul>
<p>使用新方法实现的 <code class="docutils literal"><span class="pre">slice</span></code> 操作所创建的 <code class="docutils literal"><span class="pre">orig</span></code> 对象和 <code class="docutils literal"><span class="pre">after</span></code> 对象如下图所示：</p>
<div class="highlight-c"><div class="highlight"><pre>            <span class="n">orig</span>
              <span class="o">+-----------------------------------------------------------+</span>
              <span class="o">|</span>                                                           <span class="o">|</span>
              <span class="o">|</span>                                                           <span class="o">|</span>
              <span class="o">|</span> <span class="n">start</span>                                                 <span class="n">end</span> <span class="o">|</span>
              <span class="n">v</span>                                                           <span class="n">v</span>
<span class="n">shared</span>
<span class="n">buffer</span> <span class="o">--&gt;</span> <span class="o">|</span> <span class="sc">&#39;h&#39;</span> <span class="o">|</span> <span class="sc">&#39;e&#39;</span> <span class="o">|</span> <span class="sc">&#39;l&#39;</span> <span class="o">|</span> <span class="sc">&#39;l&#39;</span> <span class="o">|</span> <span class="sc">&#39;o&#39;</span> <span class="o">|</span> <span class="sc">&#39; &#39;</span> <span class="o">|</span> <span class="sc">&#39;w&#39;</span> <span class="o">|</span> <span class="sc">&#39;o&#39;</span> <span class="o">|</span> <span class="sc">&#39;r&#39;</span> <span class="o">|</span> <span class="sc">&#39;l&#39;</span> <span class="o">|</span> <span class="sc">&#39;d&#39;</span> <span class="o">|</span> <span class="sc">&#39;\0&#39;</span> <span class="o">|</span>

              <span class="o">^</span>                       <span class="o">^</span>
              <span class="o">|</span> <span class="n">start</span>                 <span class="o">|</span> <span class="n">end</span>
              <span class="o">|</span>                       <span class="o">|</span>
              <span class="o">|</span>                       <span class="o">|</span>
              <span class="o">+-----------------------+</span>
            <span class="n">after</span>
</pre></div>
</div>
<p>共享字符串就是 MRuby 为了优化类似 <code class="docutils literal"><span class="pre">slice</span></code> 这样的操作而设置的，
这种数据结构的实现原理和上面共享缓冲区一样，
只是细节上面更具体了。</p>
<p>使用共享字符串需要用到 <code class="docutils literal"><span class="pre">RString</span></code> 对象中的 <code class="docutils literal"><span class="pre">shared</span></code> 属性：
共享字符串的实现和性
实现共享字符串的关键是 <code class="docutils literal"><span class="pre">RString</span></code> 对象中的 <code class="docutils literal"><span class="pre">shared</span></code> 属性，
它和上面所说的“缓冲区”一样，会被多个字符串对象所共享：</p>
<div class="highlight-c"><div class="highlight"><pre> <span class="k">struct</span> <span class="n">RString</span> <span class="p">{</span>

   <span class="c1">// ...</span>

   <span class="k">union</span> <span class="p">{</span>

     <span class="k">struct</span> <span class="p">{</span>

       <span class="c1">// ...</span>

       <span class="k">union</span> <span class="p">{</span>

         <span class="c1">// ...</span>

<span class="hll">         <span class="c1">// 共享字符串（这是被多个对象所共享的部分）</span>
</span><span class="hll">         <span class="k">struct</span> <span class="n">mrb_shared_string</span> <span class="o">*</span><span class="n">shared</span><span class="p">;</span>
</span>
       <span class="p">}</span> <span class="n">aux</span><span class="p">;</span>

       <span class="c1">// ...</span>

     <span class="p">}</span> <span class="n">heap</span><span class="p">;</span>

     <span class="c1">// ...</span>

   <span class="p">}</span> <span class="n">as</span><span class="p">;</span>

 <span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">mrb_shared_string</span></code> 结构的定义位于 <code class="docutils literal"><span class="pre">string.c</span></code> ：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">mrb_shared_string</span> <span class="p">{</span>

  <span class="c1">// 在引用计数为 0 时，是否释放 ptr 指针所指向的内容</span>
  <span class="c1">// 值为 1 时不释放， 0 时释放</span>
  <span class="n">mrb_bool</span> <span class="nl">nofree</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>

  <span class="c1">// 共享字符串的引用计数器</span>
  <span class="kt">int</span> <span class="n">refcnt</span><span class="p">;</span>

  <span class="c1">// 缓冲区，保存着共享字符串的内容</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

  <span class="c1">// 内容的长度</span>
  <span class="n">mrb_int</span> <span class="n">len</span><span class="p">;</span>

<span class="p">}</span> <span class="n">mrb_shared_string</span><span class="p">;</span>
</pre></div>
</div>
<p>作为例子，
下图展示了在 MRuby 中，
<code class="docutils literal"><span class="pre">before</span></code> 对象和 <code class="docutils literal"><span class="pre">after</span></code> 对象共享同一个 <code class="docutils literal"><span class="pre">mrb_shared_string</span></code> 结构的样子：</p>
<p class="graphviz">
<img src="../../_images/graphviz-b2c6b3ffcfcd251e9f6706b0cc0b9e86d66a0017.png" alt="digraph {

    rankdir = LR;

    node [shape = plaintext]

    before;
    after;

    node [shape = record]

    before_RString [label = &quot; &lt;head&gt; RString | ... | as.heap.len \n 11 | &lt;shared&gt; as.heap.aux.shared  | &lt;ptr&gt; as.heap.ptr &quot;];

    after_RString [label = &quot; &lt;head&gt; RString | ... | as.heap.len \n 5 | &lt;shared&gt; as.heap.aux.shared  | &lt;ptr&gt; as.heap.ptr &quot;];

    mrb_shared_string [label = &quot; &lt;head&gt; mrb_shared_string | ... | refcnt \n 2 | &lt;ptr&gt; ptr | len \n 11 &quot;];

    buffer [label = &quot; { &lt;0&gt; 'h' | 'e' | 'l' | 'l' | &lt;4&gt; 'o' | ' ' | 'w' | 'o' | 'r' | 'l' | &lt;10&gt; 'd' | '\\0' } &quot;];

    //

    before -&gt; before_RString:head;
    after -&gt; after_RString:head;

    before_RString:shared -&gt; mrb_shared_string:head;
    after_RString:shared -&gt; mrb_shared_string:head;

    mrb_shared_string:ptr -&gt; buffer:0;

    before_RString:ptr -&gt; buffer:0;
    after_RString:ptr -&gt; buffer:0;

}" />
</p>
<p>在这个图里面：</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">before</span></code> 对象的 <code class="docutils literal"><span class="pre">RString.ptr</span></code> 指向缓冲区的索引 <code class="docutils literal"><span class="pre">0</span></code> ，
而 <code class="docutils literal"><span class="pre">RString.len</span></code> 的值为 <code class="docutils literal"><span class="pre">11</span></code> ，
这表示程序只要从 <code class="docutils literal"><span class="pre">RString.ptr</span></code> 所指示的索引开始，
读入 <code class="docutils literal"><span class="pre">11</span></code> 个字符，
就得到了 <code class="docutils literal"><span class="pre">before</span></code> 对象的值 <code class="docutils literal"><span class="pre">&quot;hello</span> <span class="pre">world&quot;</span></code> ；</li>
<li>与此类似，
<code class="docutils literal"><span class="pre">after</span></code> 对象的 <code class="docutils literal"><span class="pre">RString.ptr</span></code> 也指向缓冲区的索引 <code class="docutils literal"><span class="pre">0</span></code> ，
但它的 <code class="docutils literal"><span class="pre">RString.len</span></code> 的值为 <code class="docutils literal"><span class="pre">5</span></code> ，
这表示程序只要从 <code class="docutils literal"><span class="pre">RString.ptr</span></code> 所指示的索引开始，
读入 <code class="docutils literal"><span class="pre">5</span></code> 个字符，
就得到了 <code class="docutils literal"><span class="pre">after</span></code> 对象的值 <code class="docutils literal"><span class="pre">&quot;hello&quot;</span></code> ；</li>
<li>另外，
<code class="docutils literal"><span class="pre">mrb_shared_string.refcnt</span></code> 的值为 <code class="docutils literal"><span class="pre">2</span></code> ，
表示这个 <code class="docutils literal"><span class="pre">mrb_shared_string</span></code> 结构正在被两个对象所共享。</li>
</ul>
<p>真是相当聪明的做法！</p>
</div>
<div class="section" id="id6">
<h2>结语<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>好的，
以上就是本文的全部内容了，
谢谢观看！</p>
<div class="line-block">
<div class="line">huangz</div>
<div class="line">2014.5.10</div>
</div>
</div>
</div>



            <div class="section" id="discuss">

    <h2>
        留言
        <a class="headerlink" href="#discuss" title="永久链接至标题">¶</a>
    </h2>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'notehuangzme'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">字符串对象 RString</a><ul>
<li><a class="reference internal" href="#id1"><code class="docutils literal"><span class="pre">RString</span></code> 对象</a></li>
<li><a class="reference internal" href="#id2">对象头</a></li>
<li><a class="reference internal" href="#id3">长度受限的嵌入式字符串</a></li>
<li><a class="reference internal" href="#id4">不定长字符串</a></li>
<li><a class="reference internal" href="#id5">共享字符串</a></li>
<li><a class="reference internal" href="#id6">结语</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">MRuby 源码分析</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../../storage/redis_code_analysis/index.html"
                        title="next chapter">Redis 源码分析</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
        &copy; Copyright 2014, huangz.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3b1.
    </div>
  </body>
</html>